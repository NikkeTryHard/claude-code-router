diff --git a/node_modules/@musistudio/llms/dist/cjs/server.cjs b/node_modules/@musistudio/llms/dist/cjs/server.cjs
index 297d241..624c5e1 100644
--- a/node_modules/@musistudio/llms/dist/cjs/server.cjs
+++ b/node_modules/@musistudio/llms/dist/cjs/server.cjs
@@ -64,7 +64,7 @@ https://cloud.google.com/docs/authentication/getting-started`,NO_CREDENTIALS_FOU
 To learn more about authentication and Google APIs, visit: 
 https://cloud.google.com/docs/authentication/getting-started`,NO_ADC_FOUND:"Could not load the default credentials. Browse to https://cloud.google.com/docs/authentication/getting-started for more information.",NO_UNIVERSE_DOMAIN_FOUND:`Unable to detect a Universe Domain in the current environment.
 To learn more about Universe Domain retrieval, visit: 
-https://cloud.google.com/compute/docs/metadata/predefined-metadata-keys`};var ll=class{checkIsGCE=void 0;useJWTAccessWithScope;defaultServicePath;get isGCE(){return this.checkIsGCE}_findProjectIdPromise;_cachedProjectId;jsonContent=null;apiKey;cachedCredential=null;#e=null;defaultScopes;keyFilename;scopes;clientOptions={};constructor(e={}){if(this._cachedProjectId=e.projectId||null,this.cachedCredential=e.authClient||null,this.keyFilename=e.keyFilename||e.keyFile,this.scopes=e.scopes,this.clientOptions=e.clientOptions||{},this.jsonContent=e.credentials||null,this.apiKey=e.apiKey||this.clientOptions.apiKey||null,this.apiKey&&(this.jsonContent||this.clientOptions.credentials))throw new RangeError(Wt.GoogleAuthExceptionMessages.API_KEY_WITH_CREDENTIALS);e.universeDomain&&(this.clientOptions.universeDomain=e.universeDomain)}setGapicJWTValues(e){e.defaultServicePath=this.defaultServicePath,e.useJWTAccessWithScope=this.useJWTAccessWithScope,e.defaultScopes=this.defaultScopes}getProjectId(e){if(e)this.getProjectIdAsync().then(t=>e(null,t),e);else return this.getProjectIdAsync()}async getProjectIdOptional(){try{return await this.getProjectId()}catch(e){if(e instanceof Error&&e.message===Wt.GoogleAuthExceptionMessages.NO_PROJECT_ID_FOUND)return null;throw e}}async findAndCacheProjectId(){let e=null;if(e||=await this.getProductionProjectId(),e||=await this.getFileProjectId(),e||=await this.getDefaultServiceProjectId(),e||=await this.getGCEProjectId(),e||=await this.getExternalAccountClientProjectId(),e)return this._cachedProjectId=e,e;throw new Error(Wt.GoogleAuthExceptionMessages.NO_PROJECT_ID_FOUND)}async getProjectIdAsync(){return this._cachedProjectId?this._cachedProjectId:(this._findProjectIdPromise||(this._findProjectIdPromise=this.findAndCacheProjectId()),this._findProjectIdPromise)}async getUniverseDomainFromMetadataServer(){let e;try{e=await js.universe("universe-domain"),e||=cl.DEFAULT_UNIVERSE}catch(t){if(t&&t?.response?.status===404)e=cl.DEFAULT_UNIVERSE;else throw t}return e}async getUniverseDomain(){let e=(0,Qm.originalOrCamelOptions)(this.clientOptions).get("universe_domain");try{e??=(await this.getClient()).universeDomain}catch{e??=cl.DEFAULT_UNIVERSE}return e}getAnyScopes(){return this.scopes||this.defaultScopes}getApplicationDefault(e={},t){let n;if(typeof e=="function"?t=e:n=e,t)this.getApplicationDefaultAsync(n).then(o=>t(null,o.credential,o.projectId),t);else return this.getApplicationDefaultAsync(n)}async getApplicationDefaultAsync(e={}){if(this.cachedCredential)return await this.#t(this.cachedCredential,null);let t;if(t=await this._tryGetApplicationCredentialsFromEnvironmentVariable(e),t)return t instanceof Vn.JWT?t.scopes=this.scopes:t instanceof qs.BaseExternalAccountClient&&(t.scopes=this.getAnyScopes()),await this.#t(t);if(t=await this._tryGetApplicationCredentialsFromWellKnownFile(e),t)return t instanceof Vn.JWT?t.scopes=this.scopes:t instanceof qs.BaseExternalAccountClient&&(t.scopes=this.getAnyScopes()),await this.#t(t);if(await this._checkIsGCE())return e.scopes=this.getAnyScopes(),await this.#t(new bw.Compute(e));throw new Error(Wt.GoogleAuthExceptionMessages.NO_ADC_FOUND)}async#t(e,t=process.env.GOOGLE_CLOUD_QUOTA_PROJECT||null){let n=await this.getProjectIdOptional();return t&&(e.quotaProjectId=t),this.cachedCredential=e,{credential:e,projectId:n}}async _checkIsGCE(){return this.checkIsGCE===void 0&&(this.checkIsGCE=js.getGCPResidency()||await js.isAvailable()),this.checkIsGCE}async _tryGetApplicationCredentialsFromEnvironmentVariable(e){let t=process.env.GOOGLE_APPLICATION_CREDENTIALS||process.env.google_application_credentials;if(!t||t.length===0)return null;try{return this._getApplicationCredentialsFromFilePath(t,e)}catch(n){throw n instanceof Error&&(n.message=`Unable to read the credential file specified by the GOOGLE_APPLICATION_CREDENTIALS environment variable: ${n.message}`),n}}async _tryGetApplicationCredentialsFromWellKnownFile(e){let t=null;if(this._isWindows())t=process.env.APPDATA;else{let o=process.env.HOME;o&&(t=ul.join(o,".config"))}return t&&(t=ul.join(t,"gcloud","application_default_credentials.json"),Ns.existsSync(t)||(t=null)),t?await this._getApplicationCredentialsFromFilePath(t,e):null}async _getApplicationCredentialsFromFilePath(e,t={}){if(!e||e.length===0)throw new Error("The file path is invalid.");try{if(e=Ns.realpathSync(e),!Ns.lstatSync(e).isFile())throw new Error}catch(o){throw o instanceof Error&&(o.message=`The file at ${e} does not exist, or it is not a file. ${o.message}`),o}let n=Ns.createReadStream(e);return this.fromStream(n,t)}fromImpersonatedJSON(e){if(!e)throw new Error("Must pass in a JSON object containing an  impersonated refresh token");if(e.type!==Kn.IMPERSONATED_ACCOUNT_TYPE)throw new Error(`The incoming JSON object does not have the "${Kn.IMPERSONATED_ACCOUNT_TYPE}" type`);if(!e.source_credentials)throw new Error("The incoming JSON object does not contain a source_credentials field");if(!e.service_account_impersonation_url)throw new Error("The incoming JSON object does not contain a service_account_impersonation_url field");let t=this.fromJSON(e.source_credentials);if(e.service_account_impersonation_url?.length>256)throw new RangeError(`Target principal is too long: ${e.service_account_impersonation_url}`);let n=/(?<target>[^/]+):(generateAccessToken|generateIdToken)$/.exec(e.service_account_impersonation_url)?.groups?.target;if(!n)throw new RangeError(`Cannot extract target principal from ${e.service_account_impersonation_url}`);let o=this.getAnyScopes()??[];return new Kn.Impersonated({...e,sourceClient:t,targetPrincipal:n,targetScopes:Array.isArray(o)?o:[o]})}fromJSON(e,t={}){let n,o=(0,Qm.originalOrCamelOptions)(t).get("universe_domain");return e.type===Ym.USER_REFRESH_ACCOUNT_TYPE?(n=new Ym.UserRefreshClient(t),n.fromJSON(e)):e.type===Kn.IMPERSONATED_ACCOUNT_TYPE?n=this.fromImpersonatedJSON(e):e.type===qs.EXTERNAL_ACCOUNT_TYPE?(n=Aw.ExternalAccountClient.fromJSON({...e,...t}),n.scopes=this.getAnyScopes()):e.type===Xm.EXTERNAL_ACCOUNT_AUTHORIZED_USER_TYPE?n=new Xm.ExternalAccountAuthorizedUserClient({...e,...t}):(t.scopes=this.scopes,n=new Vn.JWT(t),this.setGapicJWTValues(n),n.fromJSON(e)),o&&(n.universeDomain=o),n}_cacheClientFromJSON(e,t){let n=this.fromJSON(e,t);return this.jsonContent=e,this.cachedCredential=n,n}fromStream(e,t={},n){let o={};if(typeof t=="function"?n=t:o=t,n)this.fromStreamAsync(e,o).then(i=>n(null,i),n);else return this.fromStreamAsync(e,o)}fromStreamAsync(e,t){return new Promise((n,o)=>{if(!e)throw new Error("Must pass in a stream containing the Google auth settings.");let i=[];e.setEncoding("utf8").on("error",o).on("data",u=>i.push(u)).on("end",()=>{try{try{let u=JSON.parse(i.join("")),f=this._cacheClientFromJSON(u,t);return n(f)}catch(u){if(!this.keyFilename)throw u;let f=new Vn.JWT({...this.clientOptions,keyFile:this.keyFilename});return this.cachedCredential=f,this.setGapicJWTValues(f),n(f)}}catch(u){return o(u)}})})}fromAPIKey(e,t={}){return new Vn.JWT({...t,apiKey:e})}_isWindows(){let e=_w.platform();return!!(e&&e.length>=3&&e.substring(0,3).toLowerCase()==="win")}async getDefaultServiceProjectId(){return new Promise(e=>{(0,gw.exec)("gcloud config config-helper --format json",(t,n)=>{if(!t&&n)try{let o=JSON.parse(n).configuration.properties.core.project;e(o);return}catch{}e(null)})})}getProductionProjectId(){return process.env.GCLOUD_PROJECT||process.env.GOOGLE_CLOUD_PROJECT||process.env.gcloud_project||process.env.google_cloud_project}async getFileProjectId(){if(this.cachedCredential)return this.cachedCredential.projectId;if(this.keyFilename){let t=await this.getClient();if(t&&t.projectId)return t.projectId}let e=await this._tryGetApplicationCredentialsFromEnvironmentVariable();return e?e.projectId:null}async getExternalAccountClientProjectId(){return!this.jsonContent||this.jsonContent.type!==qs.EXTERNAL_ACCOUNT_TYPE?null:await(await this.getClient()).getProjectId()}async getGCEProjectId(){try{return await js.project("project-id")}catch{return null}}getCredentials(e){if(e)this.getCredentialsAsync().then(t=>e(null,t),e);else return this.getCredentialsAsync()}async getCredentialsAsync(){let e=await this.getClient();if(e instanceof Kn.Impersonated)return{client_email:e.getTargetPrincipal()};if(e instanceof qs.BaseExternalAccountClient){let t=e.getServiceAccountEmail();if(t)return{client_email:t,universe_domain:e.universeDomain}}if(this.jsonContent)return{client_email:this.jsonContent.client_email,private_key:this.jsonContent.private_key,universe_domain:this.jsonContent.universe_domain};if(await this._checkIsGCE()){let[t,n]=await Promise.all([js.instance("service-accounts/default/email"),this.getUniverseDomain()]);return{client_email:t,universe_domain:n}}throw new Error(Wt.GoogleAuthExceptionMessages.NO_CREDENTIALS_FOUND)}async getClient(){if(this.cachedCredential)return this.cachedCredential;this.#e=this.#e||this.#r();try{return await this.#e}finally{this.#e=null}}async#r(){if(this.jsonContent)return this._cacheClientFromJSON(this.jsonContent,this.clientOptions);if(this.keyFilename){let e=ul.resolve(this.keyFilename),t=Ns.createReadStream(e);return await this.fromStreamAsync(t,this.clientOptions)}else if(this.apiKey){let e=await this.fromAPIKey(this.apiKey,this.clientOptions);e.scopes=this.scopes;let{credential:t}=await this.#t(e);return t}else{let{credential:e}=await this.getApplicationDefaultAsync(this.clientOptions);return e}}async getIdTokenClient(e){let t=await this.getClient();if(!("fetchIdToken"in t))throw new Error("Cannot fetch ID token in this environment, use GCE or set the GOOGLE_APPLICATION_CREDENTIALS environment variable to a service account credentials JSON file.");return new Ew.IdTokenClient({targetAudience:e,idTokenProvider:t})}async getAccessToken(){return(await(await this.getClient()).getAccessToken()).token}async getRequestHeaders(e){return(await this.getClient()).getRequestHeaders(e)}async authorizeRequest(e={}){let t=e.url,o=await(await this.getClient()).getRequestHeaders(t);return e.headers=yw.Gaxios.mergeHeaders(e.headers,o),e}async fetch(...e){return(await this.getClient()).fetch(...e)}async request(e){return(await this.getClient()).request(e)}getEnv(){return(0,ww.getEnv)()}async sign(e,t){let n=await this.getClient(),o=await this.getUniverseDomain();if(t=t||`https://iamcredentials.${o}/v1/projects/-/serviceAccounts/`,n instanceof Kn.Impersonated)return(await n.sign(e)).signedBlob;let i=(0,Cw.createCrypto)();if(n instanceof Vn.JWT&&n.key)return await i.sign(n.key,e);let u=await this.getCredentials();if(!u.client_email)throw new Error("Cannot sign data without `client_email`.");return this.signBlob(i,u.client_email,e,t)}async signBlob(e,t,n,o){let i=new URL(o+`${t}:signBlob`);return(await this.request({method:"POST",url:i.href,data:{payload:e.encodeBase64StringUtf8(n)},retry:!0,retryConfig:{httpMethodsToRetry:["POST"]}})).data.signedBlob}};Wt.GoogleAuth=ll});var eg=z(Gi=>{"use strict";Object.defineProperty(Gi,"__esModule",{value:!0});Gi.IAMAuth=void 0;var fl=class{selector;token;constructor(e,t){this.selector=e,this.token=t,this.selector=e,this.token=t}getRequestHeaders(){return{"x-goog-iam-authority-selector":this.selector,"x-goog-iam-authorization-token":this.token}}};Gi.IAMAuth=fl});var tg=z(nr=>{"use strict";Object.defineProperty(nr,"__esModule",{value:!0});nr.DownscopedClient=nr.EXPIRATION_TIME_OFFSET=nr.MAX_ACCESS_BOUNDARY_RULES_COUNT=void 0;var Dw=ze(),Sw=require("stream"),dl=gt(),Tw=Di(),vw="urn:ietf:params:oauth:grant-type:token-exchange",Rw="urn:ietf:params:oauth:token-type:access_token",kw="urn:ietf:params:oauth:token-type:access_token";nr.MAX_ACCESS_BOUNDARY_RULES_COUNT=10;nr.EXPIRATION_TIME_OFFSET=5*60*1e3;var hl=class extends dl.AuthClient{authClient;credentialAccessBoundary;cachedDownscopedAccessToken;stsCredential;constructor(e,t={accessBoundary:{accessBoundaryRules:[]}}){if(super(e instanceof dl.AuthClient?{}:e),e instanceof dl.AuthClient?(this.authClient=e,this.credentialAccessBoundary=t):(this.authClient=e.authClient,this.credentialAccessBoundary=e.credentialAccessBoundary),this.credentialAccessBoundary.accessBoundary.accessBoundaryRules.length===0)throw new Error("At least one access boundary rule needs to be defined.");if(this.credentialAccessBoundary.accessBoundary.accessBoundaryRules.length>nr.MAX_ACCESS_BOUNDARY_RULES_COUNT)throw new Error(`The provided access boundary has more than ${nr.MAX_ACCESS_BOUNDARY_RULES_COUNT} access boundary rules.`);for(let n of this.credentialAccessBoundary.accessBoundary.accessBoundaryRules)if(n.availablePermissions.length===0)throw new Error("At least one permission should be defined in access boundary rules.");this.stsCredential=new Tw.StsCredentials({tokenExchangeEndpoint:`https://sts.${this.universeDomain}/v1/token`}),this.cachedDownscopedAccessToken=null}setCredentials(e){if(!e.expiry_date)throw new Error("The access token expiry_date field is missing in the provided credentials.");super.setCredentials(e),this.cachedDownscopedAccessToken=e}async getAccessToken(){return(!this.cachedDownscopedAccessToken||this.isExpired(this.cachedDownscopedAccessToken))&&await this.refreshAccessTokenAsync(),{token:this.cachedDownscopedAccessToken.access_token,expirationTime:this.cachedDownscopedAccessToken.expiry_date,res:this.cachedDownscopedAccessToken.res}}async getRequestHeaders(){let e=await this.getAccessToken(),t=new Headers({authorization:`Bearer ${e.token}`});return this.addSharedMetadataHeaders(t)}request(e,t){if(t)this.requestAsync(e).then(n=>t(null,n),n=>t(n,n.response));else return this.requestAsync(e)}async requestAsync(e,t=!1){let n;try{let o=await this.getRequestHeaders();e.headers=Dw.Gaxios.mergeHeaders(e.headers),this.addUserProjectAndAuthHeaders(e.headers,o),n=await this.transporter.request(e)}catch(o){let i=o.response;if(i){let u=i.status,f=i.config.data instanceof Sw.Readable;if(!t&&(u===401||u===403)&&!f&&this.forceRefreshOnFailure)return await this.refreshAccessTokenAsync(),await this.requestAsync(e,!0)}throw o}return n}async refreshAccessTokenAsync(){let e=(await this.authClient.getAccessToken()).token,t={grantType:vw,requestedTokenType:Rw,subjectToken:e,subjectTokenType:kw},n=await this.stsCredential.exchangeToken(t,void 0,this.credentialAccessBoundary),o=this.authClient.credentials?.expiry_date||null,i=n.expires_in?new Date().getTime()+n.expires_in*1e3:o;return this.cachedDownscopedAccessToken={access_token:n.access_token,expiry_date:i,res:n.res},this.credentials={},Object.assign(this.credentials,this.cachedDownscopedAccessToken),delete this.credentials.res,this.emit("tokens",{refresh_token:null,expiry_date:this.cachedDownscopedAccessToken.expiry_date,access_token:this.cachedDownscopedAccessToken.access_token,token_type:"Bearer",id_token:null}),this.cachedDownscopedAccessToken}isExpired(e){let t=new Date().getTime();return e.expiry_date?t>=e.expiry_date-this.eagerRefreshThresholdMillis:!1}};nr.DownscopedClient=hl});var rg=z(Wi=>{"use strict";Object.defineProperty(Wi,"__esModule",{value:!0});Wi.PassThroughClient=void 0;var Fw=gt(),pl=class extends Fw.AuthClient{async request(e){return this.transporter.request(e)}async getAccessToken(){return{}}async getRequestHeaders(){return new Headers}};Wi.PassThroughClient=pl});var gl=z(ee=>{"use strict";Object.defineProperty(ee,"__esModule",{value:!0});ee.GoogleAuth=ee.auth=ee.PassThroughClient=ee.ExecutableError=ee.PluggableAuthClient=ee.DownscopedClient=ee.BaseExternalAccountClient=ee.ExternalAccountClient=ee.IdentityPoolClient=ee.AwsRequestSigner=ee.AwsClient=ee.UserRefreshClient=ee.LoginTicket=ee.ClientAuthentication=ee.OAuth2Client=ee.CodeChallengeMethod=ee.Impersonated=ee.JWT=ee.JWTAccess=ee.IdTokenClient=ee.IAMAuth=ee.GCPEnv=ee.Compute=ee.DEFAULT_UNIVERSE=ee.AuthClient=ee.gaxios=ee.gcpMetadata=void 0;var ng=Zm();Object.defineProperty(ee,"GoogleAuth",{enumerable:!0,get:function(){return ng.GoogleAuth}});ee.gcpMetadata=ws();ee.gaxios=ze();var sg=gt();Object.defineProperty(ee,"AuthClient",{enumerable:!0,get:function(){return sg.AuthClient}});Object.defineProperty(ee,"DEFAULT_UNIVERSE",{enumerable:!0,get:function(){return sg.DEFAULT_UNIVERSE}});var Ow=rc();Object.defineProperty(ee,"Compute",{enumerable:!0,get:function(){return Ow.Compute}});var Pw=oc();Object.defineProperty(ee,"GCPEnv",{enumerable:!0,get:function(){return Pw.GCPEnv}});var xw=eg();Object.defineProperty(ee,"IAMAuth",{enumerable:!0,get:function(){return xw.IAMAuth}});var Bw=sc();Object.defineProperty(ee,"IdTokenClient",{enumerable:!0,get:function(){return Bw.IdTokenClient}});var Iw=wc();Object.defineProperty(ee,"JWTAccess",{enumerable:!0,get:function(){return Iw.JWTAccess}});var Nw=Dc();Object.defineProperty(ee,"JWT",{enumerable:!0,get:function(){return Nw.JWT}});var jw=Rc();Object.defineProperty(ee,"Impersonated",{enumerable:!0,get:function(){return jw.Impersonated}});var ml=on();Object.defineProperty(ee,"CodeChallengeMethod",{enumerable:!0,get:function(){return ml.CodeChallengeMethod}});Object.defineProperty(ee,"OAuth2Client",{enumerable:!0,get:function(){return ml.OAuth2Client}});Object.defineProperty(ee,"ClientAuthentication",{enumerable:!0,get:function(){return ml.ClientAuthentication}});var qw=Qu();Object.defineProperty(ee,"LoginTicket",{enumerable:!0,get:function(){return qw.LoginTicket}});var Lw=Tc();Object.defineProperty(ee,"UserRefreshClient",{enumerable:!0,get:function(){return Lw.UserRefreshClient}});var Uw=zc();Object.defineProperty(ee,"AwsClient",{enumerable:!0,get:function(){return Uw.AwsClient}});var Mw=Gc();Object.defineProperty(ee,"AwsRequestSigner",{enumerable:!0,get:function(){return Mw.AwsRequestSigner}});var $w=$c();Object.defineProperty(ee,"IdentityPoolClient",{enumerable:!0,get:function(){return $w.IdentityPoolClient}});var Hw=ol();Object.defineProperty(ee,"ExternalAccountClient",{enumerable:!0,get:function(){return Hw.ExternalAccountClient}});var Gw=jr();Object.defineProperty(ee,"BaseExternalAccountClient",{enumerable:!0,get:function(){return Gw.BaseExternalAccountClient}});var Ww=tg();Object.defineProperty(ee,"DownscopedClient",{enumerable:!0,get:function(){return Ww.DownscopedClient}});var og=nl();Object.defineProperty(ee,"PluggableAuthClient",{enumerable:!0,get:function(){return og.PluggableAuthClient}});Object.defineProperty(ee,"ExecutableError",{enumerable:!0,get:function(){return og.ExecutableError}});var Jw=rg();Object.defineProperty(ee,"PassThroughClient",{enumerable:!0,get:function(){return Jw.PassThroughClient}});var zw=new ng.GoogleAuth;ee.auth=zw});var nA={};Ua(nA,{default:()=>rA});module.exports=i0(nA);var _g=Me(require("fastify"),1),Cg=Me(require("@fastify/cors"),1);var as=require("fs"),Ya=require("path"),Gf=require("dotenv"),Wf=Me(Ka(),1),bo=class{config={};options;constructor(e={jsonPath:"./config.json"}){this.options={envPath:e.envPath||".env",jsonPath:e.jsonPath,useEnvFile:!1,useJsonFile:e.useJsonFile!==!1,useEnvironmentVariables:e.useEnvironmentVariables!==!1,...e},this.loadConfig()}loadConfig(){this.options.useJsonFile&&this.options.jsonPath&&this.loadJsonConfig(),this.options.initialConfig&&(this.config={...this.config,...this.options.initialConfig}),this.options.useEnvFile&&this.loadEnvConfig(),this.config.LOG_FILE&&(process.env.LOG_FILE=this.config.LOG_FILE),this.config.LOG&&(process.env.LOG=this.config.LOG)}loadJsonConfig(){if(!this.options.jsonPath)return;let e=this.isAbsolutePath(this.options.jsonPath)?this.options.jsonPath:(0,Ya.join)(process.cwd(),this.options.jsonPath);if((0,as.existsSync)(e))try{let t=(0,as.readFileSync)(e,"utf-8"),n=Wf.default.parse(t);this.config={...this.config,...n},console.log(`Loaded JSON config from: ${e}`)}catch(t){console.warn(`Failed to load JSON config from ${e}:`,t)}else console.warn(`JSON config file not found: ${e}`)}loadEnvConfig(){let e=this.isAbsolutePath(this.options.envPath)?this.options.envPath:(0,Ya.join)(process.cwd(),this.options.envPath);if((0,as.existsSync)(e))try{let t=(0,Gf.config)({path:e});t.parsed&&(this.config={...this.config,...this.parseEnvConfig(t.parsed)})}catch(t){console.warn(`Failed to load .env config from ${e}:`,t)}}loadEnvironmentVariables(){let e=this.parseEnvConfig(process.env);this.config={...this.config,...e}}parseEnvConfig(e){let t={};return Object.assign(t,e),t}isAbsolutePath(e){return e.startsWith("/")||e.includes(":")}get(e,t){let n=this.config[e];return n!==void 0?n:t}getAll(){return{...this.config}}getHttpsProxy(){return this.get("HTTPS_PROXY")||this.get("https_proxy")||this.get("httpsProxy")||this.get("PROXY_URL")}has(e){return this.config[e]!==void 0}set(e,t){this.config[e]=t}reload(){this.config={},this.loadConfig()}getConfigSummary(){let e=[];return this.options.initialConfig&&e.push("Initial Config"),this.options.useJsonFile&&this.options.jsonPath&&e.push(`JSON: ${this.options.jsonPath}`),this.options.useEnvFile&&e.push(`ENV: ${this.options.envPath}`),this.options.useEnvironmentVariables&&e.push("Environment Variables"),`Config sources: ${e.join(", ")}`}};function nt(r,e=500,t="internal_error",n="api_error"){let o=new Error(r);return o.statusCode=e,o.code=t,o.type=n,o}async function Jf(r,e,t){e.log.error(r);let n=r.statusCode||500,o={error:{message:r.message+r.stack||"Internal Server Error",type:r.type||"api_error",code:r.code||"internal_error"}};return t.code(n).send(o)}var zf=require("undici");function Vf(r,e,t,n,o){let i=new Headers({"Content-Type":"application/json"});t.headers&&Object.entries(t.headers).forEach(([h,d])=>{d&&i.set(h,d)});let u,f=AbortSignal.timeout(t.TIMEOUT??60*1e3*60);if(t.signal){let h=new AbortController,d=()=>h.abort();t.signal.addEventListener("abort",d),f.addEventListener("abort",d),u=h.signal}else u=f;let c={method:"POST",headers:i,body:JSON.stringify(e),signal:u};return t.httpsProxy&&(c.dispatcher=new zf.ProxyAgent(new URL(t.httpsProxy).toString())),n?.debug({reqId:o.req.id,request:c,headers:Object.fromEntries(i.entries()),requestUrl:typeof r=="string"?r:r.toString(),useProxy:t.httpsProxy},"final request"),fetch(typeof r=="string"?r:r.toString(),c)}var Kf="1.0.51";async function g0(r,e,t,n){let o=r.body,i=r.provider,u=t._server.providerService.getProvider(i);if(!u)throw nt(`Provider '${i}' not found`,404,"provider_not_found");let{requestBody:f,config:c,bypass:h}=await y0(o,u,n,r.headers,{req:r}),d=await C0(f,c,u,t,h,n,{req:r}),p=await b0(f,d,u,n,h,{req:r});return E0(p,e,o)}async function y0(r,e,t,n,o){let i=r,u={},f=!1;if(f=_0(e,t,r),f&&(n instanceof Headers?n.delete("content-length"):delete n["content-length"],u.headers=n),!f&&typeof t.transformRequestOut=="function"){let c=await t.transformRequestOut(i);c.body?(i=c.body,u=c.config||{}):i=c}if(!f&&e.transformer?.use?.length)for(let c of e.transformer.use){if(!c||typeof c.transformRequestIn!="function")continue;let h=await c.transformRequestIn(i,e,o);h.body?(i=h.body,u={...u,...h.config}):i=h}if(!f&&e.transformer?.[r.model]?.use?.length)for(let c of e.transformer[r.model].use)!c||typeof c.transformRequestIn!="function"||(i=await c.transformRequestIn(i,e,o));return{requestBody:i,config:u,bypass:f}}function _0(r,e,t){return r.transformer?.use?.length===1&&r.transformer.use[0].name===e.name&&(!r.transformer?.[t.model]?.use.length||r.transformer?.[t.model]?.use.length===1&&r.transformer?.[t.model]?.use[0].name===e.name)}async function C0(r,e,t,n,o,i,u){let f=e.url||new URL(t.baseUrl);if(o&&typeof i.auth=="function"){let d=await i.auth(r,t);if(d.body){r=d.body;let p=e.headers||{};d.config?.headers&&(p={...p,...d.config.headers},delete p.host,delete d.config.headers),e={...e,...d.config,headers:p}}else r=d}let c={Authorization:`Bearer ${t.apiKey}`,...e?.headers||{}};for(let d in c)(c[d]==="undefined"||["authorization","Authorization"].includes(d)&&c[d]?.includes("undefined"))&&delete c[d];let h=await Vf(f,r,{httpsProxy:n._server.configService.getHttpsProxy(),...e,headers:JSON.parse(JSON.stringify(c))},n.log,u);if(!h.ok){let d=await h.text();throw n.log.error(`[provider_response_error] Error from provider(${t.name},${r.model}: ${h.status}): ${d}`),nt(`Error from provider(${t.name},${r.model}: ${h.status}): ${d}`,h.status,"provider_response_error")}return h}async function b0(r,e,t,n,o,i){let u=e;if(!o&&t.transformer?.use?.length)for(let f of Array.from(t.transformer.use).reverse())!f||typeof f.transformResponseOut!="function"||(u=await f.transformResponseOut(u,i));if(!o&&t.transformer?.[r.model]?.use?.length)for(let f of Array.from(t.transformer[r.model].use).reverse())!f||typeof f.transformResponseOut!="function"||(u=await f.transformResponseOut(u,i));return!o&&n.transformResponseIn&&(u=await n.transformResponseIn(u,i)),u}function E0(r,e,t){return r.ok||e.code(r.status),t.stream===!0?(e.header("Content-Type","text/event-stream"),e.header("Cache-Control","no-cache"),e.header("Connection","keep-alive"),e.send(r.body)):r.json()}var Yf=async r=>{r.get("/",async()=>({message:"LLMs API",version:Kf})),r.get("/health",async()=>({status:"ok",timestamp:new Date().toISOString()}));let e=r._server.transformerService.getTransformersWithEndpoint();for(let{transformer:t}of e)t.endPoint&&r.post(t.endPoint,async(n,o)=>g0(n,o,r,t));r.post("/providers",{schema:{body:{type:"object",properties:{id:{type:"string"},name:{type:"string"},type:{type:"string",enum:["openai","anthropic"]},baseUrl:{type:"string"},apiKey:{type:"string"},models:{type:"array",items:{type:"string"}}},required:["id","name","type","baseUrl","apiKey","models"]}}},async(t,n)=>{let{name:o,baseUrl:i,apiKey:u,models:f}=t.body;if(!o?.trim())throw nt("Provider name is required",400,"invalid_request");if(!i||!w0(i))throw nt("Valid base URL is required",400,"invalid_request");if(!u?.trim())throw nt("API key is required",400,"invalid_request");if(!f||!Array.isArray(f)||f.length===0)throw nt("At least one model is required",400,"invalid_request");if(r._server.providerService.getProvider(t.body.name))throw nt(`Provider with name '${t.body.name}' already exists`,400,"provider_exists");return r._server.providerService.registerProvider(t.body)}),r.get("/providers",async()=>r._server.providerService.getProviders()),r.get("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]}}},async t=>{let n=r._server.providerService.getProvider(t.params.id);if(!n)throw nt("Provider not found",404,"provider_not_found");return n}),r.put("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]},body:{type:"object",properties:{name:{type:"string"},type:{type:"string",enum:["openai","anthropic"]},baseUrl:{type:"string"},apiKey:{type:"string"},models:{type:"array",items:{type:"string"}},enabled:{type:"boolean"}}}}},async(t,n)=>{let o=r._server.providerService.updateProvider(t.params.id,t.body);if(!o)throw nt("Provider not found",404,"provider_not_found");return o}),r.delete("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]}}},async t=>{if(!r._server.providerService.deleteProvider(t.params.id))throw nt("Provider not found",404,"provider_not_found");return{message:"Provider deleted successfully"}}),r.patch("/providers/:id/toggle",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]},body:{type:"object",properties:{enabled:{type:"boolean"}},required:["enabled"]}}},async(t,n)=>{if(!r._server.providerService.toggleProvider(t.params.id,t.body.enabled))throw nt("Provider not found",404,"provider_not_found");return{message:`Provider ${t.body.enabled?"enabled":"disabled"} successfully`}})};function w0(r){try{return new URL(r),!0}catch{return!1}}var Eo=class{constructor(e){this.providerService=e}registerProvider(e){return this.providerService.registerProvider(e)}getProviders(){return this.providerService.getProviders()}getProvider(e){return this.providerService.getProvider(e)}updateProvider(e,t){return this.providerService.updateProvider(e,t)}deleteProvider(e){return this.providerService.deleteProvider(e)}toggleProvider(e,t){return this.providerService.toggleProvider(e,t)}resolveRoute(e){let t=this.providerService.resolveModelRoute(e);if(!t)throw new Error(`Model ${e} not found. Available models: ${this.getAvailableModelNames().join(", ")}`);return t}async getAvailableModels(){return{object:"list",data:this.providerService.getAvailableModels().flatMap(t=>t.models.map(n=>({id:n,object:"model",provider:t.provider,created:Math.floor(Date.now()/1e3),owned_by:t.provider})))}}getAvailableModelNames(){return this.providerService.getModelRoutes().map(e=>e.fullModel)}getModelRoutes(){return this.providerService.getModelRoutes()}};var wo=class{constructor(e,t,n){this.configService=e;this.transformerService=t;this.logger=n;this.initializeCustomProviders()}providers=new Map;modelRoutes=new Map;initializeCustomProviders(){let e=this.configService.get("providers");if(e&&Array.isArray(e)){this.initializeFromProvidersArray(e);return}}initializeFromProvidersArray(e){e.forEach(t=>{try{if(!t.name||!t.api_base_url||!t.api_key)return;let n={};t.transformer&&Object.keys(t.transformer).forEach(o=>{o==="use"?Array.isArray(t.transformer.use)&&(n.use=t.transformer.use.map(i=>{if(Array.isArray(i)&&typeof i[0]=="string"){let u=this.transformerService.getTransformer(i[0]);if(u)return new u(i[1])}if(typeof i=="string"){let u=this.transformerService.getTransformer(i);return typeof u=="function"?new u:u}}).filter(i=>typeof i<"u")):Array.isArray(t.transformer[o]?.use)&&(n[o]={use:t.transformer[o].use.map(i=>{if(Array.isArray(i)&&typeof i[0]=="string"){let u=this.transformerService.getTransformer(i[0]);if(u)return new u(i[1])}if(typeof i=="string"){let u=this.transformerService.getTransformer(i);return typeof u=="function"?new u:u}}).filter(i=>typeof i<"u")})}),this.registerProvider({name:t.name,baseUrl:t.api_base_url,apiKey:t.api_key,models:t.models||[],transformer:t.transformer?n:void 0}),this.logger.info(`${t.name} provider registered`)}catch(n){this.logger.error(`${t.name} provider registered error: ${n}`)}})}registerProvider(e){let t={...e};return this.providers.set(t.name,t),e.models.forEach(n=>{let o=`${t.name},${n}`,i={provider:t.name,model:n,fullModel:o};this.modelRoutes.set(o,i),this.modelRoutes.has(n)||this.modelRoutes.set(n,i)}),t}getProviders(){return Array.from(this.providers.values())}getProvider(e){return this.providers.get(e)}updateProvider(e,t){let n=this.providers.get(e);if(!n)return null;let o={...n,...t,updatedAt:new Date};return this.providers.set(e,o),t.models&&(n.models.forEach(i=>{let u=`${n.id},${i}`;this.modelRoutes.delete(u),this.modelRoutes.delete(i)}),t.models.forEach(i=>{let u=`${n.name},${i}`,f={provider:n.name,model:i,fullModel:u};this.modelRoutes.set(u,f),this.modelRoutes.has(i)||this.modelRoutes.set(i,f)})),o}deleteProvider(e){let t=this.providers.get(e);return t?(t.models.forEach(n=>{let o=`${t.name},${n}`;this.modelRoutes.delete(o),this.modelRoutes.delete(n)}),this.providers.delete(e),!0):!1}toggleProvider(e,t){return!!this.providers.get(e)}resolveModelRoute(e){let t=this.modelRoutes.get(e);if(!t)return null;let n=this.providers.get(t.provider);return n?{provider:n,originalModel:e,targetModel:t.model}:null}getAvailableModelNames(){let e=[];return this.providers.forEach(t=>{t.models.forEach(n=>{e.push(n),e.push(`${t.name},${n}`)})}),e}getModelRoutes(){return Array.from(this.modelRoutes.values())}parseTransformerConfig(e){return e?Array.isArray(e)?e.reduce((t,n)=>{if(Array.isArray(n)){let[o,i={}]=n;t[o]=i}else t[n]={};return t},{}):e:{}}async getAvailableModels(){let e=[];return this.providers.forEach(t=>{t.models.forEach(n=>{e.push({id:n,object:"model",owned_by:t.name,provider:t.name}),e.push({id:`${t.name},${n}`,object:"model",owned_by:t.name,provider:t.name})})}),{object:"list",data:e}}};var Je=[];for(let r=0;r<256;++r)Je.push((r+256).toString(16).slice(1));function Xf(r,e=0){return(Je[r[e+0]]+Je[r[e+1]]+Je[r[e+2]]+Je[r[e+3]]+"-"+Je[r[e+4]]+Je[r[e+5]]+"-"+Je[r[e+6]]+Je[r[e+7]]+"-"+Je[r[e+8]]+Je[r[e+9]]+"-"+Je[r[e+10]]+Je[r[e+11]]+Je[r[e+12]]+Je[r[e+13]]+Je[r[e+14]]+Je[r[e+15]]).toLowerCase()}var Qf=require("crypto"),Do=new Uint8Array(256),Ao=Do.length;function Xa(){return Ao>Do.length-16&&((0,Qf.randomFillSync)(Do),Ao=0),Do.slice(Ao,Ao+=16)}var Zf=require("crypto"),Qa={randomUUID:Zf.randomUUID};function A0(r,e,t){if(Qa.randomUUID&&!e&&!r)return Qa.randomUUID();r=r||{};let n=r.random??r.rng?.()??Xa();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let o=0;o<16;++o)e[t+o]=n[o];return e}return Xf(n)}var zt=A0;var ed=r=>r<=0?"none":r<=1024?"low":r<=8192?"medium":"high";var td=(r,e)=>(r.includes("base64")&&(r=r.split("base64").pop(),r.startsWith(",")&&(r=r.slice(1))),`data:${e};base64,${r}`);var So=class{constructor(e){this.options=e;this.useBearer=this.options?.UseBearer??!1}name="Anthropic";endPoint="/v1/messages";useBearer;logger;async auth(e,t){let n={};return this.useBearer?(n.authorization=`Bearer ${t.apiKey}`,n["x-api-key"]=void 0):(n["x-api-key"]=t.apiKey,n.authorization=void 0),{body:e,config:{headers:n}}}async transformRequestOut(e){let t=[];if(e.system){if(typeof e.system=="string")t.push({role:"system",content:e.system});else if(Array.isArray(e.system)&&e.system.length){let i=e.system.filter(u=>u.type==="text"&&u.text).map(u=>({type:"text",text:u.text,cache_control:u.cache_control}));t.push({role:"system",content:i})}}JSON.parse(JSON.stringify(e.messages||[]))?.forEach(i=>{if(i.role==="user"||i.role==="assistant"){if(typeof i.content=="string"){t.push({role:i.role,content:i.content});return}if(Array.isArray(i.content)){if(i.role==="user"){let u=i.content.filter(c=>c.type==="tool_result"&&c.tool_use_id);u.length&&u.forEach(c=>{let h={role:"tool",content:typeof c.content=="string"?c.content:JSON.stringify(c.content),tool_call_id:c.tool_use_id,cache_control:c.cache_control};t.push(h)});let f=i.content.filter(c=>c.type==="text"&&c.text||c.type==="image"&&c.source);f.length&&t.push({role:"user",content:f.map(c=>c?.type==="image"?{type:"image_url",image_url:{url:c.source?.type==="base64"?td(c.source.data,c.source.media_type):c.source.url},media_type:c.source.media_type}:c)})}else if(i.role==="assistant"){let u={role:"assistant",content:""},f=i.content.filter(d=>d.type==="text"&&d.text);f.length&&(u.content=f.map(d=>d.text).join(`
+https://cloud.google.com/compute/docs/metadata/predefined-metadata-keys`};var ll=class{checkIsGCE=void 0;useJWTAccessWithScope;defaultServicePath;get isGCE(){return this.checkIsGCE}_findProjectIdPromise;_cachedProjectId;jsonContent=null;apiKey;cachedCredential=null;#e=null;defaultScopes;keyFilename;scopes;clientOptions={};constructor(e={}){if(this._cachedProjectId=e.projectId||null,this.cachedCredential=e.authClient||null,this.keyFilename=e.keyFilename||e.keyFile,this.scopes=e.scopes,this.clientOptions=e.clientOptions||{},this.jsonContent=e.credentials||null,this.apiKey=e.apiKey||this.clientOptions.apiKey||null,this.apiKey&&(this.jsonContent||this.clientOptions.credentials))throw new RangeError(Wt.GoogleAuthExceptionMessages.API_KEY_WITH_CREDENTIALS);e.universeDomain&&(this.clientOptions.universeDomain=e.universeDomain)}setGapicJWTValues(e){e.defaultServicePath=this.defaultServicePath,e.useJWTAccessWithScope=this.useJWTAccessWithScope,e.defaultScopes=this.defaultScopes}getProjectId(e){if(e)this.getProjectIdAsync().then(t=>e(null,t),e);else return this.getProjectIdAsync()}async getProjectIdOptional(){try{return await this.getProjectId()}catch(e){if(e instanceof Error&&e.message===Wt.GoogleAuthExceptionMessages.NO_PROJECT_ID_FOUND)return null;throw e}}async findAndCacheProjectId(){let e=null;if(e||=await this.getProductionProjectId(),e||=await this.getFileProjectId(),e||=await this.getDefaultServiceProjectId(),e||=await this.getGCEProjectId(),e||=await this.getExternalAccountClientProjectId(),e)return this._cachedProjectId=e,e;throw new Error(Wt.GoogleAuthExceptionMessages.NO_PROJECT_ID_FOUND)}async getProjectIdAsync(){return this._cachedProjectId?this._cachedProjectId:(this._findProjectIdPromise||(this._findProjectIdPromise=this.findAndCacheProjectId()),this._findProjectIdPromise)}async getUniverseDomainFromMetadataServer(){let e;try{e=await js.universe("universe-domain"),e||=cl.DEFAULT_UNIVERSE}catch(t){if(t&&t?.response?.status===404)e=cl.DEFAULT_UNIVERSE;else throw t}return e}async getUniverseDomain(){let e=(0,Qm.originalOrCamelOptions)(this.clientOptions).get("universe_domain");try{e??=(await this.getClient()).universeDomain}catch{e??=cl.DEFAULT_UNIVERSE}return e}getAnyScopes(){return this.scopes||this.defaultScopes}getApplicationDefault(e={},t){let n;if(typeof e=="function"?t=e:n=e,t)this.getApplicationDefaultAsync(n).then(o=>t(null,o.credential,o.projectId),t);else return this.getApplicationDefaultAsync(n)}async getApplicationDefaultAsync(e={}){if(this.cachedCredential)return await this.#t(this.cachedCredential,null);let t;if(t=await this._tryGetApplicationCredentialsFromEnvironmentVariable(e),t)return t instanceof Vn.JWT?t.scopes=this.scopes:t instanceof qs.BaseExternalAccountClient&&(t.scopes=this.getAnyScopes()),await this.#t(t);if(t=await this._tryGetApplicationCredentialsFromWellKnownFile(e),t)return t instanceof Vn.JWT?t.scopes=this.scopes:t instanceof qs.BaseExternalAccountClient&&(t.scopes=this.getAnyScopes()),await this.#t(t);if(await this._checkIsGCE())return e.scopes=this.getAnyScopes(),await this.#t(new bw.Compute(e));throw new Error(Wt.GoogleAuthExceptionMessages.NO_ADC_FOUND)}async#t(e,t=process.env.GOOGLE_CLOUD_QUOTA_PROJECT||null){let n=await this.getProjectIdOptional();return t&&(e.quotaProjectId=t),this.cachedCredential=e,{credential:e,projectId:n}}async _checkIsGCE(){return this.checkIsGCE===void 0&&(this.checkIsGCE=js.getGCPResidency()||await js.isAvailable()),this.checkIsGCE}async _tryGetApplicationCredentialsFromEnvironmentVariable(e){let t=process.env.GOOGLE_APPLICATION_CREDENTIALS||process.env.google_application_credentials;if(!t||t.length===0)return null;try{return this._getApplicationCredentialsFromFilePath(t,e)}catch(n){throw n instanceof Error&&(n.message=`Unable to read the credential file specified by the GOOGLE_APPLICATION_CREDENTIALS environment variable: ${n.message}`),n}}async _tryGetApplicationCredentialsFromWellKnownFile(e){let t=null;if(this._isWindows())t=process.env.APPDATA;else{let o=process.env.HOME;o&&(t=ul.join(o,".config"))}return t&&(t=ul.join(t,"gcloud","application_default_credentials.json"),Ns.existsSync(t)||(t=null)),t?await this._getApplicationCredentialsFromFilePath(t,e):null}async _getApplicationCredentialsFromFilePath(e,t={}){if(!e||e.length===0)throw new Error("The file path is invalid.");try{if(e=Ns.realpathSync(e),!Ns.lstatSync(e).isFile())throw new Error}catch(o){throw o instanceof Error&&(o.message=`The file at ${e} does not exist, or it is not a file. ${o.message}`),o}let n=Ns.createReadStream(e);return this.fromStream(n,t)}fromImpersonatedJSON(e){if(!e)throw new Error("Must pass in a JSON object containing an  impersonated refresh token");if(e.type!==Kn.IMPERSONATED_ACCOUNT_TYPE)throw new Error(`The incoming JSON object does not have the "${Kn.IMPERSONATED_ACCOUNT_TYPE}" type`);if(!e.source_credentials)throw new Error("The incoming JSON object does not contain a source_credentials field");if(!e.service_account_impersonation_url)throw new Error("The incoming JSON object does not contain a service_account_impersonation_url field");let t=this.fromJSON(e.source_credentials);if(e.service_account_impersonation_url?.length>256)throw new RangeError(`Target principal is too long: ${e.service_account_impersonation_url}`);let n=/(?<target>[^/]+):(generateAccessToken|generateIdToken)$/.exec(e.service_account_impersonation_url)?.groups?.target;if(!n)throw new RangeError(`Cannot extract target principal from ${e.service_account_impersonation_url}`);let o=this.getAnyScopes()??[];return new Kn.Impersonated({...e,sourceClient:t,targetPrincipal:n,targetScopes:Array.isArray(o)?o:[o]})}fromJSON(e,t={}){let n,o=(0,Qm.originalOrCamelOptions)(t).get("universe_domain");return e.type===Ym.USER_REFRESH_ACCOUNT_TYPE?(n=new Ym.UserRefreshClient(t),n.fromJSON(e)):e.type===Kn.IMPERSONATED_ACCOUNT_TYPE?n=this.fromImpersonatedJSON(e):e.type===qs.EXTERNAL_ACCOUNT_TYPE?(n=Aw.ExternalAccountClient.fromJSON({...e,...t}),n.scopes=this.getAnyScopes()):e.type===Xm.EXTERNAL_ACCOUNT_AUTHORIZED_USER_TYPE?n=new Xm.ExternalAccountAuthorizedUserClient({...e,...t}):(t.scopes=this.scopes,n=new Vn.JWT(t),this.setGapicJWTValues(n),n.fromJSON(e)),o&&(n.universeDomain=o),n}_cacheClientFromJSON(e,t){let n=this.fromJSON(e,t);return this.jsonContent=e,this.cachedCredential=n,n}fromStream(e,t={},n){let o={};if(typeof t=="function"?n=t:o=t,n)this.fromStreamAsync(e,o).then(i=>n(null,i),n);else return this.fromStreamAsync(e,o)}fromStreamAsync(e,t){return new Promise((n,o)=>{if(!e)throw new Error("Must pass in a stream containing the Google auth settings.");let i=[];e.setEncoding("utf8").on("error",o).on("data",u=>i.push(u)).on("end",()=>{try{try{let u=JSON.parse(i.join("")),f=this._cacheClientFromJSON(u,t);return n(f)}catch(u){if(!this.keyFilename)throw u;let f=new Vn.JWT({...this.clientOptions,keyFile:this.keyFilename});return this.cachedCredential=f,this.setGapicJWTValues(f),n(f)}}catch(u){return o(u)}})})}fromAPIKey(e,t={}){return new Vn.JWT({...t,apiKey:e})}_isWindows(){let e=_w.platform();return!!(e&&e.length>=3&&e.substring(0,3).toLowerCase()==="win")}async getDefaultServiceProjectId(){return new Promise(e=>{(0,gw.exec)("gcloud config config-helper --format json",(t,n)=>{if(!t&&n)try{let o=JSON.parse(n).configuration.properties.core.project;e(o);return}catch{}e(null)})})}getProductionProjectId(){return process.env.GCLOUD_PROJECT||process.env.GOOGLE_CLOUD_PROJECT||process.env.gcloud_project||process.env.google_cloud_project}async getFileProjectId(){if(this.cachedCredential)return this.cachedCredential.projectId;if(this.keyFilename){let t=await this.getClient();if(t&&t.projectId)return t.projectId}let e=await this._tryGetApplicationCredentialsFromEnvironmentVariable();return e?e.projectId:null}async getExternalAccountClientProjectId(){return!this.jsonContent||this.jsonContent.type!==qs.EXTERNAL_ACCOUNT_TYPE?null:await(await this.getClient()).getProjectId()}async getGCEProjectId(){try{return await js.project("project-id")}catch{return null}}getCredentials(e){if(e)this.getCredentialsAsync().then(t=>e(null,t),e);else return this.getCredentialsAsync()}async getCredentialsAsync(){let e=await this.getClient();if(e instanceof Kn.Impersonated)return{client_email:e.getTargetPrincipal()};if(e instanceof qs.BaseExternalAccountClient){let t=e.getServiceAccountEmail();if(t)return{client_email:t,universe_domain:e.universeDomain}}if(this.jsonContent)return{client_email:this.jsonContent.client_email,private_key:this.jsonContent.private_key,universe_domain:this.jsonContent.universe_domain};if(await this._checkIsGCE()){let[t,n]=await Promise.all([js.instance("service-accounts/default/email"),this.getUniverseDomain()]);return{client_email:t,universe_domain:n}}throw new Error(Wt.GoogleAuthExceptionMessages.NO_CREDENTIALS_FOUND)}async getClient(){if(this.cachedCredential)return this.cachedCredential;this.#e=this.#e||this.#r();try{return await this.#e}finally{this.#e=null}}async#r(){if(this.jsonContent)return this._cacheClientFromJSON(this.jsonContent,this.clientOptions);if(this.keyFilename){let e=ul.resolve(this.keyFilename),t=Ns.createReadStream(e);return await this.fromStreamAsync(t,this.clientOptions)}else if(this.apiKey){let e=await this.fromAPIKey(this.apiKey,this.clientOptions);e.scopes=this.scopes;let{credential:t}=await this.#t(e);return t}else{let{credential:e}=await this.getApplicationDefaultAsync(this.clientOptions);return e}}async getIdTokenClient(e){let t=await this.getClient();if(!("fetchIdToken"in t))throw new Error("Cannot fetch ID token in this environment, use GCE or set the GOOGLE_APPLICATION_CREDENTIALS environment variable to a service account credentials JSON file.");return new Ew.IdTokenClient({targetAudience:e,idTokenProvider:t})}async getAccessToken(){return(await(await this.getClient()).getAccessToken()).token}async getRequestHeaders(e){return(await this.getClient()).getRequestHeaders(e)}async authorizeRequest(e={}){let t=e.url,o=await(await this.getClient()).getRequestHeaders(t);return e.headers=yw.Gaxios.mergeHeaders(e.headers,o),e}async fetch(...e){return(await this.getClient()).fetch(...e)}async request(e){return(await this.getClient()).request(e)}getEnv(){return(0,ww.getEnv)()}async sign(e,t){let n=await this.getClient(),o=await this.getUniverseDomain();if(t=t||`https://iamcredentials.${o}/v1/projects/-/serviceAccounts/`,n instanceof Kn.Impersonated)return(await n.sign(e)).signedBlob;let i=(0,Cw.createCrypto)();if(n instanceof Vn.JWT&&n.key)return await i.sign(n.key,e);let u=await this.getCredentials();if(!u.client_email)throw new Error("Cannot sign data without `client_email`.");return this.signBlob(i,u.client_email,e,t)}async signBlob(e,t,n,o){let i=new URL(o+`${t}:signBlob`);return(await this.request({method:"POST",url:i.href,data:{payload:e.encodeBase64StringUtf8(n)},retry:!0,retryConfig:{httpMethodsToRetry:["POST"]}})).data.signedBlob}};Wt.GoogleAuth=ll});var eg=z(Gi=>{"use strict";Object.defineProperty(Gi,"__esModule",{value:!0});Gi.IAMAuth=void 0;var fl=class{selector;token;constructor(e,t){this.selector=e,this.token=t,this.selector=e,this.token=t}getRequestHeaders(){return{"x-goog-iam-authority-selector":this.selector,"x-goog-iam-authorization-token":this.token}}};Gi.IAMAuth=fl});var tg=z(nr=>{"use strict";Object.defineProperty(nr,"__esModule",{value:!0});nr.DownscopedClient=nr.EXPIRATION_TIME_OFFSET=nr.MAX_ACCESS_BOUNDARY_RULES_COUNT=void 0;var Dw=ze(),Sw=require("stream"),dl=gt(),Tw=Di(),vw="urn:ietf:params:oauth:grant-type:token-exchange",Rw="urn:ietf:params:oauth:token-type:access_token",kw="urn:ietf:params:oauth:token-type:access_token";nr.MAX_ACCESS_BOUNDARY_RULES_COUNT=10;nr.EXPIRATION_TIME_OFFSET=5*60*1e3;var hl=class extends dl.AuthClient{authClient;credentialAccessBoundary;cachedDownscopedAccessToken;stsCredential;constructor(e,t={accessBoundary:{accessBoundaryRules:[]}}){if(super(e instanceof dl.AuthClient?{}:e),e instanceof dl.AuthClient?(this.authClient=e,this.credentialAccessBoundary=t):(this.authClient=e.authClient,this.credentialAccessBoundary=e.credentialAccessBoundary),this.credentialAccessBoundary.accessBoundary.accessBoundaryRules.length===0)throw new Error("At least one access boundary rule needs to be defined.");if(this.credentialAccessBoundary.accessBoundary.accessBoundaryRules.length>nr.MAX_ACCESS_BOUNDARY_RULES_COUNT)throw new Error(`The provided access boundary has more than ${nr.MAX_ACCESS_BOUNDARY_RULES_COUNT} access boundary rules.`);for(let n of this.credentialAccessBoundary.accessBoundary.accessBoundaryRules)if(n.availablePermissions.length===0)throw new Error("At least one permission should be defined in access boundary rules.");this.stsCredential=new Tw.StsCredentials({tokenExchangeEndpoint:`https://sts.${this.universeDomain}/v1/token`}),this.cachedDownscopedAccessToken=null}setCredentials(e){if(!e.expiry_date)throw new Error("The access token expiry_date field is missing in the provided credentials.");super.setCredentials(e),this.cachedDownscopedAccessToken=e}async getAccessToken(){return(!this.cachedDownscopedAccessToken||this.isExpired(this.cachedDownscopedAccessToken))&&await this.refreshAccessTokenAsync(),{token:this.cachedDownscopedAccessToken.access_token,expirationTime:this.cachedDownscopedAccessToken.expiry_date,res:this.cachedDownscopedAccessToken.res}}async getRequestHeaders(){let e=await this.getAccessToken(),t=new Headers({authorization:`Bearer ${e.token}`});return this.addSharedMetadataHeaders(t)}request(e,t){if(t)this.requestAsync(e).then(n=>t(null,n),n=>t(n,n.response));else return this.requestAsync(e)}async requestAsync(e,t=!1){let n;try{let o=await this.getRequestHeaders();e.headers=Dw.Gaxios.mergeHeaders(e.headers),this.addUserProjectAndAuthHeaders(e.headers,o),n=await this.transporter.request(e)}catch(o){let i=o.response;if(i){let u=i.status,f=i.config.data instanceof Sw.Readable;if(!t&&(u===401||u===403)&&!f&&this.forceRefreshOnFailure)return await this.refreshAccessTokenAsync(),await this.requestAsync(e,!0)}throw o}return n}async refreshAccessTokenAsync(){let e=(await this.authClient.getAccessToken()).token,t={grantType:vw,requestedTokenType:Rw,subjectToken:e,subjectTokenType:kw},n=await this.stsCredential.exchangeToken(t,void 0,this.credentialAccessBoundary),o=this.authClient.credentials?.expiry_date||null,i=n.expires_in?new Date().getTime()+n.expires_in*1e3:o;return this.cachedDownscopedAccessToken={access_token:n.access_token,expiry_date:i,res:n.res},this.credentials={},Object.assign(this.credentials,this.cachedDownscopedAccessToken),delete this.credentials.res,this.emit("tokens",{refresh_token:null,expiry_date:this.cachedDownscopedAccessToken.expiry_date,access_token:this.cachedDownscopedAccessToken.access_token,token_type:"Bearer",id_token:null}),this.cachedDownscopedAccessToken}isExpired(e){let t=new Date().getTime();return e.expiry_date?t>=e.expiry_date-this.eagerRefreshThresholdMillis:!1}};nr.DownscopedClient=hl});var rg=z(Wi=>{"use strict";Object.defineProperty(Wi,"__esModule",{value:!0});Wi.PassThroughClient=void 0;var Fw=gt(),pl=class extends Fw.AuthClient{async request(e){return this.transporter.request(e)}async getAccessToken(){return{}}async getRequestHeaders(){return new Headers}};Wi.PassThroughClient=pl});var gl=z(ee=>{"use strict";Object.defineProperty(ee,"__esModule",{value:!0});ee.GoogleAuth=ee.auth=ee.PassThroughClient=ee.ExecutableError=ee.PluggableAuthClient=ee.DownscopedClient=ee.BaseExternalAccountClient=ee.ExternalAccountClient=ee.IdentityPoolClient=ee.AwsRequestSigner=ee.AwsClient=ee.UserRefreshClient=ee.LoginTicket=ee.ClientAuthentication=ee.OAuth2Client=ee.CodeChallengeMethod=ee.Impersonated=ee.JWT=ee.JWTAccess=ee.IdTokenClient=ee.IAMAuth=ee.GCPEnv=ee.Compute=ee.DEFAULT_UNIVERSE=ee.AuthClient=ee.gaxios=ee.gcpMetadata=void 0;var ng=Zm();Object.defineProperty(ee,"GoogleAuth",{enumerable:!0,get:function(){return ng.GoogleAuth}});ee.gcpMetadata=ws();ee.gaxios=ze();var sg=gt();Object.defineProperty(ee,"AuthClient",{enumerable:!0,get:function(){return sg.AuthClient}});Object.defineProperty(ee,"DEFAULT_UNIVERSE",{enumerable:!0,get:function(){return sg.DEFAULT_UNIVERSE}});var Ow=rc();Object.defineProperty(ee,"Compute",{enumerable:!0,get:function(){return Ow.Compute}});var Pw=oc();Object.defineProperty(ee,"GCPEnv",{enumerable:!0,get:function(){return Pw.GCPEnv}});var xw=eg();Object.defineProperty(ee,"IAMAuth",{enumerable:!0,get:function(){return xw.IAMAuth}});var Bw=sc();Object.defineProperty(ee,"IdTokenClient",{enumerable:!0,get:function(){return Bw.IdTokenClient}});var Iw=wc();Object.defineProperty(ee,"JWTAccess",{enumerable:!0,get:function(){return Iw.JWTAccess}});var Nw=Dc();Object.defineProperty(ee,"JWT",{enumerable:!0,get:function(){return Nw.JWT}});var jw=Rc();Object.defineProperty(ee,"Impersonated",{enumerable:!0,get:function(){return jw.Impersonated}});var ml=on();Object.defineProperty(ee,"CodeChallengeMethod",{enumerable:!0,get:function(){return ml.CodeChallengeMethod}});Object.defineProperty(ee,"OAuth2Client",{enumerable:!0,get:function(){return ml.OAuth2Client}});Object.defineProperty(ee,"ClientAuthentication",{enumerable:!0,get:function(){return ml.ClientAuthentication}});var qw=Qu();Object.defineProperty(ee,"LoginTicket",{enumerable:!0,get:function(){return qw.LoginTicket}});var Lw=Tc();Object.defineProperty(ee,"UserRefreshClient",{enumerable:!0,get:function(){return Lw.UserRefreshClient}});var Uw=zc();Object.defineProperty(ee,"AwsClient",{enumerable:!0,get:function(){return Uw.AwsClient}});var Mw=Gc();Object.defineProperty(ee,"AwsRequestSigner",{enumerable:!0,get:function(){return Mw.AwsRequestSigner}});var $w=$c();Object.defineProperty(ee,"IdentityPoolClient",{enumerable:!0,get:function(){return $w.IdentityPoolClient}});var Hw=ol();Object.defineProperty(ee,"ExternalAccountClient",{enumerable:!0,get:function(){return Hw.ExternalAccountClient}});var Gw=jr();Object.defineProperty(ee,"BaseExternalAccountClient",{enumerable:!0,get:function(){return Gw.BaseExternalAccountClient}});var Ww=tg();Object.defineProperty(ee,"DownscopedClient",{enumerable:!0,get:function(){return Ww.DownscopedClient}});var og=nl();Object.defineProperty(ee,"PluggableAuthClient",{enumerable:!0,get:function(){return og.PluggableAuthClient}});Object.defineProperty(ee,"ExecutableError",{enumerable:!0,get:function(){return og.ExecutableError}});var Jw=rg();Object.defineProperty(ee,"PassThroughClient",{enumerable:!0,get:function(){return Jw.PassThroughClient}});var zw=new ng.GoogleAuth;ee.auth=zw});var nA={};Ua(nA,{default:()=>rA});module.exports=i0(nA);var _g=Me(require("fastify"),1),Cg=Me(require("@fastify/cors"),1);var as=require("fs"),Ya=require("path"),Gf=require("dotenv"),Wf=Me(Ka(),1),bo=class{config={};options;constructor(e={jsonPath:"./config.json"}){this.options={envPath:e.envPath||".env",jsonPath:e.jsonPath,useEnvFile:!1,useJsonFile:e.useJsonFile!==!1,useEnvironmentVariables:e.useEnvironmentVariables!==!1,...e},this.loadConfig()}loadConfig(){this.options.useJsonFile&&this.options.jsonPath&&this.loadJsonConfig(),this.options.initialConfig&&(this.config={...this.config,...this.options.initialConfig}),this.options.useEnvFile&&this.loadEnvConfig(),this.config.LOG_FILE&&(process.env.LOG_FILE=this.config.LOG_FILE),this.config.LOG&&(process.env.LOG=this.config.LOG)}loadJsonConfig(){if(!this.options.jsonPath)return;let e=this.isAbsolutePath(this.options.jsonPath)?this.options.jsonPath:(0,Ya.join)(process.cwd(),this.options.jsonPath);if((0,as.existsSync)(e))try{let t=(0,as.readFileSync)(e,"utf-8"),n=Wf.default.parse(t);this.config={...this.config,...n},console.log(`Loaded JSON config from: ${e}`)}catch(t){console.warn(`Failed to load JSON config from ${e}:`,t)}else console.warn(`JSON config file not found: ${e}`)}loadEnvConfig(){let e=this.isAbsolutePath(this.options.envPath)?this.options.envPath:(0,Ya.join)(process.cwd(),this.options.envPath);if((0,as.existsSync)(e))try{let t=(0,Gf.config)({path:e});t.parsed&&(this.config={...this.config,...this.parseEnvConfig(t.parsed)})}catch(t){console.warn(`Failed to load .env config from ${e}:`,t)}}loadEnvironmentVariables(){let e=this.parseEnvConfig(process.env);this.config={...this.config,...e}}parseEnvConfig(e){let t={};return Object.assign(t,e),t}isAbsolutePath(e){return e.startsWith("/")||e.includes(":")}get(e,t){let n=this.config[e];return n!==void 0?n:t}getAll(){return{...this.config}}getHttpsProxy(){return this.get("HTTPS_PROXY")||this.get("https_proxy")||this.get("httpsProxy")||this.get("PROXY_URL")}has(e){return this.config[e]!==void 0}set(e,t){this.config[e]=t}reload(){this.config={},this.loadConfig()}getConfigSummary(){let e=[];return this.options.initialConfig&&e.push("Initial Config"),this.options.useJsonFile&&this.options.jsonPath&&e.push(`JSON: ${this.options.jsonPath}`),this.options.useEnvFile&&e.push(`ENV: ${this.options.envPath}`),this.options.useEnvironmentVariables&&e.push("Environment Variables"),`Config sources: ${e.join(", ")}`}};function nt(r,e=500,t="internal_error",n="api_error"){let o=new Error(r);return o.statusCode=e,o.code=t,o.type=n,o}async function Jf(r,e,t){e.log.error(r);let n=r.statusCode||500,o={error:{message:r.message+r.stack||"Internal Server Error",type:r.type||"api_error",code:r.code||"internal_error"}};return t.code(n).send(o)}var zf=require("undici");function Vf(r,e,t,n,o){let i=new Headers({"Content-Type":"application/json"});t.headers&&Object.entries(t.headers).forEach(([h,d])=>{d&&i.set(h,d)});let u,f=AbortSignal.timeout(t.TIMEOUT??60*1e3*60);if(t.signal){let h=new AbortController,d=()=>h.abort();t.signal.addEventListener("abort",d),f.addEventListener("abort",d),u=h.signal}else u=f;let c={method:"POST",headers:i,body:JSON.stringify(e),signal:u};return t.httpsProxy&&(c.dispatcher=new zf.ProxyAgent(new URL(t.httpsProxy).toString())),n?.debug({reqId:o.req.id,request:c,headers:Object.fromEntries(i.entries()),requestUrl:typeof r=="string"?r:r.toString(),useProxy:t.httpsProxy},"final request"),fetch(typeof r=="string"?r:r.toString(),c)}var Kf="1.0.51";async function g0(r,e,t,n){let o=r.body,i=r.provider,u=t._server.providerService.getProvider(i);if(!u)throw nt(`Provider '${i}' not found`,404,"provider_not_found");let{requestBody:f,config:c,bypass:h}=await y0(o,u,n,r.headers,{req:r}),d=await C0(f,c,u,t,h,n,{req:r}),p=await b0(f,d,u,n,h,{req:r});return E0(p,e,o)}async function y0(r,e,t,n,o){let i=r,u={},f=!1;if(f=_0(e,t,r),f&&(n instanceof Headers?n.delete("content-length"):delete n["content-length"],u.headers=n),!f&&typeof t.transformRequestOut=="function"){let c=await t.transformRequestOut(i);c.body?(i=c.body,u=c.config||{}):i=c}if(!f&&e.transformer?.use?.length)for(let c of e.transformer.use){if(!c||typeof c.transformRequestIn!="function")continue;let h=await c.transformRequestIn(i,e,o);h.body?(i=h.body,u={...u,...h.config}):i=h}if(!f&&e.transformer?.[r.model]?.use?.length)for(let c of e.transformer[r.model].use)!c||typeof c.transformRequestIn!="function"||(i=await c.transformRequestIn(i,e,o));return{requestBody:i,config:u,bypass:f}}function _0(r,e,t){console.log("[_0] provider:",r?.name,"nativeFormat:",r?.nativeFormat);if(r.nativeFormat)return true;return r.transformer?.use?.length===1&&r.transformer.use[0].name===e.name&&(!r.transformer?.[t.model]?.use.length||r.transformer?.[t.model]?.use.length===1&&r.transformer?.[t.model]?.use[0].name===e.name)}async function C0(r,e,t,n,o,i,u){let f=e.url||new URL(t.baseUrl);if(o&&typeof i.auth=="function"){let d=await i.auth(r,t);if(d.body){r=d.body;let p=e.headers||{};d.config?.headers&&(p={...p,...d.config.headers},delete p.host,delete d.config.headers),e={...e,...d.config,headers:p}}else r=d}let c={Authorization:`Bearer ${t.apiKey}`,...e?.headers||{}};for(let d in c)(c[d]==="undefined"||["authorization","Authorization"].includes(d)&&c[d]?.includes("undefined"))&&delete c[d];let h=await Vf(f,r,{httpsProxy:n._server.configService.getHttpsProxy(),...e,headers:JSON.parse(JSON.stringify(c))},n.log,u);if(!h.ok){let d=await h.text();throw n.log.error(`[provider_response_error] Error from provider(${t.name},${r.model}: ${h.status}): ${d}`),nt(`Error from provider(${t.name},${r.model}: ${h.status}): ${d}`,h.status,"provider_response_error")}return h}async function b0(r,e,t,n,o,i){let u=e;if(!o&&t.transformer?.use?.length)for(let f of Array.from(t.transformer.use).reverse())!f||typeof f.transformResponseOut!="function"||(u=await f.transformResponseOut(u,i));if(!o&&t.transformer?.[r.model]?.use?.length)for(let f of Array.from(t.transformer[r.model].use).reverse())!f||typeof f.transformResponseOut!="function"||(u=await f.transformResponseOut(u,i));return!o&&n.transformResponseIn&&(u=await n.transformResponseIn(u,i)),u}function E0(r,e,t){return r.ok||e.code(r.status),t.stream===!0?(e.header("Content-Type","text/event-stream"),e.header("Cache-Control","no-cache"),e.header("Connection","keep-alive"),e.send(r.body)):r.json()}var Yf=async r=>{r.get("/",async()=>({message:"LLMs API",version:Kf})),r.get("/health",async()=>({status:"ok",timestamp:new Date().toISOString()}));let e=r._server.transformerService.getTransformersWithEndpoint();for(let{transformer:t}of e)t.endPoint&&r.post(t.endPoint,async(n,o)=>g0(n,o,r,t));r.post("/providers",{schema:{body:{type:"object",properties:{id:{type:"string"},name:{type:"string"},type:{type:"string",enum:["openai","anthropic"]},baseUrl:{type:"string"},apiKey:{type:"string"},models:{type:"array",items:{type:"string"}}},required:["id","name","type","baseUrl","apiKey","models"]}}},async(t,n)=>{let{name:o,baseUrl:i,apiKey:u,models:f}=t.body;if(!o?.trim())throw nt("Provider name is required",400,"invalid_request");if(!i||!w0(i))throw nt("Valid base URL is required",400,"invalid_request");if(!u?.trim())throw nt("API key is required",400,"invalid_request");if(!f||!Array.isArray(f)||f.length===0)throw nt("At least one model is required",400,"invalid_request");if(r._server.providerService.getProvider(t.body.name))throw nt(`Provider with name '${t.body.name}' already exists`,400,"provider_exists");return r._server.providerService.registerProvider(t.body)}),r.get("/providers",async()=>r._server.providerService.getProviders()),r.get("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]}}},async t=>{let n=r._server.providerService.getProvider(t.params.id);if(!n)throw nt("Provider not found",404,"provider_not_found");return n}),r.put("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]},body:{type:"object",properties:{name:{type:"string"},type:{type:"string",enum:["openai","anthropic"]},baseUrl:{type:"string"},apiKey:{type:"string"},models:{type:"array",items:{type:"string"}},enabled:{type:"boolean"}}}}},async(t,n)=>{let o=r._server.providerService.updateProvider(t.params.id,t.body);if(!o)throw nt("Provider not found",404,"provider_not_found");return o}),r.delete("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]}}},async t=>{if(!r._server.providerService.deleteProvider(t.params.id))throw nt("Provider not found",404,"provider_not_found");return{message:"Provider deleted successfully"}}),r.patch("/providers/:id/toggle",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]},body:{type:"object",properties:{enabled:{type:"boolean"}},required:["enabled"]}}},async(t,n)=>{if(!r._server.providerService.toggleProvider(t.params.id,t.body.enabled))throw nt("Provider not found",404,"provider_not_found");return{message:`Provider ${t.body.enabled?"enabled":"disabled"} successfully`}})};function w0(r){try{return new URL(r),!0}catch{return!1}}var Eo=class{constructor(e){this.providerService=e}registerProvider(e){return this.providerService.registerProvider(e)}getProviders(){return this.providerService.getProviders()}getProvider(e){return this.providerService.getProvider(e)}updateProvider(e,t){return this.providerService.updateProvider(e,t)}deleteProvider(e){return this.providerService.deleteProvider(e)}toggleProvider(e,t){return this.providerService.toggleProvider(e,t)}resolveRoute(e){let t=this.providerService.resolveModelRoute(e);if(!t)throw new Error(`Model ${e} not found. Available models: ${this.getAvailableModelNames().join(", ")}`);return t}async getAvailableModels(){return{object:"list",data:this.providerService.getAvailableModels().flatMap(t=>t.models.map(n=>({id:n,object:"model",provider:t.provider,created:Math.floor(Date.now()/1e3),owned_by:t.provider})))}}getAvailableModelNames(){return this.providerService.getModelRoutes().map(e=>e.fullModel)}getModelRoutes(){return this.providerService.getModelRoutes()}};var wo=class{constructor(e,t,n){this.configService=e;this.transformerService=t;this.logger=n;this.initializeCustomProviders()}providers=new Map;modelRoutes=new Map;initializeCustomProviders(){let e=this.configService.get("providers");if(e&&Array.isArray(e)){this.initializeFromProvidersArray(e);return}}initializeFromProvidersArray(e){e.forEach(t=>{try{if(!t.name||!t.api_base_url||!t.api_key)return;let n={};t.transformer&&Object.keys(t.transformer).forEach(o=>{o==="use"?Array.isArray(t.transformer.use)&&(n.use=t.transformer.use.map(i=>{if(Array.isArray(i)&&typeof i[0]=="string"){let u=this.transformerService.getTransformer(i[0]);if(u)return new u(i[1])}if(typeof i=="string"){let u=this.transformerService.getTransformer(i);return typeof u=="function"?new u:u}}).filter(i=>typeof i<"u")):Array.isArray(t.transformer[o]?.use)&&(n[o]={use:t.transformer[o].use.map(i=>{if(Array.isArray(i)&&typeof i[0]=="string"){let u=this.transformerService.getTransformer(i[0]);if(u)return new u(i[1])}if(typeof i=="string"){let u=this.transformerService.getTransformer(i);return typeof u=="function"?new u:u}}).filter(i=>typeof i<"u")})}),this.registerProvider({name:t.name,baseUrl:t.api_base_url,apiKey:t.api_key,models:t.models||[],transformer:t.transformer?n:void 0,nativeFormat:t.nativeFormat}),this.logger.info(`${t.name} provider registered`)}catch(n){this.logger.error(`${t.name} provider registered error: ${n}`)}})}registerProvider(e){let t={...e};return this.providers.set(t.name,t),e.models.forEach(n=>{let o=`${t.name},${n}`,i={provider:t.name,model:n,fullModel:o};this.modelRoutes.set(o,i),this.modelRoutes.has(n)||this.modelRoutes.set(n,i)}),t}getProviders(){return Array.from(this.providers.values())}getProvider(e){return this.providers.get(e)}updateProvider(e,t){let n=this.providers.get(e);if(!n)return null;let o={...n,...t,updatedAt:new Date};return this.providers.set(e,o),t.models&&(n.models.forEach(i=>{let u=`${n.id},${i}`;this.modelRoutes.delete(u),this.modelRoutes.delete(i)}),t.models.forEach(i=>{let u=`${n.name},${i}`,f={provider:n.name,model:i,fullModel:u};this.modelRoutes.set(u,f),this.modelRoutes.has(i)||this.modelRoutes.set(i,f)})),o}deleteProvider(e){let t=this.providers.get(e);return t?(t.models.forEach(n=>{let o=`${t.name},${n}`;this.modelRoutes.delete(o),this.modelRoutes.delete(n)}),this.providers.delete(e),!0):!1}toggleProvider(e,t){return!!this.providers.get(e)}resolveModelRoute(e){let t=this.modelRoutes.get(e);if(!t)return null;let n=this.providers.get(t.provider);return n?{provider:n,originalModel:e,targetModel:t.model}:null}getAvailableModelNames(){let e=[];return this.providers.forEach(t=>{t.models.forEach(n=>{e.push(n),e.push(`${t.name},${n}`)})}),e}getModelRoutes(){return Array.from(this.modelRoutes.values())}parseTransformerConfig(e){return e?Array.isArray(e)?e.reduce((t,n)=>{if(Array.isArray(n)){let[o,i={}]=n;t[o]=i}else t[n]={};return t},{}):e:{}}async getAvailableModels(){let e=[];return this.providers.forEach(t=>{t.models.forEach(n=>{e.push({id:n,object:"model",owned_by:t.name,provider:t.name}),e.push({id:`${t.name},${n}`,object:"model",owned_by:t.name,provider:t.name})})}),{object:"list",data:e}}};var Je=[];for(let r=0;r<256;++r)Je.push((r+256).toString(16).slice(1));function Xf(r,e=0){return(Je[r[e+0]]+Je[r[e+1]]+Je[r[e+2]]+Je[r[e+3]]+"-"+Je[r[e+4]]+Je[r[e+5]]+"-"+Je[r[e+6]]+Je[r[e+7]]+"-"+Je[r[e+8]]+Je[r[e+9]]+"-"+Je[r[e+10]]+Je[r[e+11]]+Je[r[e+12]]+Je[r[e+13]]+Je[r[e+14]]+Je[r[e+15]]).toLowerCase()}var Qf=require("crypto"),Do=new Uint8Array(256),Ao=Do.length;function Xa(){return Ao>Do.length-16&&((0,Qf.randomFillSync)(Do),Ao=0),Do.slice(Ao,Ao+=16)}var Zf=require("crypto"),Qa={randomUUID:Zf.randomUUID};function A0(r,e,t){if(Qa.randomUUID&&!e&&!r)return Qa.randomUUID();r=r||{};let n=r.random??r.rng?.()??Xa();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let o=0;o<16;++o)e[t+o]=n[o];return e}return Xf(n)}var zt=A0;var ed=r=>r<=0?"none":r<=1024?"low":r<=8192?"medium":"high";var td=(r,e)=>(r.includes("base64")&&(r=r.split("base64").pop(),r.startsWith(",")&&(r=r.slice(1))),`data:${e};base64,${r}`);var So=class{constructor(e){this.options=e;this.useBearer=this.options?.UseBearer??!1}name="Anthropic";endPoint="/v1/messages";useBearer;logger;async auth(e,t){let n={};return this.useBearer?(n.authorization=`Bearer ${t.apiKey}`,n["x-api-key"]=void 0):(n["x-api-key"]=t.apiKey,n.authorization=void 0),{body:e,config:{headers:n}}}async transformRequestOut(e){let t=[];if(e.system){if(typeof e.system=="string")t.push({role:"system",content:e.system});else if(Array.isArray(e.system)&&e.system.length){let i=e.system.filter(u=>u.type==="text"&&u.text).map(u=>({type:"text",text:u.text,cache_control:u.cache_control}));t.push({role:"system",content:i})}}JSON.parse(JSON.stringify(e.messages||[]))?.forEach(i=>{if(i.role==="user"||i.role==="assistant"){if(typeof i.content=="string"){t.push({role:i.role,content:i.content});return}if(Array.isArray(i.content)){if(i.role==="user"){let u=i.content.filter(c=>c.type==="tool_result"&&c.tool_use_id);u.length&&u.forEach(c=>{let h={role:"tool",content:typeof c.content=="string"?c.content:JSON.stringify(c.content),tool_call_id:c.tool_use_id,cache_control:c.cache_control};t.push(h)});let f=i.content.filter(c=>c.type==="text"&&c.text||c.type==="image"&&c.source);f.length&&t.push({role:"user",content:f.map(c=>c?.type==="image"?{type:"image_url",image_url:{url:c.source?.type==="base64"?td(c.source.data,c.source.media_type):c.source.url},media_type:c.source.media_type}:c)})}else if(i.role==="assistant"){let u={role:"assistant",content:""},f=i.content.filter(d=>d.type==="text"&&d.text);f.length&&(u.content=f.map(d=>d.text).join(`
 `));let c=i.content.filter(d=>d.type==="tool_use"&&d.id);c.length&&(u.tool_calls=c.map(d=>({id:d.id,type:"function",function:{name:d.name,arguments:JSON.stringify(d.input||{})}})));let h=i.content.find(d=>d.type==="thinking"&&d.signature);h&&(u.thinking={content:h.thinking,signature:h.signature}),t.push(u)}return}}});let o={messages:t,model:e.model,max_tokens:e.max_tokens,temperature:e.temperature,stream:e.stream,tools:e.tools?.length?this.convertAnthropicToolsToUnified(e.tools):void 0,tool_choice:e.tool_choice};return e.thinking&&(o.reasoning={effort:ed(e.thinking.budget_tokens),enabled:e.thinking.type==="enabled"}),e.tool_choice&&(e.tool_choice.type==="tool"?o.tool_choice={type:"function",function:{name:e.tool_choice.name}}:o.tool_choice=e.tool_choice.type),o}async transformResponseIn(e,t){if(e.headers.get("Content-Type")?.includes("text/event-stream")){if(!e.body)throw new Error("Stream response body is null");let o=await this.convertOpenAIStreamToAnthropic(e.body,t);return new Response(o,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}else{let o=await e.json(),i=this.convertOpenAIResponseToAnthropic(o,t);return new Response(JSON.stringify(i),{headers:{"Content-Type":"application/json"}})}}convertAnthropicToolsToUnified(e){return e.map(t=>({type:"function",function:{name:t.name,description:t.description||"",parameters:t.input_schema}}))}async convertOpenAIStreamToAnthropic(e,t){return new ReadableStream({start:async o=>{let i=new TextEncoder,u=`msg_${Date.now()}`,f=null,c="unknown",h=!1,d=!1,p=!1,A=new Map,P=new Map,S=0,b=0,_=0,m=!1,T=!1,C=0,w=-1,k=()=>{let U=C;return C++,U},x=U=>{if(!m)try{o.enqueue(U);let Z=new TextDecoder().decode(U);this.logger.debug({reqId:t.req.id,data:Z,type:"send data"})}catch(Z){if(Z instanceof TypeError&&Z.message.includes("Controller is already closed"))m=!0;else throw this.logger.debug({reqId:t.req.id,error:Z.message,type:"send data error"}),Z}},G=()=>{if(!m)try{if(w>=0){let Z={type:"content_block_stop",index:w};x(i.encode(`event: content_block_stop
 data: ${JSON.stringify(Z)}
 
@@ -129,7 +129,7 @@ data: ${JSON.stringify(ye)}
 `))}catch(ue){console.error(ue)}}}}}if(he?.finish_reason&&!m&&!p){if(b===0&&_===0&&console.error("Warning: No content in the stream response!"),w>=0){let J={type:"content_block_stop",index:w};x(i.encode(`event: content_block_stop
 data: ${JSON.stringify(J)}
 
-`)),w=-1}m||(f={type:"message_delta",delta:{stop_reason:{stop:"end_turn",length:"max_tokens",tool_calls:"tool_use",content_filter:"stop_sequence"}[he.finish_reason]||"end_turn",stop_sequence:null},usage:{input_tokens:(ne.usage?.prompt_tokens||0)-(ne.usage?.prompt_tokens_details?.cached_tokens||0),output_tokens:ne.usage?.completion_tokens||0,cache_read_input_tokens:ne.usage?.prompt_tokens_details?.cached_tokens||0}});break}}catch(ne){this.logger?.error(`parseError: ${ne.name} message: ${ne.message} stack: ${ne.stack} data: ${we}`)}}}G()}catch(U){if(!m)try{o.error(U)}catch(Z){console.error(Z)}}finally{if(Y)try{Y.releaseLock()}catch(U){console.error(U)}}},cancel:o=>{this.logger.debug({reqId:t.req.id},`cancle stream: ${o}`)}})}convertOpenAIResponseToAnthropic(e,t){this.logger.debug({reqId:t.req.id,response:e},"Original OpenAI response");try{let n=e.choices[0];if(!n)throw new Error("No choices found in OpenAI response");let o=[];if(n.message.annotations){let u=`srvtoolu_${zt()}`;o.push({type:"server_tool_use",id:u,name:"web_search",input:{query:""}}),o.push({type:"web_search_tool_result",tool_use_id:u,content:n.message.annotations.map(f=>({type:"web_search_result",url:f.url_citation.url,title:f.url_citation.title}))})}n.message.content&&o.push({type:"text",text:n.message.content}),n.message.tool_calls&&n.message.tool_calls.length>0&&n.message.tool_calls.forEach(u=>{let f={};try{let c=u.function.arguments||"{}";typeof c=="object"?f=c:typeof c=="string"&&(f=JSON.parse(c))}catch{f={text:u.function.arguments||""}}o.push({type:"tool_use",id:u.id,name:u.function.name,input:f})}),n.message?.thinking?.content&&o.push({type:"thinking",thinking:n.message.thinking.content,signature:n.message.thinking.signature});let i={id:e.id,type:"message",role:"assistant",model:e.model,content:o,stop_reason:n.finish_reason==="stop"?"end_turn":n.finish_reason==="length"?"max_tokens":n.finish_reason==="tool_calls"?"tool_use":n.finish_reason==="content_filter"?"stop_sequence":"end_turn",stop_sequence:null,usage:{input_tokens:(e.usage?.prompt_tokens||0)-(e.usage?.prompt_tokens_details?.cached_tokens||0),output_tokens:e.usage?.completion_tokens||0,cache_read_input_tokens:e.usage?.prompt_tokens_details?.cached_tokens||0}};return this.logger.debug({reqId:t.req.id,result:i},"Conversion complete, final Anthropic response"),i}catch{throw nt(`Provider error: ${JSON.stringify(e)}`,500,"provider_error")}}};var wn={TYPE_UNSPECIFIED:"TYPE_UNSPECIFIED",STRING:"STRING",NUMBER:"NUMBER",INTEGER:"INTEGER",BOOLEAN:"BOOLEAN",ARRAY:"ARRAY",OBJECT:"OBJECT",NULL:"NULL"};function D0(r,e){r.includes("null")&&(e.nullable=!0);let t=r.filter(n=>n!=="null");if(t.length===1){let n=t[0].toUpperCase();e.type=Object.values(wn).includes(n)?n:wn.TYPE_UNSPECIFIED}else{e.anyOf=[];for(let n of t){let o=n.toUpperCase();e.anyOf.push({type:Object.values(wn).includes(o)?o:wn.TYPE_UNSPECIFIED})}}}function us(r){let e={},t=["items"],n=["anyOf"],o=["properties"];if(r.type&&r.anyOf)throw new Error("type and anyOf cannot be both populated.");let i=r.anyOf;i!=null&&Array.isArray(i)&&i.length==2&&(i[0]&&i[0].type==="null"?(e.nullable=!0,r=i[1]):i[1]&&i[1].type==="null"&&(e.nullable=!0,r=i[0])),r.type&&Array.isArray(r.type)&&D0(r.type,e);for(let[u,f]of Object.entries(r))if(f!=null)if(u=="type"){if(f==="null")throw new Error("type: null can not be the only possible type for the field.");if(Array.isArray(f))continue;let c=f.toUpperCase();e.type=Object.values(wn).includes(c)?c:wn.TYPE_UNSPECIFIED}else if(t.includes(u))e[u]=us(f);else if(n.includes(u)){let c=[];for(let h of f){if(h.type=="null"){e.nullable=!0;continue}c.push(us(h))}e[u]=c}else if(o.includes(u)){let c={};for(let[h,d]of Object.entries(f))c[h]=us(d);e[u]=c}else{if(u==="additionalProperties")continue;e[u]=f}return e}function S0(r){if(r.functionDeclarations)for(let e of r.functionDeclarations)e.parameters&&(Object.keys(e.parameters).includes("$schema")?e.parametersJsonSchema||(e.parametersJsonSchema=e.parameters,delete e.parameters):e.parameters=us(e.parameters)),e.response&&(Object.keys(e.response).includes("$schema")?e.responseJsonSchema||(e.responseJsonSchema=e.response,delete e.response):e.response=us(e.response));return r}function To(r){let e=[],t=r.tools?.filter(c=>c.function.name!=="web_search")?.map(c=>({name:c.function.name,description:c.function.description,parametersJsonSchema:c.function.parameters}));t?.length&&e.push(S0({functionDeclarations:t})),r.tools?.find(c=>c.function.name==="web_search")&&e.push({googleSearch:{}});let o=[],i=r.messages.filter(c=>c.role==="tool");r.messages.filter(c=>c.role!=="tool").forEach(c=>{let h;c.role==="assistant"?h="model":(["user","system"].includes(c.role),h="user");let d=[];if(typeof c.content=="string"){let p={text:c.content};c?.thinking?.signature&&(p.thoughtSignature=c.thinking.signature),d.push(p)}else Array.isArray(c.content)?d.push(...c.content.map(p=>{if(p.type==="text")return{text:p.text||""};if(p.type==="image_url")return p.image_url.url.startsWith("http")?{file_data:{mime_type:p.media_type,file_uri:p.image_url.url}}:{inlineData:{mime_type:p.media_type,data:p.image_url.url?.split(",")?.pop()||p.image_url.url}}})):c.content&&typeof c.content=="object"&&(c.content.text?d.push({text:c.content.text}):d.push({text:JSON.stringify(c.content)}));if(Array.isArray(c.tool_calls)&&d.push(...c.tool_calls.map((p,A)=>({functionCall:{id:p.id||`tool_${Math.random().toString(36).substring(2,15)}`,name:p.function.name,args:JSON.parse(p.function.arguments||"{}")},thoughtSignature:A===0&&c.thinking?.signature?c.thinking?.signature:void 0}))),d.length===0&&d.push({text:""}),o.push({role:h,parts:d}),h==="model"&&c.tool_calls){let p=c.tool_calls.map(A=>{let P=i.find(S=>S.tool_call_id===A.id);return{functionResponse:{name:A?.function?.name,response:{result:P?.content}}}});o.push({role:"user",parts:p})}});let u={};if(r.reasoning&&r.reasoning.effort&&r.reasoning.effort!=="none")if(u.thinkingConfig={includeThoughts:!0},r.model.includes("gemini-3"))u.thinkingConfig.thinkingLevel=r.reasoning.effort;else{let c=r.model.includes("pro")?[128,32768]:[0,24576],h,d=r.reasoning.max_tokens;typeof d<"u"&&(d>=c[0]&&d<=c[1]?h=d:d<c[0]?h=c[0]:d>c[1]&&(h=c[1]),u.thinkingConfig.thinkingBudget=h)}let f={contents:o,tools:e.length?e:void 0,generationConfig:u};if(r.tool_choice){let c={functionCallingConfig:{}};r.tool_choice==="auto"?c.functionCallingConfig.mode="auto":r.tool_choice==="none"?c.functionCallingConfig.mode="none":r.tool_choice==="required"?c.functionCallingConfig.mode="any":r.tool_choice?.function?.name&&(c.functionCallingConfig.mode="any",c.functionCallingConfig.allowedFunctionNames=[r.tool_choice?.function?.name]),f.toolConfig=c}return f}function vo(r){let e=r.contents,t=r.tools,n=r.model,o=r.max_tokens,i=r.temperature,u=r.stream,f=r.tool_choice,c={messages:[],model:n,max_tokens:o,temperature:i,stream:u,tool_choice:f};return Array.isArray(e)&&e.forEach(h=>{typeof h=="string"?c.messages.push({role:"user",content:h}):typeof h.text=="string"?c.messages.push({role:"user",content:h.text||null}):h.role==="user"?c.messages.push({role:"user",content:h?.parts?.map(d=>({type:"text",text:d.text||""}))||[]}):h.role==="model"&&c.messages.push({role:"assistant",content:h?.parts?.map(d=>({type:"text",text:d.text||""}))||[]})}),Array.isArray(t)&&(c.tools=[],t.forEach(h=>{Array.isArray(h.functionDeclarations)&&h.functionDeclarations.forEach(d=>{c.tools.push({type:"function",function:{name:d.name,description:d.description,parameters:d.parameters}})})})),c}async function Ro(r,e,t){if(r.headers.get("Content-Type")?.includes("application/json")){let n=await r.json();t?.debug({response:n},`${e} response:`);let o="",i="",u=n.candidates[0]?.content?.parts||[],f=[];for(let p of u)p.text&&p.thought===!0?o+=p.text:f.push(p);i=u.find(p=>p.thoughtSignature)?.thoughtSignature;let c=f?.filter(p=>p.functionCall)?.map(p=>({id:p.functionCall?.id||`tool_${Math.random().toString(36).substring(2,15)}`,type:"function",function:{name:p.functionCall?.name,arguments:JSON.stringify(p.functionCall?.args||{})}}))||[],h=f?.filter(p=>p.text)?.map(p=>p.text)?.join(`
+`)),w=-1}m||(f={type:"message_delta",delta:{stop_reason:{stop:"end_turn",length:"max_tokens",tool_calls:"tool_use",content_filter:"stop_sequence"}[he.finish_reason]||"end_turn",stop_sequence:null},usage:{input_tokens:(ne.usage?.prompt_tokens||0)-(ne.usage?.prompt_tokens_details?.cached_tokens||0),output_tokens:ne.usage?.completion_tokens||0,cache_read_input_tokens:ne.usage?.prompt_tokens_details?.cached_tokens||0}});break}}catch(ne){this.logger?.error(`parseError: ${ne.name} message: ${ne.message} stack: ${ne.stack} data: ${we}`)}}}G()}catch(U){if(!m)try{o.error(U)}catch(Z){console.error(Z)}}finally{if(Y)try{Y.releaseLock()}catch(U){console.error(U)}}},cancel:o=>{this.logger.debug({reqId:t.req.id},`cancle stream: ${o}`)}})}convertOpenAIResponseToAnthropic(e,t){this.logger.debug({reqId:t.req.id,response:e},"Original OpenAI response");try{let n=e.choices[0];if(!n)throw new Error("No choices found in OpenAI response");let o=[];if(n.message.annotations){let u=`srvtoolu_${zt()}`;o.push({type:"server_tool_use",id:u,name:"web_search",input:{query:""}}),o.push({type:"web_search_tool_result",tool_use_id:u,content:n.message.annotations.map(f=>({type:"web_search_result",url:f.url_citation.url,title:f.url_citation.title}))})}n.message.content&&o.push({type:"text",text:n.message.content}),n.message.tool_calls&&n.message.tool_calls.length>0&&n.message.tool_calls.forEach(u=>{let f={};try{let c=u.function.arguments||"{}";typeof c=="object"?f=c:typeof c=="string"&&(f=JSON.parse(c))}catch{f={text:u.function.arguments||""}}o.push({type:"tool_use",id:u.id,name:u.function.name,input:f})}),n.message?.thinking?.content&&o.push({type:"thinking",thinking:n.message.thinking.content,signature:n.message.thinking.signature});let i={id:e.id,type:"message",role:"assistant",model:e.model,content:o,stop_reason:n.finish_reason==="stop"?"end_turn":n.finish_reason==="length"?"max_tokens":n.finish_reason==="tool_calls"?"tool_use":n.finish_reason==="content_filter"?"stop_sequence":"end_turn",stop_sequence:null,usage:{input_tokens:(e.usage?.prompt_tokens||0)-(e.usage?.prompt_tokens_details?.cached_tokens||0),output_tokens:e.usage?.completion_tokens||0,cache_read_input_tokens:e.usage?.prompt_tokens_details?.cached_tokens||0}};return this.logger.debug({reqId:t.req.id,result:i},"Conversion complete, final Anthropic response"),i}catch{throw nt(`Provider error: ${JSON.stringify(e)}`,500,"provider_error")}}};var wn={TYPE_UNSPECIFIED:"TYPE_UNSPECIFIED",STRING:"STRING",NUMBER:"NUMBER",INTEGER:"INTEGER",BOOLEAN:"BOOLEAN",ARRAY:"ARRAY",OBJECT:"OBJECT",NULL:"NULL"};function D0(r,e){r.includes("null")&&(e.nullable=!0);let t=r.filter(n=>n!=="null");if(t.length===1){let n=t[0].toUpperCase();e.type=Object.values(wn).includes(n)?n:wn.TYPE_UNSPECIFIED}else{e.anyOf=[];for(let n of t){let o=n.toUpperCase();e.anyOf.push({type:Object.values(wn).includes(o)?o:wn.TYPE_UNSPECIFIED})}}}function us(r){let e={},t=["items"],n=["anyOf"],o=["properties"];if(r.type&&r.anyOf)throw new Error("type and anyOf cannot be both populated.");let i=r.anyOf;i!=null&&Array.isArray(i)&&i.length==2&&(i[0]&&i[0].type==="null"?(e.nullable=!0,r=i[1]):i[1]&&i[1].type==="null"&&(e.nullable=!0,r=i[0])),r.type&&Array.isArray(r.type)&&D0(r.type,e);for(let[u,f]of Object.entries(r))if(f!=null)if(u=="type"){if(f==="null")throw new Error("type: null can not be the only possible type for the field.");if(Array.isArray(f))continue;let c=f.toUpperCase();e.type=Object.values(wn).includes(c)?c:wn.TYPE_UNSPECIFIED}else if(t.includes(u))e[u]=us(f);else if(n.includes(u)){let c=[];for(let h of f){if(h.type=="null"){e.nullable=!0;continue}c.push(us(h))}e[u]=c}else if(o.includes(u)){let c={};for(let[h,d]of Object.entries(f))c[h]=us(d);e[u]=c}else{if(u==="additionalProperties")continue;e[u]=f}return e}function S0(r){if(r.functionDeclarations)for(let e of r.functionDeclarations)e.parameters&&(Object.keys(e.parameters).includes("$schema")?e.parametersJsonSchema||(e.parametersJsonSchema=e.parameters,delete e.parameters):e.parameters=us(e.parameters)),e.response&&(Object.keys(e.response).includes("$schema")?e.responseJsonSchema||(e.responseJsonSchema=e.response,delete e.response):e.response=us(e.response));return r}function To(r){let e=[],t=r.tools?.filter(c=>c.function.name!=="web_search")?.map(c=>({name:c.function.name,description:c.function.description,parametersJsonSchema:c.function.parameters}));t?.length&&e.push(S0({functionDeclarations:t})),r.tools?.find(c=>c.function.name==="web_search")&&e.push({googleSearch:{}});let o=[],i=r.messages.filter(c=>c.role==="tool");r.messages.filter(c=>c.role!=="tool").forEach(c=>{let h;c.role==="assistant"?h="model":(["user","system"].includes(c.role),h="user");let d=[];if(typeof c.content=="string"){let p={text:c.content};c?.thinking?.signature&&(p.thoughtSignature=c.thinking.signature),d.push(p)}else Array.isArray(c.content)?d.push(...c.content.map(p=>{if(p.type==="text")return{text:p.text||""};if(p.type==="image_url")return p.image_url.url.startsWith("http")?{file_data:{mime_type:p.media_type,file_uri:p.image_url.url}}:{inlineData:{mime_type:p.media_type,data:p.image_url.url?.split(",")?.pop()||p.image_url.url}}})):c.content&&typeof c.content=="object"&&(c.content.text?d.push({text:c.content.text}):d.push({text:JSON.stringify(c.content)}));if(Array.isArray(c.tool_calls)&&d.push(...c.tool_calls.map((p,A)=>({functionCall:{id:p.id||`tool_${Math.random().toString(36).substring(2,15)}`,name:p.function.name,args:JSON.parse(p.function.arguments||"{}")},thoughtSignature:A===0&&c.thinking?.signature?c.thinking?.signature:void 0}))),d.length===0&&d.push({text:""}),o.push({role:h,parts:d}),h==="model"&&c.tool_calls){let p=c.tool_calls.map(A=>{let P=i.find(S=>S.tool_call_id===A.id);return{functionResponse:{name:A?.function?.name||A?.name||"unknown_tool",response:{result:P?.content}}}});o.push({role:"user",parts:p})}});let u={};if(r.reasoning&&r.reasoning.effort&&r.reasoning.effort!=="none")if(u.thinkingConfig={includeThoughts:!0},r.model.includes("gemini-3"))u.thinkingConfig.thinkingLevel=r.reasoning.effort;else{let c=r.model.includes("pro")?[128,32768]:[0,24576],h,d=r.reasoning.max_tokens;typeof d<"u"&&(d>=c[0]&&d<=c[1]?h=d:d<c[0]?h=c[0]:d>c[1]&&(h=c[1]),u.thinkingConfig.thinkingBudget=h)}let f={contents:o,tools:e.length?e:void 0,generationConfig:u};if(r.tool_choice){let c={functionCallingConfig:{}};r.tool_choice==="auto"?c.functionCallingConfig.mode="auto":r.tool_choice==="none"?c.functionCallingConfig.mode="none":r.tool_choice==="required"?c.functionCallingConfig.mode="any":r.tool_choice?.function?.name&&(c.functionCallingConfig.mode="any",c.functionCallingConfig.allowedFunctionNames=[r.tool_choice?.function?.name]),f.toolConfig=c}return f}function vo(r){let e=r.contents,t=r.tools,n=r.model,o=r.max_tokens,i=r.temperature,u=r.stream,f=r.tool_choice,c={messages:[],model:n,max_tokens:o,temperature:i,stream:u,tool_choice:f};return Array.isArray(e)&&e.forEach(h=>{typeof h=="string"?c.messages.push({role:"user",content:h}):typeof h.text=="string"?c.messages.push({role:"user",content:h.text||null}):h.role==="user"?c.messages.push({role:"user",content:h?.parts?.map(d=>({type:"text",text:d.text||""}))||[]}):h.role==="model"&&c.messages.push({role:"assistant",content:h?.parts?.map(d=>({type:"text",text:d.text||""}))||[]})}),Array.isArray(t)&&(c.tools=[],t.forEach(h=>{Array.isArray(h.functionDeclarations)&&h.functionDeclarations.forEach(d=>{c.tools.push({type:"function",function:{name:d.name,description:d.description,parameters:d.parameters}})})})),c}async function Ro(r,e,t){if(r.headers.get("Content-Type")?.includes("application/json")){let n=await r.json();t?.debug({response:n},`${e} response:`);let o="",i="",u=n.candidates[0]?.content?.parts||[],f=[];for(let p of u)p.text&&p.thought===!0?o+=p.text:f.push(p);i=u.find(p=>p.thoughtSignature)?.thoughtSignature;let c=f?.filter(p=>p.functionCall)?.map(p=>({id:p.functionCall?.id||`tool_${Math.random().toString(36).substring(2,15)}`,type:"function",function:{name:p.functionCall?.name,arguments:JSON.stringify(p.functionCall?.args||{})}}))||[],h=f?.filter(p=>p.text)?.map(p=>p.text)?.join(`
 `)||"",d={id:n.responseId,choices:[{finish_reason:n.candidates[0].finishReason?.toLowerCase()||null,index:0,message:{content:h,role:"assistant",tool_calls:c.length>0?c:void 0,...i&&{thinking:{content:o||"(no content)",signature:i}}}}],created:parseInt(new Date().getTime()/1e3+"",10),model:n.modelVersion,object:"chat.completion",usage:{completion_tokens:n.usageMetadata?.candidatesTokenCount||0,prompt_tokens:n.usageMetadata?.promptTokenCount||0,prompt_tokens_details:{cached_tokens:n.usageMetadata?.cachedContentTokenCount||0},total_tokens:n.usageMetadata?.totalTokenCount||0,output_tokens_details:{reasoning_tokens:n.usageMetadata?.thoughtsTokenCount||0}}};return new Response(JSON.stringify(d),{status:r.status,statusText:r.statusText,headers:r.headers})}else if(r.headers.get("Content-Type")?.includes("stream")){if(!r.body)return r;let n=new TextDecoder,o=new TextEncoder,i=!1,u=!1,f=!1,c="",h=0,d=-1,p=new ReadableStream({async start(A){let P=async(_,m)=>{if(_.startsWith("data: ")){let T=_.slice(6).trim();if(T){t?.debug({chunkStr:T},`${e} chunk:`);try{let C=JSON.parse(T);if(!C.candidates||!C.candidates[0]){t?.debug({chunkStr:T},"Invalid chunk structure");return}let w=C.candidates[0],k=w.content?.parts||[];k.filter(U=>U.text&&U.thought===!0).forEach(U=>{f||(f=!0);let Z={choices:[{delta:{role:"assistant",content:null,thinking:{content:U.text}},finish_reason:null,index:h,logprobs:null}],created:parseInt(new Date().getTime()/1e3+"",10),id:C.responseId||"",model:C.modelVersion||"",object:"chat.completion.chunk",system_fingerprint:"fp_a49d71b8a1"};m.enqueue(o.encode(`data: ${JSON.stringify(Z)}
 
 `))});let x=k.find(U=>U.thoughtSignature)?.thoughtSignature;if(x&&!i){if(!f){let Z={choices:[{delta:{role:"assistant",content:null,thinking:{content:"(no content)"}},finish_reason:null,index:h,logprobs:null}],created:parseInt(new Date().getTime()/1e3+"",10),id:C.responseId||"",model:C.modelVersion||"",object:"chat.completion.chunk",system_fingerprint:"fp_a49d71b8a1"};m.enqueue(o.encode(`data: ${JSON.stringify(Z)}
@@ -321,7 +321,7 @@ ${o.content}`),delete o.thinking)});let n=e.messages[e.messages.length-1];return
 `))}c.close()}}});return new Response(f,{status:e.status,statusText:e.statusText,headers:{"Content-Type":e.headers.get("Content-Type")||"text/plain","Cache-Control":"no-cache",Connection:"keep-alive"}})}return e}};var yg={AnthropicTransformer:So,GeminiTransformer:ko,VertexGeminiTransformer:Ji,VertexClaudeTransformer:sa,DeepseekTransformer:zi,TooluseTransformer:Vi,OpenrouterTransformer:Ki,OpenAITransformer:aa,MaxTokenTransformer:Yi,GroqTransformer:Xi,CleancacheTransformer:Qi,EnhanceToolTransformer:ea,ReasoningTransformer:ta,SamplingTransformer:ra,MaxCompletionTokens:na,CerebrasTransformer:oa,StreamOptionsTransformer:ia,CustomParamsTransformer:ua,VercelTransformer:ca,OpenAIResponsesTransformer:la,ForceReasoningTransformer:fa};var da=class{constructor(e,t){this.configService=e;this.logger=t}transformers=new Map;registerTransformer(e,t){this.transformers.set(e,t),this.logger.info(`register transformer: ${e}${t.endPoint?` (endpoint: ${t.endPoint})`:" (no endpoint)"}`)}getTransformer(e){return this.transformers.get(e)}getAllTransformers(){return new Map(this.transformers)}getTransformersWithEndpoint(){let e=[];return this.transformers.forEach((t,n)=>{t.endPoint&&e.push({name:n,transformer:t})}),e}getTransformersWithoutEndpoint(){let e=[];return this.transformers.forEach((t,n)=>{t.endPoint||e.push({name:n,transformer:t})}),e}removeTransformer(e){return this.transformers.delete(e)}hasTransformer(e){return this.transformers.has(e)}async registerTransformerFromConfig(e){try{if(e.path){let t=require(require.resolve(e.path));if(t){let n=new t(e.options);if(n&&typeof n=="object"&&(n.logger=this.logger),!n.name)throw new Error(`Transformer instance from ${e.path} does not have a name property.`);return this.registerTransformer(n.name,n),!0}}return!1}catch(t){return this.logger.error(`load transformer (${e.path}) 
 error: ${t.message}
 stack: ${t.stack}`),!1}}async initialize(){try{await this.registerDefaultTransformersInternal(),await this.loadFromConfig()}catch(e){this.logger.error(`TransformerService init error: ${e.message}
-Stack: ${e.stack}`)}}async registerDefaultTransformersInternal(){try{Object.values(yg).forEach(e=>{if("TransformerName"in e&&typeof e.TransformerName=="string")this.registerTransformer(e.TransformerName,e);else{let t=new e;t&&typeof t=="object"&&(t.logger=this.logger),this.registerTransformer(t.name,t)}})}catch(e){this.logger.error({error:e},"transformer regist error:")}}async loadFromConfig(){let e=this.configService.get("transformers",[]);for(let t of e)await this.registerTransformerFromConfig(t)}};function tA(r={}){let e=(0,_g.default)({bodyLimit:52428800,...r});return e.setErrorHandler(Jf),e.register(Cg.default),e}var kl=class{app;configService;llmService;providerService;transformerService;constructor(e={}){let{initialConfig:t,...n}=e;this.app=tA({...n,logger:n.logger??!0}),this.configService=new bo(e),this.transformerService=new da(this.configService,this.app.log),this.transformerService.initialize().finally(()=>{this.providerService=new wo(this.configService,this.transformerService,this.app.log),this.llmService=new Eo(this.providerService)})}async register(e,t){await this.app.register(e,t)}addHook(e,t){this.app.addHook(e,t)}async start(){try{this.app._server=this,this.app.addHook("preHandler",(n,o,i)=>{n.url.startsWith("/v1/messages")&&n.body&&(n.log.info({data:n.body,type:"request body"}),n.body.stream,n.body.stream||(n.body.stream=!1)),i()}),this.app.addHook("preHandler",async(n,o)=>{if(!(n.url.startsWith("/api")||n.method!=="POST"))try{let i=n.body;if(!i||!i.model)return o.code(400).send({error:"Missing model in request body"});let[u,...f]=i.model.split(",");i.model=f.join(","),n.provider=u;return}catch(i){return n.log.error("Error in modelProviderMiddleware:",i),o.code(500).send({error:"Internal server error"})}}),this.app.register(Yf);let e=await this.app.listen({port:parseInt(this.configService.get("PORT")||"3000",10),host:this.configService.get("HOST")||"127.0.0.1"});this.app.log.info(`\u{1F680} LLMs API server listening on ${e}`);let t=async n=>{this.app.log.info(`Received ${n}, shutting down gracefully...`),await this.app.close(),process.exit(0)};process.on("SIGINT",()=>t("SIGINT")),process.on("SIGTERM",()=>t("SIGTERM"))}catch(e){this.app.log.error(`Error starting server: ${e}`),process.exit(1)}}},rA=kl;
+Stack: ${e.stack}`)}}async registerDefaultTransformersInternal(){try{Object.values(yg).forEach(e=>{if("TransformerName"in e&&typeof e.TransformerName=="string")this.registerTransformer(e.TransformerName,e);else{let t=new e;t&&typeof t=="object"&&(t.logger=this.logger),this.registerTransformer(t.name,t)}})}catch(e){this.logger.error({error:e},"transformer regist error:")}}async loadFromConfig(){let e=this.configService.get("transformers",[]);for(let t of e)await this.registerTransformerFromConfig(t)}};function tA(r={}){let e=(0,_g.default)({bodyLimit:52428800,...r});return e.setErrorHandler(Jf),e.register(Cg.default),e}var kl=class{app;configService;llmService;providerService;transformerService;constructor(e={}){let{initialConfig:t,...n}=e;this.app=tA({...n,logger:n.logger??!0}),this.configService=new bo(e),this.transformerService=new da(this.configService,this.app.log),this.transformerService.initialize().finally(()=>{this.providerService=new wo(this.configService,this.transformerService,this.app.log),this.llmService=new Eo(this.providerService)})}async register(e,t){await this.app.register(e,t)}addHook(e,t){this.app.addHook(e,t)}async start(){try{this.app._server=this,this.app.addHook("preHandler",(n,o,i)=>{n.url.startsWith("/v1/messages")&&n.body&&(n.log.info({data:n.body,type:"request body"}),n.body.stream,n.body.stream||(n.body.stream=!1)),i()}),this.app.addHook("preHandler",async(n,o)=>{if(!(n.url.startsWith("/api")||n.method!=="POST"))try{let i=n.body;if(!i||!i.model)return o.code(400).send({error:"Missing model in request body"});let[u,...f]=i.model.split(",");i.model=f.join(","),n.provider=u;return}catch(i){return n.log.error("Error in modelProviderMiddleware:",i),o.code(500).send({error:"Internal server error"})}}),this.app.register(Yf);let e=await this.app.listen({port:parseInt(this.configService.get("PORT")||"3000",10),host:this.configService.get("HOST")||"127.0.0.1"});this.app.log.info(`\u{1F680} LLMs API server listening on ${e}`);let t=async n=>{this.app.log.info(`Received ${n}, shutting down gracefully...`),await this.app.close(),process.exit(0)};process.on("SIGINT",()=>t("SIGINT")),process.on("SIGTERM",()=>t("SIGTERM"))}catch(e){this.app.log.error(`Error starting server: ${e}`);console.error("STARTUP ERROR:",e);throw e}}},rA=kl;
 /*! Bundled license information:
 
 web-streams-polyfill/dist/ponyfill.es2018.js:
diff --git a/node_modules/@musistudio/llms/dist/esm/server.mjs b/node_modules/@musistudio/llms/dist/esm/server.mjs
index e07a5f7..2540837 100644
--- a/node_modules/@musistudio/llms/dist/esm/server.mjs
+++ b/node_modules/@musistudio/llms/dist/esm/server.mjs
@@ -64,7 +64,7 @@ https://cloud.google.com/docs/authentication/getting-started`,NO_CREDENTIALS_FOU
 To learn more about authentication and Google APIs, visit: 
 https://cloud.google.com/docs/authentication/getting-started`,NO_ADC_FOUND:"Could not load the default credentials. Browse to https://cloud.google.com/docs/authentication/getting-started for more information.",NO_UNIVERSE_DOMAIN_FOUND:`Unable to detect a Universe Domain in the current environment.
 To learn more about Universe Domain retrieval, visit: 
-https://cloud.google.com/compute/docs/metadata/predefined-metadata-keys`};var il=class{checkIsGCE=void 0;useJWTAccessWithScope;defaultServicePath;get isGCE(){return this.checkIsGCE}_findProjectIdPromise;_cachedProjectId;jsonContent=null;apiKey;cachedCredential=null;#e=null;defaultScopes;keyFilename;scopes;clientOptions={};constructor(e={}){if(this._cachedProjectId=e.projectId||null,this.cachedCredential=e.authClient||null,this.keyFilename=e.keyFilename||e.keyFile,this.scopes=e.scopes,this.clientOptions=e.clientOptions||{},this.jsonContent=e.credentials||null,this.apiKey=e.apiKey||this.clientOptions.apiKey||null,this.apiKey&&(this.jsonContent||this.clientOptions.credentials))throw new RangeError(Ht.GoogleAuthExceptionMessages.API_KEY_WITH_CREDENTIALS);e.universeDomain&&(this.clientOptions.universeDomain=e.universeDomain)}setGapicJWTValues(e){e.defaultServicePath=this.defaultServicePath,e.useJWTAccessWithScope=this.useJWTAccessWithScope,e.defaultScopes=this.defaultScopes}getProjectId(e){if(e)this.getProjectIdAsync().then(t=>e(null,t),e);else return this.getProjectIdAsync()}async getProjectIdOptional(){try{return await this.getProjectId()}catch(e){if(e instanceof Error&&e.message===Ht.GoogleAuthExceptionMessages.NO_PROJECT_ID_FOUND)return null;throw e}}async findAndCacheProjectId(){let e=null;if(e||=await this.getProductionProjectId(),e||=await this.getFileProjectId(),e||=await this.getDefaultServiceProjectId(),e||=await this.getGCEProjectId(),e||=await this.getExternalAccountClientProjectId(),e)return this._cachedProjectId=e,e;throw new Error(Ht.GoogleAuthExceptionMessages.NO_PROJECT_ID_FOUND)}async getProjectIdAsync(){return this._cachedProjectId?this._cachedProjectId:(this._findProjectIdPromise||(this._findProjectIdPromise=this.findAndCacheProjectId()),this._findProjectIdPromise)}async getUniverseDomainFromMetadataServer(){let e;try{e=await xs.universe("universe-domain"),e||=ol.DEFAULT_UNIVERSE}catch(t){if(t&&t?.response?.status===404)e=ol.DEFAULT_UNIVERSE;else throw t}return e}async getUniverseDomain(){let e=(0,Jm.originalOrCamelOptions)(this.clientOptions).get("universe_domain");try{e??=(await this.getClient()).universeDomain}catch{e??=ol.DEFAULT_UNIVERSE}return e}getAnyScopes(){return this.scopes||this.defaultScopes}getApplicationDefault(e={},t){let n;if(typeof e=="function"?t=e:n=e,t)this.getApplicationDefaultAsync(n).then(o=>t(null,o.credential,o.projectId),t);else return this.getApplicationDefaultAsync(n)}async getApplicationDefaultAsync(e={}){if(this.cachedCredential)return await this.#t(this.cachedCredential,null);let t;if(t=await this._tryGetApplicationCredentialsFromEnvironmentVariable(e),t)return t instanceof zn.JWT?t.scopes=this.scopes:t instanceof Bs.BaseExternalAccountClient&&(t.scopes=this.getAnyScopes()),await this.#t(t);if(t=await this._tryGetApplicationCredentialsFromWellKnownFile(e),t)return t instanceof zn.JWT?t.scopes=this.scopes:t instanceof Bs.BaseExternalAccountClient&&(t.scopes=this.getAnyScopes()),await this.#t(t);if(await this._checkIsGCE())return e.scopes=this.getAnyScopes(),await this.#t(new Tw.Compute(e));throw new Error(Ht.GoogleAuthExceptionMessages.NO_ADC_FOUND)}async#t(e,t=process.env.GOOGLE_CLOUD_QUOTA_PROJECT||null){let n=await this.getProjectIdOptional();return t&&(e.quotaProjectId=t),this.cachedCredential=e,{credential:e,projectId:n}}async _checkIsGCE(){return this.checkIsGCE===void 0&&(this.checkIsGCE=xs.getGCPResidency()||await xs.isAvailable()),this.checkIsGCE}async _tryGetApplicationCredentialsFromEnvironmentVariable(e){let t=process.env.GOOGLE_APPLICATION_CREDENTIALS||process.env.google_application_credentials;if(!t||t.length===0)return null;try{return this._getApplicationCredentialsFromFilePath(t,e)}catch(n){throw n instanceof Error&&(n.message=`Unable to read the credential file specified by the GOOGLE_APPLICATION_CREDENTIALS environment variable: ${n.message}`),n}}async _tryGetApplicationCredentialsFromWellKnownFile(e){let t=null;if(this._isWindows())t=process.env.APPDATA;else{let o=process.env.HOME;o&&(t=sl.join(o,".config"))}return t&&(t=sl.join(t,"gcloud","application_default_credentials.json"),Ps.existsSync(t)||(t=null)),t?await this._getApplicationCredentialsFromFilePath(t,e):null}async _getApplicationCredentialsFromFilePath(e,t={}){if(!e||e.length===0)throw new Error("The file path is invalid.");try{if(e=Ps.realpathSync(e),!Ps.lstatSync(e).isFile())throw new Error}catch(o){throw o instanceof Error&&(o.message=`The file at ${e} does not exist, or it is not a file. ${o.message}`),o}let n=Ps.createReadStream(e);return this.fromStream(n,t)}fromImpersonatedJSON(e){if(!e)throw new Error("Must pass in a JSON object containing an  impersonated refresh token");if(e.type!==Vn.IMPERSONATED_ACCOUNT_TYPE)throw new Error(`The incoming JSON object does not have the "${Vn.IMPERSONATED_ACCOUNT_TYPE}" type`);if(!e.source_credentials)throw new Error("The incoming JSON object does not contain a source_credentials field");if(!e.service_account_impersonation_url)throw new Error("The incoming JSON object does not contain a service_account_impersonation_url field");let t=this.fromJSON(e.source_credentials);if(e.service_account_impersonation_url?.length>256)throw new RangeError(`Target principal is too long: ${e.service_account_impersonation_url}`);let n=/(?<target>[^/]+):(generateAccessToken|generateIdToken)$/.exec(e.service_account_impersonation_url)?.groups?.target;if(!n)throw new RangeError(`Cannot extract target principal from ${e.service_account_impersonation_url}`);let o=this.getAnyScopes()??[];return new Vn.Impersonated({...e,sourceClient:t,targetPrincipal:n,targetScopes:Array.isArray(o)?o:[o]})}fromJSON(e,t={}){let n,o=(0,Jm.originalOrCamelOptions)(t).get("universe_domain");return e.type===Gm.USER_REFRESH_ACCOUNT_TYPE?(n=new Gm.UserRefreshClient(t),n.fromJSON(e)):e.type===Vn.IMPERSONATED_ACCOUNT_TYPE?n=this.fromImpersonatedJSON(e):e.type===Bs.EXTERNAL_ACCOUNT_TYPE?(n=kw.ExternalAccountClient.fromJSON({...e,...t}),n.scopes=this.getAnyScopes()):e.type===Wm.EXTERNAL_ACCOUNT_AUTHORIZED_USER_TYPE?n=new Wm.ExternalAccountAuthorizedUserClient({...e,...t}):(t.scopes=this.scopes,n=new zn.JWT(t),this.setGapicJWTValues(n),n.fromJSON(e)),o&&(n.universeDomain=o),n}_cacheClientFromJSON(e,t){let n=this.fromJSON(e,t);return this.jsonContent=e,this.cachedCredential=n,n}fromStream(e,t={},n){let o={};if(typeof t=="function"?n=t:o=t,n)this.fromStreamAsync(e,o).then(i=>n(null,i),n);else return this.fromStreamAsync(e,o)}fromStreamAsync(e,t){return new Promise((n,o)=>{if(!e)throw new Error("Must pass in a stream containing the Google auth settings.");let i=[];e.setEncoding("utf8").on("error",o).on("data",u=>i.push(u)).on("end",()=>{try{try{let u=JSON.parse(i.join("")),f=this._cacheClientFromJSON(u,t);return n(f)}catch(u){if(!this.keyFilename)throw u;let f=new zn.JWT({...this.clientOptions,keyFile:this.keyFilename});return this.cachedCredential=f,this.setGapicJWTValues(f),n(f)}}catch(u){return o(u)}})})}fromAPIKey(e,t={}){return new zn.JWT({...t,apiKey:e})}_isWindows(){let e=Dw.platform();return!!(e&&e.length>=3&&e.substring(0,3).toLowerCase()==="win")}async getDefaultServiceProjectId(){return new Promise(e=>{(0,ww.exec)("gcloud config config-helper --format json",(t,n)=>{if(!t&&n)try{let o=JSON.parse(n).configuration.properties.core.project;e(o);return}catch{}e(null)})})}getProductionProjectId(){return process.env.GCLOUD_PROJECT||process.env.GOOGLE_CLOUD_PROJECT||process.env.gcloud_project||process.env.google_cloud_project}async getFileProjectId(){if(this.cachedCredential)return this.cachedCredential.projectId;if(this.keyFilename){let t=await this.getClient();if(t&&t.projectId)return t.projectId}let e=await this._tryGetApplicationCredentialsFromEnvironmentVariable();return e?e.projectId:null}async getExternalAccountClientProjectId(){return!this.jsonContent||this.jsonContent.type!==Bs.EXTERNAL_ACCOUNT_TYPE?null:await(await this.getClient()).getProjectId()}async getGCEProjectId(){try{return await xs.project("project-id")}catch{return null}}getCredentials(e){if(e)this.getCredentialsAsync().then(t=>e(null,t),e);else return this.getCredentialsAsync()}async getCredentialsAsync(){let e=await this.getClient();if(e instanceof Vn.Impersonated)return{client_email:e.getTargetPrincipal()};if(e instanceof Bs.BaseExternalAccountClient){let t=e.getServiceAccountEmail();if(t)return{client_email:t,universe_domain:e.universeDomain}}if(this.jsonContent)return{client_email:this.jsonContent.client_email,private_key:this.jsonContent.private_key,universe_domain:this.jsonContent.universe_domain};if(await this._checkIsGCE()){let[t,n]=await Promise.all([xs.instance("service-accounts/default/email"),this.getUniverseDomain()]);return{client_email:t,universe_domain:n}}throw new Error(Ht.GoogleAuthExceptionMessages.NO_CREDENTIALS_FOUND)}async getClient(){if(this.cachedCredential)return this.cachedCredential;this.#e=this.#e||this.#r();try{return await this.#e}finally{this.#e=null}}async#r(){if(this.jsonContent)return this._cacheClientFromJSON(this.jsonContent,this.clientOptions);if(this.keyFilename){let e=sl.resolve(this.keyFilename),t=Ps.createReadStream(e);return await this.fromStreamAsync(t,this.clientOptions)}else if(this.apiKey){let e=await this.fromAPIKey(this.apiKey,this.clientOptions);e.scopes=this.scopes;let{credential:t}=await this.#t(e);return t}else{let{credential:e}=await this.getApplicationDefaultAsync(this.clientOptions);return e}}async getIdTokenClient(e){let t=await this.getClient();if(!("fetchIdToken"in t))throw new Error("Cannot fetch ID token in this environment, use GCE or set the GOOGLE_APPLICATION_CREDENTIALS environment variable to a service account credentials JSON file.");return new vw.IdTokenClient({targetAudience:e,idTokenProvider:t})}async getAccessToken(){return(await(await this.getClient()).getAccessToken()).token}async getRequestHeaders(e){return(await this.getClient()).getRequestHeaders(e)}async authorizeRequest(e={}){let t=e.url,o=await(await this.getClient()).getRequestHeaders(t);return e.headers=Aw.Gaxios.mergeHeaders(e.headers,o),e}async fetch(...e){return(await this.getClient()).fetch(...e)}async request(e){return(await this.getClient()).request(e)}getEnv(){return(0,Rw.getEnv)()}async sign(e,t){let n=await this.getClient(),o=await this.getUniverseDomain();if(t=t||`https://iamcredentials.${o}/v1/projects/-/serviceAccounts/`,n instanceof Vn.Impersonated)return(await n.sign(e)).signedBlob;let i=(0,Sw.createCrypto)();if(n instanceof zn.JWT&&n.key)return await i.sign(n.key,e);let u=await this.getCredentials();if(!u.client_email)throw new Error("Cannot sign data without `client_email`.");return this.signBlob(i,u.client_email,e,t)}async signBlob(e,t,n,o){let i=new URL(o+`${t}:signBlob`);return(await this.request({method:"POST",url:i.href,data:{payload:e.encodeBase64StringUtf8(n)},retry:!0,retryConfig:{httpMethodsToRetry:["POST"]}})).data.signedBlob}};Ht.GoogleAuth=il});var Vm=z(Mi=>{"use strict";Object.defineProperty(Mi,"__esModule",{value:!0});Mi.IAMAuth=void 0;var al=class{selector;token;constructor(e,t){this.selector=e,this.token=t,this.selector=e,this.token=t}getRequestHeaders(){return{"x-goog-iam-authority-selector":this.selector,"x-goog-iam-authorization-token":this.token}}};Mi.IAMAuth=al});var Km=z(tr=>{"use strict";Object.defineProperty(tr,"__esModule",{value:!0});tr.DownscopedClient=tr.EXPIRATION_TIME_OFFSET=tr.MAX_ACCESS_BOUNDARY_RULES_COUNT=void 0;var Fw=ze(),Ow=Q("stream"),ul=pt(),Pw=Ei(),xw="urn:ietf:params:oauth:grant-type:token-exchange",Bw="urn:ietf:params:oauth:token-type:access_token",Iw="urn:ietf:params:oauth:token-type:access_token";tr.MAX_ACCESS_BOUNDARY_RULES_COUNT=10;tr.EXPIRATION_TIME_OFFSET=5*60*1e3;var cl=class extends ul.AuthClient{authClient;credentialAccessBoundary;cachedDownscopedAccessToken;stsCredential;constructor(e,t={accessBoundary:{accessBoundaryRules:[]}}){if(super(e instanceof ul.AuthClient?{}:e),e instanceof ul.AuthClient?(this.authClient=e,this.credentialAccessBoundary=t):(this.authClient=e.authClient,this.credentialAccessBoundary=e.credentialAccessBoundary),this.credentialAccessBoundary.accessBoundary.accessBoundaryRules.length===0)throw new Error("At least one access boundary rule needs to be defined.");if(this.credentialAccessBoundary.accessBoundary.accessBoundaryRules.length>tr.MAX_ACCESS_BOUNDARY_RULES_COUNT)throw new Error(`The provided access boundary has more than ${tr.MAX_ACCESS_BOUNDARY_RULES_COUNT} access boundary rules.`);for(let n of this.credentialAccessBoundary.accessBoundary.accessBoundaryRules)if(n.availablePermissions.length===0)throw new Error("At least one permission should be defined in access boundary rules.");this.stsCredential=new Pw.StsCredentials({tokenExchangeEndpoint:`https://sts.${this.universeDomain}/v1/token`}),this.cachedDownscopedAccessToken=null}setCredentials(e){if(!e.expiry_date)throw new Error("The access token expiry_date field is missing in the provided credentials.");super.setCredentials(e),this.cachedDownscopedAccessToken=e}async getAccessToken(){return(!this.cachedDownscopedAccessToken||this.isExpired(this.cachedDownscopedAccessToken))&&await this.refreshAccessTokenAsync(),{token:this.cachedDownscopedAccessToken.access_token,expirationTime:this.cachedDownscopedAccessToken.expiry_date,res:this.cachedDownscopedAccessToken.res}}async getRequestHeaders(){let e=await this.getAccessToken(),t=new Headers({authorization:`Bearer ${e.token}`});return this.addSharedMetadataHeaders(t)}request(e,t){if(t)this.requestAsync(e).then(n=>t(null,n),n=>t(n,n.response));else return this.requestAsync(e)}async requestAsync(e,t=!1){let n;try{let o=await this.getRequestHeaders();e.headers=Fw.Gaxios.mergeHeaders(e.headers),this.addUserProjectAndAuthHeaders(e.headers,o),n=await this.transporter.request(e)}catch(o){let i=o.response;if(i){let u=i.status,f=i.config.data instanceof Ow.Readable;if(!t&&(u===401||u===403)&&!f&&this.forceRefreshOnFailure)return await this.refreshAccessTokenAsync(),await this.requestAsync(e,!0)}throw o}return n}async refreshAccessTokenAsync(){let e=(await this.authClient.getAccessToken()).token,t={grantType:xw,requestedTokenType:Bw,subjectToken:e,subjectTokenType:Iw},n=await this.stsCredential.exchangeToken(t,void 0,this.credentialAccessBoundary),o=this.authClient.credentials?.expiry_date||null,i=n.expires_in?new Date().getTime()+n.expires_in*1e3:o;return this.cachedDownscopedAccessToken={access_token:n.access_token,expiry_date:i,res:n.res},this.credentials={},Object.assign(this.credentials,this.cachedDownscopedAccessToken),delete this.credentials.res,this.emit("tokens",{refresh_token:null,expiry_date:this.cachedDownscopedAccessToken.expiry_date,access_token:this.cachedDownscopedAccessToken.access_token,token_type:"Bearer",id_token:null}),this.cachedDownscopedAccessToken}isExpired(e){let t=new Date().getTime();return e.expiry_date?t>=e.expiry_date-this.eagerRefreshThresholdMillis:!1}};tr.DownscopedClient=cl});var Ym=z($i=>{"use strict";Object.defineProperty($i,"__esModule",{value:!0});$i.PassThroughClient=void 0;var Nw=pt(),ll=class extends Nw.AuthClient{async request(e){return this.transporter.request(e)}async getAccessToken(){return{}}async getRequestHeaders(){return new Headers}};$i.PassThroughClient=ll});var dl=z(te=>{"use strict";Object.defineProperty(te,"__esModule",{value:!0});te.GoogleAuth=te.auth=te.PassThroughClient=te.ExecutableError=te.PluggableAuthClient=te.DownscopedClient=te.BaseExternalAccountClient=te.ExternalAccountClient=te.IdentityPoolClient=te.AwsRequestSigner=te.AwsClient=te.UserRefreshClient=te.LoginTicket=te.ClientAuthentication=te.OAuth2Client=te.CodeChallengeMethod=te.Impersonated=te.JWT=te.JWTAccess=te.IdTokenClient=te.IAMAuth=te.GCPEnv=te.Compute=te.DEFAULT_UNIVERSE=te.AuthClient=te.gaxios=te.gcpMetadata=void 0;var Xm=zm();Object.defineProperty(te,"GoogleAuth",{enumerable:!0,get:function(){return Xm.GoogleAuth}});te.gcpMetadata=_s();te.gaxios=ze();var Qm=pt();Object.defineProperty(te,"AuthClient",{enumerable:!0,get:function(){return Qm.AuthClient}});Object.defineProperty(te,"DEFAULT_UNIVERSE",{enumerable:!0,get:function(){return Qm.DEFAULT_UNIVERSE}});var jw=Qu();Object.defineProperty(te,"Compute",{enumerable:!0,get:function(){return jw.Compute}});var qw=tc();Object.defineProperty(te,"GCPEnv",{enumerable:!0,get:function(){return qw.GCPEnv}});var Lw=Vm();Object.defineProperty(te,"IAMAuth",{enumerable:!0,get:function(){return Lw.IAMAuth}});var Uw=ec();Object.defineProperty(te,"IdTokenClient",{enumerable:!0,get:function(){return Uw.IdTokenClient}});var Mw=_c();Object.defineProperty(te,"JWTAccess",{enumerable:!0,get:function(){return Mw.JWTAccess}});var $w=bc();Object.defineProperty(te,"JWT",{enumerable:!0,get:function(){return $w.JWT}});var Hw=Dc();Object.defineProperty(te,"Impersonated",{enumerable:!0,get:function(){return Hw.Impersonated}});var fl=rn();Object.defineProperty(te,"CodeChallengeMethod",{enumerable:!0,get:function(){return fl.CodeChallengeMethod}});Object.defineProperty(te,"OAuth2Client",{enumerable:!0,get:function(){return fl.OAuth2Client}});Object.defineProperty(te,"ClientAuthentication",{enumerable:!0,get:function(){return fl.ClientAuthentication}});var Gw=Vu();Object.defineProperty(te,"LoginTicket",{enumerable:!0,get:function(){return Gw.LoginTicket}});var Ww=wc();Object.defineProperty(te,"UserRefreshClient",{enumerable:!0,get:function(){return Ww.UserRefreshClient}});var Jw=Hc();Object.defineProperty(te,"AwsClient",{enumerable:!0,get:function(){return Jw.AwsClient}});var zw=Uc();Object.defineProperty(te,"AwsRequestSigner",{enumerable:!0,get:function(){return zw.AwsRequestSigner}});var Vw=qc();Object.defineProperty(te,"IdentityPoolClient",{enumerable:!0,get:function(){return Vw.IdentityPoolClient}});var Kw=tl();Object.defineProperty(te,"ExternalAccountClient",{enumerable:!0,get:function(){return Kw.ExternalAccountClient}});var Yw=Ir();Object.defineProperty(te,"BaseExternalAccountClient",{enumerable:!0,get:function(){return Yw.BaseExternalAccountClient}});var Xw=Km();Object.defineProperty(te,"DownscopedClient",{enumerable:!0,get:function(){return Xw.DownscopedClient}});var Zm=Zc();Object.defineProperty(te,"PluggableAuthClient",{enumerable:!0,get:function(){return Zm.PluggableAuthClient}});Object.defineProperty(te,"ExecutableError",{enumerable:!0,get:function(){return Zm.ExecutableError}});var Qw=Ym();Object.defineProperty(te,"PassThroughClient",{enumerable:!0,get:function(){return Qw.PassThroughClient}});var Zw=new Xm.GoogleAuth;te.auth=Zw});import aA from"fastify";import uA from"@fastify/cors";var $f=Jr(Ja(),1);import{readFileSync as a0,existsSync as Uf}from"fs";import{join as Mf}from"path";import{config as u0}from"dotenv";var mo=class{config={};options;constructor(e={jsonPath:"./config.json"}){this.options={envPath:e.envPath||".env",jsonPath:e.jsonPath,useEnvFile:!1,useJsonFile:e.useJsonFile!==!1,useEnvironmentVariables:e.useEnvironmentVariables!==!1,...e},this.loadConfig()}loadConfig(){this.options.useJsonFile&&this.options.jsonPath&&this.loadJsonConfig(),this.options.initialConfig&&(this.config={...this.config,...this.options.initialConfig}),this.options.useEnvFile&&this.loadEnvConfig(),this.config.LOG_FILE&&(process.env.LOG_FILE=this.config.LOG_FILE),this.config.LOG&&(process.env.LOG=this.config.LOG)}loadJsonConfig(){if(!this.options.jsonPath)return;let e=this.isAbsolutePath(this.options.jsonPath)?this.options.jsonPath:Mf(process.cwd(),this.options.jsonPath);if(Uf(e))try{let t=a0(e,"utf-8"),n=$f.default.parse(t);this.config={...this.config,...n},console.log(`Loaded JSON config from: ${e}`)}catch(t){console.warn(`Failed to load JSON config from ${e}:`,t)}else console.warn(`JSON config file not found: ${e}`)}loadEnvConfig(){let e=this.isAbsolutePath(this.options.envPath)?this.options.envPath:Mf(process.cwd(),this.options.envPath);if(Uf(e))try{let t=u0({path:e});t.parsed&&(this.config={...this.config,...this.parseEnvConfig(t.parsed)})}catch(t){console.warn(`Failed to load .env config from ${e}:`,t)}}loadEnvironmentVariables(){let e=this.parseEnvConfig(process.env);this.config={...this.config,...e}}parseEnvConfig(e){let t={};return Object.assign(t,e),t}isAbsolutePath(e){return e.startsWith("/")||e.includes(":")}get(e,t){let n=this.config[e];return n!==void 0?n:t}getAll(){return{...this.config}}getHttpsProxy(){return this.get("HTTPS_PROXY")||this.get("https_proxy")||this.get("httpsProxy")||this.get("PROXY_URL")}has(e){return this.config[e]!==void 0}set(e,t){this.config[e]=t}reload(){this.config={},this.loadConfig()}getConfigSummary(){let e=[];return this.options.initialConfig&&e.push("Initial Config"),this.options.useJsonFile&&this.options.jsonPath&&e.push(`JSON: ${this.options.jsonPath}`),this.options.useEnvFile&&e.push(`ENV: ${this.options.envPath}`),this.options.useEnvironmentVariables&&e.push("Environment Variables"),`Config sources: ${e.join(", ")}`}};function nt(r,e=500,t="internal_error",n="api_error"){let o=new Error(r);return o.statusCode=e,o.code=t,o.type=n,o}async function Hf(r,e,t){e.log.error(r);let n=r.statusCode||500,o={error:{message:r.message+r.stack||"Internal Server Error",type:r.type||"api_error",code:r.code||"internal_error"}};return t.code(n).send(o)}import{ProxyAgent as c0}from"undici";function Gf(r,e,t,n,o){let i=new Headers({"Content-Type":"application/json"});t.headers&&Object.entries(t.headers).forEach(([h,d])=>{d&&i.set(h,d)});let u,f=AbortSignal.timeout(t.TIMEOUT??60*1e3*60);if(t.signal){let h=new AbortController,d=()=>h.abort();t.signal.addEventListener("abort",d),f.addEventListener("abort",d),u=h.signal}else u=f;let c={method:"POST",headers:i,body:JSON.stringify(e),signal:u};return t.httpsProxy&&(c.dispatcher=new c0(new URL(t.httpsProxy).toString())),n?.debug({reqId:o.req.id,request:c,headers:Object.fromEntries(i.entries()),requestUrl:typeof r=="string"?r:r.toString(),useProxy:t.httpsProxy},"final request"),fetch(typeof r=="string"?r:r.toString(),c)}var Wf="1.0.51";async function f0(r,e,t,n){let o=r.body,i=r.provider,u=t._server.providerService.getProvider(i);if(!u)throw nt(`Provider '${i}' not found`,404,"provider_not_found");let{requestBody:f,config:c,bypass:h}=await d0(o,u,n,r.headers,{req:r}),d=await p0(f,c,u,t,h,n,{req:r}),p=await m0(f,d,u,n,h,{req:r});return g0(p,e,o)}async function d0(r,e,t,n,o){let i=r,u={},f=!1;if(f=h0(e,t,r),f&&(n instanceof Headers?n.delete("content-length"):delete n["content-length"],u.headers=n),!f&&typeof t.transformRequestOut=="function"){let c=await t.transformRequestOut(i);c.body?(i=c.body,u=c.config||{}):i=c}if(!f&&e.transformer?.use?.length)for(let c of e.transformer.use){if(!c||typeof c.transformRequestIn!="function")continue;let h=await c.transformRequestIn(i,e,o);h.body?(i=h.body,u={...u,...h.config}):i=h}if(!f&&e.transformer?.[r.model]?.use?.length)for(let c of e.transformer[r.model].use)!c||typeof c.transformRequestIn!="function"||(i=await c.transformRequestIn(i,e,o));return{requestBody:i,config:u,bypass:f}}function h0(r,e,t){return r.transformer?.use?.length===1&&r.transformer.use[0].name===e.name&&(!r.transformer?.[t.model]?.use.length||r.transformer?.[t.model]?.use.length===1&&r.transformer?.[t.model]?.use[0].name===e.name)}async function p0(r,e,t,n,o,i,u){let f=e.url||new URL(t.baseUrl);if(o&&typeof i.auth=="function"){let d=await i.auth(r,t);if(d.body){r=d.body;let p=e.headers||{};d.config?.headers&&(p={...p,...d.config.headers},delete p.host,delete d.config.headers),e={...e,...d.config,headers:p}}else r=d}let c={Authorization:`Bearer ${t.apiKey}`,...e?.headers||{}};for(let d in c)(c[d]==="undefined"||["authorization","Authorization"].includes(d)&&c[d]?.includes("undefined"))&&delete c[d];let h=await Gf(f,r,{httpsProxy:n._server.configService.getHttpsProxy(),...e,headers:JSON.parse(JSON.stringify(c))},n.log,u);if(!h.ok){let d=await h.text();throw n.log.error(`[provider_response_error] Error from provider(${t.name},${r.model}: ${h.status}): ${d}`),nt(`Error from provider(${t.name},${r.model}: ${h.status}): ${d}`,h.status,"provider_response_error")}return h}async function m0(r,e,t,n,o,i){let u=e;if(!o&&t.transformer?.use?.length)for(let f of Array.from(t.transformer.use).reverse())!f||typeof f.transformResponseOut!="function"||(u=await f.transformResponseOut(u,i));if(!o&&t.transformer?.[r.model]?.use?.length)for(let f of Array.from(t.transformer[r.model].use).reverse())!f||typeof f.transformResponseOut!="function"||(u=await f.transformResponseOut(u,i));return!o&&n.transformResponseIn&&(u=await n.transformResponseIn(u,i)),u}function g0(r,e,t){return r.ok||e.code(r.status),t.stream===!0?(e.header("Content-Type","text/event-stream"),e.header("Cache-Control","no-cache"),e.header("Connection","keep-alive"),e.send(r.body)):r.json()}var Jf=async r=>{r.get("/",async()=>({message:"LLMs API",version:Wf})),r.get("/health",async()=>({status:"ok",timestamp:new Date().toISOString()}));let e=r._server.transformerService.getTransformersWithEndpoint();for(let{transformer:t}of e)t.endPoint&&r.post(t.endPoint,async(n,o)=>f0(n,o,r,t));r.post("/providers",{schema:{body:{type:"object",properties:{id:{type:"string"},name:{type:"string"},type:{type:"string",enum:["openai","anthropic"]},baseUrl:{type:"string"},apiKey:{type:"string"},models:{type:"array",items:{type:"string"}}},required:["id","name","type","baseUrl","apiKey","models"]}}},async(t,n)=>{let{name:o,baseUrl:i,apiKey:u,models:f}=t.body;if(!o?.trim())throw nt("Provider name is required",400,"invalid_request");if(!i||!y0(i))throw nt("Valid base URL is required",400,"invalid_request");if(!u?.trim())throw nt("API key is required",400,"invalid_request");if(!f||!Array.isArray(f)||f.length===0)throw nt("At least one model is required",400,"invalid_request");if(r._server.providerService.getProvider(t.body.name))throw nt(`Provider with name '${t.body.name}' already exists`,400,"provider_exists");return r._server.providerService.registerProvider(t.body)}),r.get("/providers",async()=>r._server.providerService.getProviders()),r.get("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]}}},async t=>{let n=r._server.providerService.getProvider(t.params.id);if(!n)throw nt("Provider not found",404,"provider_not_found");return n}),r.put("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]},body:{type:"object",properties:{name:{type:"string"},type:{type:"string",enum:["openai","anthropic"]},baseUrl:{type:"string"},apiKey:{type:"string"},models:{type:"array",items:{type:"string"}},enabled:{type:"boolean"}}}}},async(t,n)=>{let o=r._server.providerService.updateProvider(t.params.id,t.body);if(!o)throw nt("Provider not found",404,"provider_not_found");return o}),r.delete("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]}}},async t=>{if(!r._server.providerService.deleteProvider(t.params.id))throw nt("Provider not found",404,"provider_not_found");return{message:"Provider deleted successfully"}}),r.patch("/providers/:id/toggle",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]},body:{type:"object",properties:{enabled:{type:"boolean"}},required:["enabled"]}}},async(t,n)=>{if(!r._server.providerService.toggleProvider(t.params.id,t.body.enabled))throw nt("Provider not found",404,"provider_not_found");return{message:`Provider ${t.body.enabled?"enabled":"disabled"} successfully`}})};function y0(r){try{return new URL(r),!0}catch{return!1}}var go=class{constructor(e){this.providerService=e}registerProvider(e){return this.providerService.registerProvider(e)}getProviders(){return this.providerService.getProviders()}getProvider(e){return this.providerService.getProvider(e)}updateProvider(e,t){return this.providerService.updateProvider(e,t)}deleteProvider(e){return this.providerService.deleteProvider(e)}toggleProvider(e,t){return this.providerService.toggleProvider(e,t)}resolveRoute(e){let t=this.providerService.resolveModelRoute(e);if(!t)throw new Error(`Model ${e} not found. Available models: ${this.getAvailableModelNames().join(", ")}`);return t}async getAvailableModels(){return{object:"list",data:this.providerService.getAvailableModels().flatMap(t=>t.models.map(n=>({id:n,object:"model",provider:t.provider,created:Math.floor(Date.now()/1e3),owned_by:t.provider})))}}getAvailableModelNames(){return this.providerService.getModelRoutes().map(e=>e.fullModel)}getModelRoutes(){return this.providerService.getModelRoutes()}};var yo=class{constructor(e,t,n){this.configService=e;this.transformerService=t;this.logger=n;this.initializeCustomProviders()}providers=new Map;modelRoutes=new Map;initializeCustomProviders(){let e=this.configService.get("providers");if(e&&Array.isArray(e)){this.initializeFromProvidersArray(e);return}}initializeFromProvidersArray(e){e.forEach(t=>{try{if(!t.name||!t.api_base_url||!t.api_key)return;let n={};t.transformer&&Object.keys(t.transformer).forEach(o=>{o==="use"?Array.isArray(t.transformer.use)&&(n.use=t.transformer.use.map(i=>{if(Array.isArray(i)&&typeof i[0]=="string"){let u=this.transformerService.getTransformer(i[0]);if(u)return new u(i[1])}if(typeof i=="string"){let u=this.transformerService.getTransformer(i);return typeof u=="function"?new u:u}}).filter(i=>typeof i<"u")):Array.isArray(t.transformer[o]?.use)&&(n[o]={use:t.transformer[o].use.map(i=>{if(Array.isArray(i)&&typeof i[0]=="string"){let u=this.transformerService.getTransformer(i[0]);if(u)return new u(i[1])}if(typeof i=="string"){let u=this.transformerService.getTransformer(i);return typeof u=="function"?new u:u}}).filter(i=>typeof i<"u")})}),this.registerProvider({name:t.name,baseUrl:t.api_base_url,apiKey:t.api_key,models:t.models||[],transformer:t.transformer?n:void 0}),this.logger.info(`${t.name} provider registered`)}catch(n){this.logger.error(`${t.name} provider registered error: ${n}`)}})}registerProvider(e){let t={...e};return this.providers.set(t.name,t),e.models.forEach(n=>{let o=`${t.name},${n}`,i={provider:t.name,model:n,fullModel:o};this.modelRoutes.set(o,i),this.modelRoutes.has(n)||this.modelRoutes.set(n,i)}),t}getProviders(){return Array.from(this.providers.values())}getProvider(e){return this.providers.get(e)}updateProvider(e,t){let n=this.providers.get(e);if(!n)return null;let o={...n,...t,updatedAt:new Date};return this.providers.set(e,o),t.models&&(n.models.forEach(i=>{let u=`${n.id},${i}`;this.modelRoutes.delete(u),this.modelRoutes.delete(i)}),t.models.forEach(i=>{let u=`${n.name},${i}`,f={provider:n.name,model:i,fullModel:u};this.modelRoutes.set(u,f),this.modelRoutes.has(i)||this.modelRoutes.set(i,f)})),o}deleteProvider(e){let t=this.providers.get(e);return t?(t.models.forEach(n=>{let o=`${t.name},${n}`;this.modelRoutes.delete(o),this.modelRoutes.delete(n)}),this.providers.delete(e),!0):!1}toggleProvider(e,t){return!!this.providers.get(e)}resolveModelRoute(e){let t=this.modelRoutes.get(e);if(!t)return null;let n=this.providers.get(t.provider);return n?{provider:n,originalModel:e,targetModel:t.model}:null}getAvailableModelNames(){let e=[];return this.providers.forEach(t=>{t.models.forEach(n=>{e.push(n),e.push(`${t.name},${n}`)})}),e}getModelRoutes(){return Array.from(this.modelRoutes.values())}parseTransformerConfig(e){return e?Array.isArray(e)?e.reduce((t,n)=>{if(Array.isArray(n)){let[o,i={}]=n;t[o]=i}else t[n]={};return t},{}):e:{}}async getAvailableModels(){let e=[];return this.providers.forEach(t=>{t.models.forEach(n=>{e.push({id:n,object:"model",owned_by:t.name,provider:t.name}),e.push({id:`${t.name},${n}`,object:"model",owned_by:t.name,provider:t.name})})}),{object:"list",data:e}}};var Je=[];for(let r=0;r<256;++r)Je.push((r+256).toString(16).slice(1));function zf(r,e=0){return(Je[r[e+0]]+Je[r[e+1]]+Je[r[e+2]]+Je[r[e+3]]+"-"+Je[r[e+4]]+Je[r[e+5]]+"-"+Je[r[e+6]]+Je[r[e+7]]+"-"+Je[r[e+8]]+Je[r[e+9]]+"-"+Je[r[e+10]]+Je[r[e+11]]+Je[r[e+12]]+Je[r[e+13]]+Je[r[e+14]]+Je[r[e+15]]).toLowerCase()}import{randomFillSync as _0}from"crypto";var Co=new Uint8Array(256),_o=Co.length;function za(){return _o>Co.length-16&&(_0(Co),_o=0),Co.slice(_o,_o+=16)}import{randomUUID as C0}from"crypto";var Va={randomUUID:C0};function b0(r,e,t){if(Va.randomUUID&&!e&&!r)return Va.randomUUID();r=r||{};let n=r.random??r.rng?.()??za();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let o=0;o<16;++o)e[t+o]=n[o];return e}return zf(n)}var Wt=b0;var Vf=r=>r<=0?"none":r<=1024?"low":r<=8192?"medium":"high";var Kf=(r,e)=>(r.includes("base64")&&(r=r.split("base64").pop(),r.startsWith(",")&&(r=r.slice(1))),`data:${e};base64,${r}`);var bo=class{constructor(e){this.options=e;this.useBearer=this.options?.UseBearer??!1}name="Anthropic";endPoint="/v1/messages";useBearer;logger;async auth(e,t){let n={};return this.useBearer?(n.authorization=`Bearer ${t.apiKey}`,n["x-api-key"]=void 0):(n["x-api-key"]=t.apiKey,n.authorization=void 0),{body:e,config:{headers:n}}}async transformRequestOut(e){let t=[];if(e.system){if(typeof e.system=="string")t.push({role:"system",content:e.system});else if(Array.isArray(e.system)&&e.system.length){let i=e.system.filter(u=>u.type==="text"&&u.text).map(u=>({type:"text",text:u.text,cache_control:u.cache_control}));t.push({role:"system",content:i})}}JSON.parse(JSON.stringify(e.messages||[]))?.forEach(i=>{if(i.role==="user"||i.role==="assistant"){if(typeof i.content=="string"){t.push({role:i.role,content:i.content});return}if(Array.isArray(i.content)){if(i.role==="user"){let u=i.content.filter(c=>c.type==="tool_result"&&c.tool_use_id);u.length&&u.forEach(c=>{let h={role:"tool",content:typeof c.content=="string"?c.content:JSON.stringify(c.content),tool_call_id:c.tool_use_id,cache_control:c.cache_control};t.push(h)});let f=i.content.filter(c=>c.type==="text"&&c.text||c.type==="image"&&c.source);f.length&&t.push({role:"user",content:f.map(c=>c?.type==="image"?{type:"image_url",image_url:{url:c.source?.type==="base64"?Kf(c.source.data,c.source.media_type):c.source.url},media_type:c.source.media_type}:c)})}else if(i.role==="assistant"){let u={role:"assistant",content:""},f=i.content.filter(d=>d.type==="text"&&d.text);f.length&&(u.content=f.map(d=>d.text).join(`
+https://cloud.google.com/compute/docs/metadata/predefined-metadata-keys`};var il=class{checkIsGCE=void 0;useJWTAccessWithScope;defaultServicePath;get isGCE(){return this.checkIsGCE}_findProjectIdPromise;_cachedProjectId;jsonContent=null;apiKey;cachedCredential=null;#e=null;defaultScopes;keyFilename;scopes;clientOptions={};constructor(e={}){if(this._cachedProjectId=e.projectId||null,this.cachedCredential=e.authClient||null,this.keyFilename=e.keyFilename||e.keyFile,this.scopes=e.scopes,this.clientOptions=e.clientOptions||{},this.jsonContent=e.credentials||null,this.apiKey=e.apiKey||this.clientOptions.apiKey||null,this.apiKey&&(this.jsonContent||this.clientOptions.credentials))throw new RangeError(Ht.GoogleAuthExceptionMessages.API_KEY_WITH_CREDENTIALS);e.universeDomain&&(this.clientOptions.universeDomain=e.universeDomain)}setGapicJWTValues(e){e.defaultServicePath=this.defaultServicePath,e.useJWTAccessWithScope=this.useJWTAccessWithScope,e.defaultScopes=this.defaultScopes}getProjectId(e){if(e)this.getProjectIdAsync().then(t=>e(null,t),e);else return this.getProjectIdAsync()}async getProjectIdOptional(){try{return await this.getProjectId()}catch(e){if(e instanceof Error&&e.message===Ht.GoogleAuthExceptionMessages.NO_PROJECT_ID_FOUND)return null;throw e}}async findAndCacheProjectId(){let e=null;if(e||=await this.getProductionProjectId(),e||=await this.getFileProjectId(),e||=await this.getDefaultServiceProjectId(),e||=await this.getGCEProjectId(),e||=await this.getExternalAccountClientProjectId(),e)return this._cachedProjectId=e,e;throw new Error(Ht.GoogleAuthExceptionMessages.NO_PROJECT_ID_FOUND)}async getProjectIdAsync(){return this._cachedProjectId?this._cachedProjectId:(this._findProjectIdPromise||(this._findProjectIdPromise=this.findAndCacheProjectId()),this._findProjectIdPromise)}async getUniverseDomainFromMetadataServer(){let e;try{e=await xs.universe("universe-domain"),e||=ol.DEFAULT_UNIVERSE}catch(t){if(t&&t?.response?.status===404)e=ol.DEFAULT_UNIVERSE;else throw t}return e}async getUniverseDomain(){let e=(0,Jm.originalOrCamelOptions)(this.clientOptions).get("universe_domain");try{e??=(await this.getClient()).universeDomain}catch{e??=ol.DEFAULT_UNIVERSE}return e}getAnyScopes(){return this.scopes||this.defaultScopes}getApplicationDefault(e={},t){let n;if(typeof e=="function"?t=e:n=e,t)this.getApplicationDefaultAsync(n).then(o=>t(null,o.credential,o.projectId),t);else return this.getApplicationDefaultAsync(n)}async getApplicationDefaultAsync(e={}){if(this.cachedCredential)return await this.#t(this.cachedCredential,null);let t;if(t=await this._tryGetApplicationCredentialsFromEnvironmentVariable(e),t)return t instanceof zn.JWT?t.scopes=this.scopes:t instanceof Bs.BaseExternalAccountClient&&(t.scopes=this.getAnyScopes()),await this.#t(t);if(t=await this._tryGetApplicationCredentialsFromWellKnownFile(e),t)return t instanceof zn.JWT?t.scopes=this.scopes:t instanceof Bs.BaseExternalAccountClient&&(t.scopes=this.getAnyScopes()),await this.#t(t);if(await this._checkIsGCE())return e.scopes=this.getAnyScopes(),await this.#t(new Tw.Compute(e));throw new Error(Ht.GoogleAuthExceptionMessages.NO_ADC_FOUND)}async#t(e,t=process.env.GOOGLE_CLOUD_QUOTA_PROJECT||null){let n=await this.getProjectIdOptional();return t&&(e.quotaProjectId=t),this.cachedCredential=e,{credential:e,projectId:n}}async _checkIsGCE(){return this.checkIsGCE===void 0&&(this.checkIsGCE=xs.getGCPResidency()||await xs.isAvailable()),this.checkIsGCE}async _tryGetApplicationCredentialsFromEnvironmentVariable(e){let t=process.env.GOOGLE_APPLICATION_CREDENTIALS||process.env.google_application_credentials;if(!t||t.length===0)return null;try{return this._getApplicationCredentialsFromFilePath(t,e)}catch(n){throw n instanceof Error&&(n.message=`Unable to read the credential file specified by the GOOGLE_APPLICATION_CREDENTIALS environment variable: ${n.message}`),n}}async _tryGetApplicationCredentialsFromWellKnownFile(e){let t=null;if(this._isWindows())t=process.env.APPDATA;else{let o=process.env.HOME;o&&(t=sl.join(o,".config"))}return t&&(t=sl.join(t,"gcloud","application_default_credentials.json"),Ps.existsSync(t)||(t=null)),t?await this._getApplicationCredentialsFromFilePath(t,e):null}async _getApplicationCredentialsFromFilePath(e,t={}){if(!e||e.length===0)throw new Error("The file path is invalid.");try{if(e=Ps.realpathSync(e),!Ps.lstatSync(e).isFile())throw new Error}catch(o){throw o instanceof Error&&(o.message=`The file at ${e} does not exist, or it is not a file. ${o.message}`),o}let n=Ps.createReadStream(e);return this.fromStream(n,t)}fromImpersonatedJSON(e){if(!e)throw new Error("Must pass in a JSON object containing an  impersonated refresh token");if(e.type!==Vn.IMPERSONATED_ACCOUNT_TYPE)throw new Error(`The incoming JSON object does not have the "${Vn.IMPERSONATED_ACCOUNT_TYPE}" type`);if(!e.source_credentials)throw new Error("The incoming JSON object does not contain a source_credentials field");if(!e.service_account_impersonation_url)throw new Error("The incoming JSON object does not contain a service_account_impersonation_url field");let t=this.fromJSON(e.source_credentials);if(e.service_account_impersonation_url?.length>256)throw new RangeError(`Target principal is too long: ${e.service_account_impersonation_url}`);let n=/(?<target>[^/]+):(generateAccessToken|generateIdToken)$/.exec(e.service_account_impersonation_url)?.groups?.target;if(!n)throw new RangeError(`Cannot extract target principal from ${e.service_account_impersonation_url}`);let o=this.getAnyScopes()??[];return new Vn.Impersonated({...e,sourceClient:t,targetPrincipal:n,targetScopes:Array.isArray(o)?o:[o]})}fromJSON(e,t={}){let n,o=(0,Jm.originalOrCamelOptions)(t).get("universe_domain");return e.type===Gm.USER_REFRESH_ACCOUNT_TYPE?(n=new Gm.UserRefreshClient(t),n.fromJSON(e)):e.type===Vn.IMPERSONATED_ACCOUNT_TYPE?n=this.fromImpersonatedJSON(e):e.type===Bs.EXTERNAL_ACCOUNT_TYPE?(n=kw.ExternalAccountClient.fromJSON({...e,...t}),n.scopes=this.getAnyScopes()):e.type===Wm.EXTERNAL_ACCOUNT_AUTHORIZED_USER_TYPE?n=new Wm.ExternalAccountAuthorizedUserClient({...e,...t}):(t.scopes=this.scopes,n=new zn.JWT(t),this.setGapicJWTValues(n),n.fromJSON(e)),o&&(n.universeDomain=o),n}_cacheClientFromJSON(e,t){let n=this.fromJSON(e,t);return this.jsonContent=e,this.cachedCredential=n,n}fromStream(e,t={},n){let o={};if(typeof t=="function"?n=t:o=t,n)this.fromStreamAsync(e,o).then(i=>n(null,i),n);else return this.fromStreamAsync(e,o)}fromStreamAsync(e,t){return new Promise((n,o)=>{if(!e)throw new Error("Must pass in a stream containing the Google auth settings.");let i=[];e.setEncoding("utf8").on("error",o).on("data",u=>i.push(u)).on("end",()=>{try{try{let u=JSON.parse(i.join("")),f=this._cacheClientFromJSON(u,t);return n(f)}catch(u){if(!this.keyFilename)throw u;let f=new zn.JWT({...this.clientOptions,keyFile:this.keyFilename});return this.cachedCredential=f,this.setGapicJWTValues(f),n(f)}}catch(u){return o(u)}})})}fromAPIKey(e,t={}){return new zn.JWT({...t,apiKey:e})}_isWindows(){let e=Dw.platform();return!!(e&&e.length>=3&&e.substring(0,3).toLowerCase()==="win")}async getDefaultServiceProjectId(){return new Promise(e=>{(0,ww.exec)("gcloud config config-helper --format json",(t,n)=>{if(!t&&n)try{let o=JSON.parse(n).configuration.properties.core.project;e(o);return}catch{}e(null)})})}getProductionProjectId(){return process.env.GCLOUD_PROJECT||process.env.GOOGLE_CLOUD_PROJECT||process.env.gcloud_project||process.env.google_cloud_project}async getFileProjectId(){if(this.cachedCredential)return this.cachedCredential.projectId;if(this.keyFilename){let t=await this.getClient();if(t&&t.projectId)return t.projectId}let e=await this._tryGetApplicationCredentialsFromEnvironmentVariable();return e?e.projectId:null}async getExternalAccountClientProjectId(){return!this.jsonContent||this.jsonContent.type!==Bs.EXTERNAL_ACCOUNT_TYPE?null:await(await this.getClient()).getProjectId()}async getGCEProjectId(){try{return await xs.project("project-id")}catch{return null}}getCredentials(e){if(e)this.getCredentialsAsync().then(t=>e(null,t),e);else return this.getCredentialsAsync()}async getCredentialsAsync(){let e=await this.getClient();if(e instanceof Vn.Impersonated)return{client_email:e.getTargetPrincipal()};if(e instanceof Bs.BaseExternalAccountClient){let t=e.getServiceAccountEmail();if(t)return{client_email:t,universe_domain:e.universeDomain}}if(this.jsonContent)return{client_email:this.jsonContent.client_email,private_key:this.jsonContent.private_key,universe_domain:this.jsonContent.universe_domain};if(await this._checkIsGCE()){let[t,n]=await Promise.all([xs.instance("service-accounts/default/email"),this.getUniverseDomain()]);return{client_email:t,universe_domain:n}}throw new Error(Ht.GoogleAuthExceptionMessages.NO_CREDENTIALS_FOUND)}async getClient(){if(this.cachedCredential)return this.cachedCredential;this.#e=this.#e||this.#r();try{return await this.#e}finally{this.#e=null}}async#r(){if(this.jsonContent)return this._cacheClientFromJSON(this.jsonContent,this.clientOptions);if(this.keyFilename){let e=sl.resolve(this.keyFilename),t=Ps.createReadStream(e);return await this.fromStreamAsync(t,this.clientOptions)}else if(this.apiKey){let e=await this.fromAPIKey(this.apiKey,this.clientOptions);e.scopes=this.scopes;let{credential:t}=await this.#t(e);return t}else{let{credential:e}=await this.getApplicationDefaultAsync(this.clientOptions);return e}}async getIdTokenClient(e){let t=await this.getClient();if(!("fetchIdToken"in t))throw new Error("Cannot fetch ID token in this environment, use GCE or set the GOOGLE_APPLICATION_CREDENTIALS environment variable to a service account credentials JSON file.");return new vw.IdTokenClient({targetAudience:e,idTokenProvider:t})}async getAccessToken(){return(await(await this.getClient()).getAccessToken()).token}async getRequestHeaders(e){return(await this.getClient()).getRequestHeaders(e)}async authorizeRequest(e={}){let t=e.url,o=await(await this.getClient()).getRequestHeaders(t);return e.headers=Aw.Gaxios.mergeHeaders(e.headers,o),e}async fetch(...e){return(await this.getClient()).fetch(...e)}async request(e){return(await this.getClient()).request(e)}getEnv(){return(0,Rw.getEnv)()}async sign(e,t){let n=await this.getClient(),o=await this.getUniverseDomain();if(t=t||`https://iamcredentials.${o}/v1/projects/-/serviceAccounts/`,n instanceof Vn.Impersonated)return(await n.sign(e)).signedBlob;let i=(0,Sw.createCrypto)();if(n instanceof zn.JWT&&n.key)return await i.sign(n.key,e);let u=await this.getCredentials();if(!u.client_email)throw new Error("Cannot sign data without `client_email`.");return this.signBlob(i,u.client_email,e,t)}async signBlob(e,t,n,o){let i=new URL(o+`${t}:signBlob`);return(await this.request({method:"POST",url:i.href,data:{payload:e.encodeBase64StringUtf8(n)},retry:!0,retryConfig:{httpMethodsToRetry:["POST"]}})).data.signedBlob}};Ht.GoogleAuth=il});var Vm=z(Mi=>{"use strict";Object.defineProperty(Mi,"__esModule",{value:!0});Mi.IAMAuth=void 0;var al=class{selector;token;constructor(e,t){this.selector=e,this.token=t,this.selector=e,this.token=t}getRequestHeaders(){return{"x-goog-iam-authority-selector":this.selector,"x-goog-iam-authorization-token":this.token}}};Mi.IAMAuth=al});var Km=z(tr=>{"use strict";Object.defineProperty(tr,"__esModule",{value:!0});tr.DownscopedClient=tr.EXPIRATION_TIME_OFFSET=tr.MAX_ACCESS_BOUNDARY_RULES_COUNT=void 0;var Fw=ze(),Ow=Q("stream"),ul=pt(),Pw=Ei(),xw="urn:ietf:params:oauth:grant-type:token-exchange",Bw="urn:ietf:params:oauth:token-type:access_token",Iw="urn:ietf:params:oauth:token-type:access_token";tr.MAX_ACCESS_BOUNDARY_RULES_COUNT=10;tr.EXPIRATION_TIME_OFFSET=5*60*1e3;var cl=class extends ul.AuthClient{authClient;credentialAccessBoundary;cachedDownscopedAccessToken;stsCredential;constructor(e,t={accessBoundary:{accessBoundaryRules:[]}}){if(super(e instanceof ul.AuthClient?{}:e),e instanceof ul.AuthClient?(this.authClient=e,this.credentialAccessBoundary=t):(this.authClient=e.authClient,this.credentialAccessBoundary=e.credentialAccessBoundary),this.credentialAccessBoundary.accessBoundary.accessBoundaryRules.length===0)throw new Error("At least one access boundary rule needs to be defined.");if(this.credentialAccessBoundary.accessBoundary.accessBoundaryRules.length>tr.MAX_ACCESS_BOUNDARY_RULES_COUNT)throw new Error(`The provided access boundary has more than ${tr.MAX_ACCESS_BOUNDARY_RULES_COUNT} access boundary rules.`);for(let n of this.credentialAccessBoundary.accessBoundary.accessBoundaryRules)if(n.availablePermissions.length===0)throw new Error("At least one permission should be defined in access boundary rules.");this.stsCredential=new Pw.StsCredentials({tokenExchangeEndpoint:`https://sts.${this.universeDomain}/v1/token`}),this.cachedDownscopedAccessToken=null}setCredentials(e){if(!e.expiry_date)throw new Error("The access token expiry_date field is missing in the provided credentials.");super.setCredentials(e),this.cachedDownscopedAccessToken=e}async getAccessToken(){return(!this.cachedDownscopedAccessToken||this.isExpired(this.cachedDownscopedAccessToken))&&await this.refreshAccessTokenAsync(),{token:this.cachedDownscopedAccessToken.access_token,expirationTime:this.cachedDownscopedAccessToken.expiry_date,res:this.cachedDownscopedAccessToken.res}}async getRequestHeaders(){let e=await this.getAccessToken(),t=new Headers({authorization:`Bearer ${e.token}`});return this.addSharedMetadataHeaders(t)}request(e,t){if(t)this.requestAsync(e).then(n=>t(null,n),n=>t(n,n.response));else return this.requestAsync(e)}async requestAsync(e,t=!1){let n;try{let o=await this.getRequestHeaders();e.headers=Fw.Gaxios.mergeHeaders(e.headers),this.addUserProjectAndAuthHeaders(e.headers,o),n=await this.transporter.request(e)}catch(o){let i=o.response;if(i){let u=i.status,f=i.config.data instanceof Ow.Readable;if(!t&&(u===401||u===403)&&!f&&this.forceRefreshOnFailure)return await this.refreshAccessTokenAsync(),await this.requestAsync(e,!0)}throw o}return n}async refreshAccessTokenAsync(){let e=(await this.authClient.getAccessToken()).token,t={grantType:xw,requestedTokenType:Bw,subjectToken:e,subjectTokenType:Iw},n=await this.stsCredential.exchangeToken(t,void 0,this.credentialAccessBoundary),o=this.authClient.credentials?.expiry_date||null,i=n.expires_in?new Date().getTime()+n.expires_in*1e3:o;return this.cachedDownscopedAccessToken={access_token:n.access_token,expiry_date:i,res:n.res},this.credentials={},Object.assign(this.credentials,this.cachedDownscopedAccessToken),delete this.credentials.res,this.emit("tokens",{refresh_token:null,expiry_date:this.cachedDownscopedAccessToken.expiry_date,access_token:this.cachedDownscopedAccessToken.access_token,token_type:"Bearer",id_token:null}),this.cachedDownscopedAccessToken}isExpired(e){let t=new Date().getTime();return e.expiry_date?t>=e.expiry_date-this.eagerRefreshThresholdMillis:!1}};tr.DownscopedClient=cl});var Ym=z($i=>{"use strict";Object.defineProperty($i,"__esModule",{value:!0});$i.PassThroughClient=void 0;var Nw=pt(),ll=class extends Nw.AuthClient{async request(e){return this.transporter.request(e)}async getAccessToken(){return{}}async getRequestHeaders(){return new Headers}};$i.PassThroughClient=ll});var dl=z(te=>{"use strict";Object.defineProperty(te,"__esModule",{value:!0});te.GoogleAuth=te.auth=te.PassThroughClient=te.ExecutableError=te.PluggableAuthClient=te.DownscopedClient=te.BaseExternalAccountClient=te.ExternalAccountClient=te.IdentityPoolClient=te.AwsRequestSigner=te.AwsClient=te.UserRefreshClient=te.LoginTicket=te.ClientAuthentication=te.OAuth2Client=te.CodeChallengeMethod=te.Impersonated=te.JWT=te.JWTAccess=te.IdTokenClient=te.IAMAuth=te.GCPEnv=te.Compute=te.DEFAULT_UNIVERSE=te.AuthClient=te.gaxios=te.gcpMetadata=void 0;var Xm=zm();Object.defineProperty(te,"GoogleAuth",{enumerable:!0,get:function(){return Xm.GoogleAuth}});te.gcpMetadata=_s();te.gaxios=ze();var Qm=pt();Object.defineProperty(te,"AuthClient",{enumerable:!0,get:function(){return Qm.AuthClient}});Object.defineProperty(te,"DEFAULT_UNIVERSE",{enumerable:!0,get:function(){return Qm.DEFAULT_UNIVERSE}});var jw=Qu();Object.defineProperty(te,"Compute",{enumerable:!0,get:function(){return jw.Compute}});var qw=tc();Object.defineProperty(te,"GCPEnv",{enumerable:!0,get:function(){return qw.GCPEnv}});var Lw=Vm();Object.defineProperty(te,"IAMAuth",{enumerable:!0,get:function(){return Lw.IAMAuth}});var Uw=ec();Object.defineProperty(te,"IdTokenClient",{enumerable:!0,get:function(){return Uw.IdTokenClient}});var Mw=_c();Object.defineProperty(te,"JWTAccess",{enumerable:!0,get:function(){return Mw.JWTAccess}});var $w=bc();Object.defineProperty(te,"JWT",{enumerable:!0,get:function(){return $w.JWT}});var Hw=Dc();Object.defineProperty(te,"Impersonated",{enumerable:!0,get:function(){return Hw.Impersonated}});var fl=rn();Object.defineProperty(te,"CodeChallengeMethod",{enumerable:!0,get:function(){return fl.CodeChallengeMethod}});Object.defineProperty(te,"OAuth2Client",{enumerable:!0,get:function(){return fl.OAuth2Client}});Object.defineProperty(te,"ClientAuthentication",{enumerable:!0,get:function(){return fl.ClientAuthentication}});var Gw=Vu();Object.defineProperty(te,"LoginTicket",{enumerable:!0,get:function(){return Gw.LoginTicket}});var Ww=wc();Object.defineProperty(te,"UserRefreshClient",{enumerable:!0,get:function(){return Ww.UserRefreshClient}});var Jw=Hc();Object.defineProperty(te,"AwsClient",{enumerable:!0,get:function(){return Jw.AwsClient}});var zw=Uc();Object.defineProperty(te,"AwsRequestSigner",{enumerable:!0,get:function(){return zw.AwsRequestSigner}});var Vw=qc();Object.defineProperty(te,"IdentityPoolClient",{enumerable:!0,get:function(){return Vw.IdentityPoolClient}});var Kw=tl();Object.defineProperty(te,"ExternalAccountClient",{enumerable:!0,get:function(){return Kw.ExternalAccountClient}});var Yw=Ir();Object.defineProperty(te,"BaseExternalAccountClient",{enumerable:!0,get:function(){return Yw.BaseExternalAccountClient}});var Xw=Km();Object.defineProperty(te,"DownscopedClient",{enumerable:!0,get:function(){return Xw.DownscopedClient}});var Zm=Zc();Object.defineProperty(te,"PluggableAuthClient",{enumerable:!0,get:function(){return Zm.PluggableAuthClient}});Object.defineProperty(te,"ExecutableError",{enumerable:!0,get:function(){return Zm.ExecutableError}});var Qw=Ym();Object.defineProperty(te,"PassThroughClient",{enumerable:!0,get:function(){return Qw.PassThroughClient}});var Zw=new Xm.GoogleAuth;te.auth=Zw});import aA from"fastify";import uA from"@fastify/cors";var $f=Jr(Ja(),1);import{readFileSync as a0,existsSync as Uf}from"fs";import{join as Mf}from"path";import{config as u0}from"dotenv";var mo=class{config={};options;constructor(e={jsonPath:"./config.json"}){this.options={envPath:e.envPath||".env",jsonPath:e.jsonPath,useEnvFile:!1,useJsonFile:e.useJsonFile!==!1,useEnvironmentVariables:e.useEnvironmentVariables!==!1,...e},this.loadConfig()}loadConfig(){this.options.useJsonFile&&this.options.jsonPath&&this.loadJsonConfig(),this.options.initialConfig&&(this.config={...this.config,...this.options.initialConfig}),this.options.useEnvFile&&this.loadEnvConfig(),this.config.LOG_FILE&&(process.env.LOG_FILE=this.config.LOG_FILE),this.config.LOG&&(process.env.LOG=this.config.LOG)}loadJsonConfig(){if(!this.options.jsonPath)return;let e=this.isAbsolutePath(this.options.jsonPath)?this.options.jsonPath:Mf(process.cwd(),this.options.jsonPath);if(Uf(e))try{let t=a0(e,"utf-8"),n=$f.default.parse(t);this.config={...this.config,...n},console.log(`Loaded JSON config from: ${e}`)}catch(t){console.warn(`Failed to load JSON config from ${e}:`,t)}else console.warn(`JSON config file not found: ${e}`)}loadEnvConfig(){let e=this.isAbsolutePath(this.options.envPath)?this.options.envPath:Mf(process.cwd(),this.options.envPath);if(Uf(e))try{let t=u0({path:e});t.parsed&&(this.config={...this.config,...this.parseEnvConfig(t.parsed)})}catch(t){console.warn(`Failed to load .env config from ${e}:`,t)}}loadEnvironmentVariables(){let e=this.parseEnvConfig(process.env);this.config={...this.config,...e}}parseEnvConfig(e){let t={};return Object.assign(t,e),t}isAbsolutePath(e){return e.startsWith("/")||e.includes(":")}get(e,t){let n=this.config[e];return n!==void 0?n:t}getAll(){return{...this.config}}getHttpsProxy(){return this.get("HTTPS_PROXY")||this.get("https_proxy")||this.get("httpsProxy")||this.get("PROXY_URL")}has(e){return this.config[e]!==void 0}set(e,t){this.config[e]=t}reload(){this.config={},this.loadConfig()}getConfigSummary(){let e=[];return this.options.initialConfig&&e.push("Initial Config"),this.options.useJsonFile&&this.options.jsonPath&&e.push(`JSON: ${this.options.jsonPath}`),this.options.useEnvFile&&e.push(`ENV: ${this.options.envPath}`),this.options.useEnvironmentVariables&&e.push("Environment Variables"),`Config sources: ${e.join(", ")}`}};function nt(r,e=500,t="internal_error",n="api_error"){let o=new Error(r);return o.statusCode=e,o.code=t,o.type=n,o}async function Hf(r,e,t){e.log.error(r);let n=r.statusCode||500,o={error:{message:r.message+r.stack||"Internal Server Error",type:r.type||"api_error",code:r.code||"internal_error"}};return t.code(n).send(o)}import{ProxyAgent as c0}from"undici";function Gf(r,e,t,n,o){let i=new Headers({"Content-Type":"application/json"});t.headers&&Object.entries(t.headers).forEach(([h,d])=>{d&&i.set(h,d)});let u,f=AbortSignal.timeout(t.TIMEOUT??60*1e3*60);if(t.signal){let h=new AbortController,d=()=>h.abort();t.signal.addEventListener("abort",d),f.addEventListener("abort",d),u=h.signal}else u=f;let c={method:"POST",headers:i,body:JSON.stringify(e),signal:u};return t.httpsProxy&&(c.dispatcher=new c0(new URL(t.httpsProxy).toString())),n?.debug({reqId:o.req.id,request:c,headers:Object.fromEntries(i.entries()),requestUrl:typeof r=="string"?r:r.toString(),useProxy:t.httpsProxy},"final request"),fetch(typeof r=="string"?r:r.toString(),c)}var Wf="1.0.51";async function f0(r,e,t,n){let o=r.body,i=r.provider,u=t._server.providerService.getProvider(i);if(!u)throw nt(`Provider '${i}' not found`,404,"provider_not_found");let{requestBody:f,config:c,bypass:h}=await d0(o,u,n,r.headers,{req:r}),d=await p0(f,c,u,t,h,n,{req:r}),p=await m0(f,d,u,n,h,{req:r});return g0(p,e,o)}async function d0(r,e,t,n,o){let i=r,u={},f=!1;if(f=h0(e,t,r),f&&(n instanceof Headers?n.delete("content-length"):delete n["content-length"],u.headers=n),!f&&typeof t.transformRequestOut=="function"){let c=await t.transformRequestOut(i);c.body?(i=c.body,u=c.config||{}):i=c}if(!f&&e.transformer?.use?.length)for(let c of e.transformer.use){if(!c||typeof c.transformRequestIn!="function")continue;let h=await c.transformRequestIn(i,e,o);h.body?(i=h.body,u={...u,...h.config}):i=h}if(!f&&e.transformer?.[r.model]?.use?.length)for(let c of e.transformer[r.model].use)!c||typeof c.transformRequestIn!="function"||(i=await c.transformRequestIn(i,e,o));return{requestBody:i,config:u,bypass:f}}function h0(r,e,t){if(r.nativeFormat)return true;return r.transformer?.use?.length===1&&r.transformer.use[0].name===e.name&&(!r.transformer?.[t.model]?.use.length||r.transformer?.[t.model]?.use.length===1&&r.transformer?.[t.model]?.use[0].name===e.name)}async function p0(r,e,t,n,o,i,u){let f=e.url||new URL(t.baseUrl);if(o&&typeof i.auth=="function"){let d=await i.auth(r,t);if(d.body){r=d.body;let p=e.headers||{};d.config?.headers&&(p={...p,...d.config.headers},delete p.host,delete d.config.headers),e={...e,...d.config,headers:p}}else r=d}let c={Authorization:`Bearer ${t.apiKey}`,...e?.headers||{}};for(let d in c)(c[d]==="undefined"||["authorization","Authorization"].includes(d)&&c[d]?.includes("undefined"))&&delete c[d];let h=await Gf(f,r,{httpsProxy:n._server.configService.getHttpsProxy(),...e,headers:JSON.parse(JSON.stringify(c))},n.log,u);if(!h.ok){let d=await h.text();throw n.log.error(`[provider_response_error] Error from provider(${t.name},${r.model}: ${h.status}): ${d}`),nt(`Error from provider(${t.name},${r.model}: ${h.status}): ${d}`,h.status,"provider_response_error")}return h}async function m0(r,e,t,n,o,i){let u=e;if(!o&&t.transformer?.use?.length)for(let f of Array.from(t.transformer.use).reverse())!f||typeof f.transformResponseOut!="function"||(u=await f.transformResponseOut(u,i));if(!o&&t.transformer?.[r.model]?.use?.length)for(let f of Array.from(t.transformer[r.model].use).reverse())!f||typeof f.transformResponseOut!="function"||(u=await f.transformResponseOut(u,i));return!o&&n.transformResponseIn&&(u=await n.transformResponseIn(u,i)),u}function g0(r,e,t){return r.ok||e.code(r.status),t.stream===!0?(e.header("Content-Type","text/event-stream"),e.header("Cache-Control","no-cache"),e.header("Connection","keep-alive"),e.send(r.body)):r.json()}var Jf=async r=>{r.get("/",async()=>({message:"LLMs API",version:Wf})),r.get("/health",async()=>({status:"ok",timestamp:new Date().toISOString()}));let e=r._server.transformerService.getTransformersWithEndpoint();for(let{transformer:t}of e)t.endPoint&&r.post(t.endPoint,async(n,o)=>f0(n,o,r,t));r.post("/providers",{schema:{body:{type:"object",properties:{id:{type:"string"},name:{type:"string"},type:{type:"string",enum:["openai","anthropic"]},baseUrl:{type:"string"},apiKey:{type:"string"},models:{type:"array",items:{type:"string"}}},required:["id","name","type","baseUrl","apiKey","models"]}}},async(t,n)=>{let{name:o,baseUrl:i,apiKey:u,models:f}=t.body;if(!o?.trim())throw nt("Provider name is required",400,"invalid_request");if(!i||!y0(i))throw nt("Valid base URL is required",400,"invalid_request");if(!u?.trim())throw nt("API key is required",400,"invalid_request");if(!f||!Array.isArray(f)||f.length===0)throw nt("At least one model is required",400,"invalid_request");if(r._server.providerService.getProvider(t.body.name))throw nt(`Provider with name '${t.body.name}' already exists`,400,"provider_exists");return r._server.providerService.registerProvider(t.body)}),r.get("/providers",async()=>r._server.providerService.getProviders()),r.get("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]}}},async t=>{let n=r._server.providerService.getProvider(t.params.id);if(!n)throw nt("Provider not found",404,"provider_not_found");return n}),r.put("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]},body:{type:"object",properties:{name:{type:"string"},type:{type:"string",enum:["openai","anthropic"]},baseUrl:{type:"string"},apiKey:{type:"string"},models:{type:"array",items:{type:"string"}},enabled:{type:"boolean"}}}}},async(t,n)=>{let o=r._server.providerService.updateProvider(t.params.id,t.body);if(!o)throw nt("Provider not found",404,"provider_not_found");return o}),r.delete("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]}}},async t=>{if(!r._server.providerService.deleteProvider(t.params.id))throw nt("Provider not found",404,"provider_not_found");return{message:"Provider deleted successfully"}}),r.patch("/providers/:id/toggle",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]},body:{type:"object",properties:{enabled:{type:"boolean"}},required:["enabled"]}}},async(t,n)=>{if(!r._server.providerService.toggleProvider(t.params.id,t.body.enabled))throw nt("Provider not found",404,"provider_not_found");return{message:`Provider ${t.body.enabled?"enabled":"disabled"} successfully`}})};function y0(r){try{return new URL(r),!0}catch{return!1}}var go=class{constructor(e){this.providerService=e}registerProvider(e){return this.providerService.registerProvider(e)}getProviders(){return this.providerService.getProviders()}getProvider(e){return this.providerService.getProvider(e)}updateProvider(e,t){return this.providerService.updateProvider(e,t)}deleteProvider(e){return this.providerService.deleteProvider(e)}toggleProvider(e,t){return this.providerService.toggleProvider(e,t)}resolveRoute(e){let t=this.providerService.resolveModelRoute(e);if(!t)throw new Error(`Model ${e} not found. Available models: ${this.getAvailableModelNames().join(", ")}`);return t}async getAvailableModels(){return{object:"list",data:this.providerService.getAvailableModels().flatMap(t=>t.models.map(n=>({id:n,object:"model",provider:t.provider,created:Math.floor(Date.now()/1e3),owned_by:t.provider})))}}getAvailableModelNames(){return this.providerService.getModelRoutes().map(e=>e.fullModel)}getModelRoutes(){return this.providerService.getModelRoutes()}};var yo=class{constructor(e,t,n){this.configService=e;this.transformerService=t;this.logger=n;this.initializeCustomProviders()}providers=new Map;modelRoutes=new Map;initializeCustomProviders(){let e=this.configService.get("providers");if(e&&Array.isArray(e)){this.initializeFromProvidersArray(e);return}}initializeFromProvidersArray(e){e.forEach(t=>{try{if(!t.name||!t.api_base_url||!t.api_key)return;let n={};t.transformer&&Object.keys(t.transformer).forEach(o=>{o==="use"?Array.isArray(t.transformer.use)&&(n.use=t.transformer.use.map(i=>{if(Array.isArray(i)&&typeof i[0]=="string"){let u=this.transformerService.getTransformer(i[0]);if(u)return new u(i[1])}if(typeof i=="string"){let u=this.transformerService.getTransformer(i);return typeof u=="function"?new u:u}}).filter(i=>typeof i<"u")):Array.isArray(t.transformer[o]?.use)&&(n[o]={use:t.transformer[o].use.map(i=>{if(Array.isArray(i)&&typeof i[0]=="string"){let u=this.transformerService.getTransformer(i[0]);if(u)return new u(i[1])}if(typeof i=="string"){let u=this.transformerService.getTransformer(i);return typeof u=="function"?new u:u}}).filter(i=>typeof i<"u")})}),this.registerProvider({name:t.name,baseUrl:t.api_base_url,apiKey:t.api_key,models:t.models||[],transformer:t.transformer?n:void 0,nativeFormat:t.nativeFormat}),this.logger.info(`${t.name} provider registered`)}catch(n){this.logger.error(`${t.name} provider registered error: ${n}`)}})}registerProvider(e){let t={...e};return this.providers.set(t.name,t),e.models.forEach(n=>{let o=`${t.name},${n}`,i={provider:t.name,model:n,fullModel:o};this.modelRoutes.set(o,i),this.modelRoutes.has(n)||this.modelRoutes.set(n,i)}),t}getProviders(){return Array.from(this.providers.values())}getProvider(e){return this.providers.get(e)}updateProvider(e,t){let n=this.providers.get(e);if(!n)return null;let o={...n,...t,updatedAt:new Date};return this.providers.set(e,o),t.models&&(n.models.forEach(i=>{let u=`${n.id},${i}`;this.modelRoutes.delete(u),this.modelRoutes.delete(i)}),t.models.forEach(i=>{let u=`${n.name},${i}`,f={provider:n.name,model:i,fullModel:u};this.modelRoutes.set(u,f),this.modelRoutes.has(i)||this.modelRoutes.set(i,f)})),o}deleteProvider(e){let t=this.providers.get(e);return t?(t.models.forEach(n=>{let o=`${t.name},${n}`;this.modelRoutes.delete(o),this.modelRoutes.delete(n)}),this.providers.delete(e),!0):!1}toggleProvider(e,t){return!!this.providers.get(e)}resolveModelRoute(e){let t=this.modelRoutes.get(e);if(!t)return null;let n=this.providers.get(t.provider);return n?{provider:n,originalModel:e,targetModel:t.model}:null}getAvailableModelNames(){let e=[];return this.providers.forEach(t=>{t.models.forEach(n=>{e.push(n),e.push(`${t.name},${n}`)})}),e}getModelRoutes(){return Array.from(this.modelRoutes.values())}parseTransformerConfig(e){return e?Array.isArray(e)?e.reduce((t,n)=>{if(Array.isArray(n)){let[o,i={}]=n;t[o]=i}else t[n]={};return t},{}):e:{}}async getAvailableModels(){let e=[];return this.providers.forEach(t=>{t.models.forEach(n=>{e.push({id:n,object:"model",owned_by:t.name,provider:t.name}),e.push({id:`${t.name},${n}`,object:"model",owned_by:t.name,provider:t.name})})}),{object:"list",data:e}}};var Je=[];for(let r=0;r<256;++r)Je.push((r+256).toString(16).slice(1));function zf(r,e=0){return(Je[r[e+0]]+Je[r[e+1]]+Je[r[e+2]]+Je[r[e+3]]+"-"+Je[r[e+4]]+Je[r[e+5]]+"-"+Je[r[e+6]]+Je[r[e+7]]+"-"+Je[r[e+8]]+Je[r[e+9]]+"-"+Je[r[e+10]]+Je[r[e+11]]+Je[r[e+12]]+Je[r[e+13]]+Je[r[e+14]]+Je[r[e+15]]).toLowerCase()}import{randomFillSync as _0}from"crypto";var Co=new Uint8Array(256),_o=Co.length;function za(){return _o>Co.length-16&&(_0(Co),_o=0),Co.slice(_o,_o+=16)}import{randomUUID as C0}from"crypto";var Va={randomUUID:C0};function b0(r,e,t){if(Va.randomUUID&&!e&&!r)return Va.randomUUID();r=r||{};let n=r.random??r.rng?.()??za();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let o=0;o<16;++o)e[t+o]=n[o];return e}return zf(n)}var Wt=b0;var Vf=r=>r<=0?"none":r<=1024?"low":r<=8192?"medium":"high";var Kf=(r,e)=>(r.includes("base64")&&(r=r.split("base64").pop(),r.startsWith(",")&&(r=r.slice(1))),`data:${e};base64,${r}`);var bo=class{constructor(e){this.options=e;this.useBearer=this.options?.UseBearer??!1}name="Anthropic";endPoint="/v1/messages";useBearer;logger;async auth(e,t){let n={};return this.useBearer?(n.authorization=`Bearer ${t.apiKey}`,n["x-api-key"]=void 0):(n["x-api-key"]=t.apiKey,n.authorization=void 0),{body:e,config:{headers:n}}}async transformRequestOut(e){let t=[];if(e.system){if(typeof e.system=="string")t.push({role:"system",content:e.system});else if(Array.isArray(e.system)&&e.system.length){let i=e.system.filter(u=>u.type==="text"&&u.text).map(u=>({type:"text",text:u.text,cache_control:u.cache_control}));t.push({role:"system",content:i})}}JSON.parse(JSON.stringify(e.messages||[]))?.forEach(i=>{if(i.role==="user"||i.role==="assistant"){if(typeof i.content=="string"){t.push({role:i.role,content:i.content});return}if(Array.isArray(i.content)){if(i.role==="user"){let u=i.content.filter(c=>c.type==="tool_result"&&c.tool_use_id);u.length&&u.forEach(c=>{let h={role:"tool",content:typeof c.content=="string"?c.content:JSON.stringify(c.content),tool_call_id:c.tool_use_id,cache_control:c.cache_control};t.push(h)});let f=i.content.filter(c=>c.type==="text"&&c.text||c.type==="image"&&c.source);f.length&&t.push({role:"user",content:f.map(c=>c?.type==="image"?{type:"image_url",image_url:{url:c.source?.type==="base64"?Kf(c.source.data,c.source.media_type):c.source.url},media_type:c.source.media_type}:c)})}else if(i.role==="assistant"){let u={role:"assistant",content:""},f=i.content.filter(d=>d.type==="text"&&d.text);f.length&&(u.content=f.map(d=>d.text).join(`
 `));let c=i.content.filter(d=>d.type==="tool_use"&&d.id);c.length&&(u.tool_calls=c.map(d=>({id:d.id,type:"function",function:{name:d.name,arguments:JSON.stringify(d.input||{})}})));let h=i.content.find(d=>d.type==="thinking"&&d.signature);h&&(u.thinking={content:h.thinking,signature:h.signature}),t.push(u)}return}}});let o={messages:t,model:e.model,max_tokens:e.max_tokens,temperature:e.temperature,stream:e.stream,tools:e.tools?.length?this.convertAnthropicToolsToUnified(e.tools):void 0,tool_choice:e.tool_choice};return e.thinking&&(o.reasoning={effort:Vf(e.thinking.budget_tokens),enabled:e.thinking.type==="enabled"}),e.tool_choice&&(e.tool_choice.type==="tool"?o.tool_choice={type:"function",function:{name:e.tool_choice.name}}:o.tool_choice=e.tool_choice.type),o}async transformResponseIn(e,t){if(e.headers.get("Content-Type")?.includes("text/event-stream")){if(!e.body)throw new Error("Stream response body is null");let o=await this.convertOpenAIStreamToAnthropic(e.body,t);return new Response(o,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}else{let o=await e.json(),i=this.convertOpenAIResponseToAnthropic(o,t);return new Response(JSON.stringify(i),{headers:{"Content-Type":"application/json"}})}}convertAnthropicToolsToUnified(e){return e.map(t=>({type:"function",function:{name:t.name,description:t.description||"",parameters:t.input_schema}}))}async convertOpenAIStreamToAnthropic(e,t){return new ReadableStream({start:async o=>{let i=new TextEncoder,u=`msg_${Date.now()}`,f=null,c="unknown",h=!1,d=!1,p=!1,A=new Map,P=new Map,S=0,b=0,_=0,m=!1,T=!1,C=0,w=-1,k=()=>{let U=C;return C++,U},x=U=>{if(!m)try{o.enqueue(U);let ee=new TextDecoder().decode(U);this.logger.debug({reqId:t.req.id,data:ee,type:"send data"})}catch(ee){if(ee instanceof TypeError&&ee.message.includes("Controller is already closed"))m=!0;else throw this.logger.debug({reqId:t.req.id,error:ee.message,type:"send data error"}),ee}},G=()=>{if(!m)try{if(w>=0){let ee={type:"content_block_stop",index:w};x(i.encode(`event: content_block_stop
 data: ${JSON.stringify(ee)}
 
@@ -129,7 +129,7 @@ data: ${JSON.stringify(_e)}
 `))}catch(ce){console.error(ce)}}}}}if(pe?.finish_reason&&!m&&!p){if(b===0&&_===0&&console.error("Warning: No content in the stream response!"),w>=0){let J={type:"content_block_stop",index:w};x(i.encode(`event: content_block_stop
 data: ${JSON.stringify(J)}
 
-`)),w=-1}m||(f={type:"message_delta",delta:{stop_reason:{stop:"end_turn",length:"max_tokens",tool_calls:"tool_use",content_filter:"stop_sequence"}[pe.finish_reason]||"end_turn",stop_sequence:null},usage:{input_tokens:(se.usage?.prompt_tokens||0)-(se.usage?.prompt_tokens_details?.cached_tokens||0),output_tokens:se.usage?.completion_tokens||0,cache_read_input_tokens:se.usage?.prompt_tokens_details?.cached_tokens||0}});break}}catch(se){this.logger?.error(`parseError: ${se.name} message: ${se.message} stack: ${se.stack} data: ${Ae}`)}}}G()}catch(U){if(!m)try{o.error(U)}catch(ee){console.error(ee)}}finally{if(Y)try{Y.releaseLock()}catch(U){console.error(U)}}},cancel:o=>{this.logger.debug({reqId:t.req.id},`cancle stream: ${o}`)}})}convertOpenAIResponseToAnthropic(e,t){this.logger.debug({reqId:t.req.id,response:e},"Original OpenAI response");try{let n=e.choices[0];if(!n)throw new Error("No choices found in OpenAI response");let o=[];if(n.message.annotations){let u=`srvtoolu_${Wt()}`;o.push({type:"server_tool_use",id:u,name:"web_search",input:{query:""}}),o.push({type:"web_search_tool_result",tool_use_id:u,content:n.message.annotations.map(f=>({type:"web_search_result",url:f.url_citation.url,title:f.url_citation.title}))})}n.message.content&&o.push({type:"text",text:n.message.content}),n.message.tool_calls&&n.message.tool_calls.length>0&&n.message.tool_calls.forEach(u=>{let f={};try{let c=u.function.arguments||"{}";typeof c=="object"?f=c:typeof c=="string"&&(f=JSON.parse(c))}catch{f={text:u.function.arguments||""}}o.push({type:"tool_use",id:u.id,name:u.function.name,input:f})}),n.message?.thinking?.content&&o.push({type:"thinking",thinking:n.message.thinking.content,signature:n.message.thinking.signature});let i={id:e.id,type:"message",role:"assistant",model:e.model,content:o,stop_reason:n.finish_reason==="stop"?"end_turn":n.finish_reason==="length"?"max_tokens":n.finish_reason==="tool_calls"?"tool_use":n.finish_reason==="content_filter"?"stop_sequence":"end_turn",stop_sequence:null,usage:{input_tokens:(e.usage?.prompt_tokens||0)-(e.usage?.prompt_tokens_details?.cached_tokens||0),output_tokens:e.usage?.completion_tokens||0,cache_read_input_tokens:e.usage?.prompt_tokens_details?.cached_tokens||0}};return this.logger.debug({reqId:t.req.id,result:i},"Conversion complete, final Anthropic response"),i}catch{throw nt(`Provider error: ${JSON.stringify(e)}`,500,"provider_error")}}};var Cn={TYPE_UNSPECIFIED:"TYPE_UNSPECIFIED",STRING:"STRING",NUMBER:"NUMBER",INTEGER:"INTEGER",BOOLEAN:"BOOLEAN",ARRAY:"ARRAY",OBJECT:"OBJECT",NULL:"NULL"};function E0(r,e){r.includes("null")&&(e.nullable=!0);let t=r.filter(n=>n!=="null");if(t.length===1){let n=t[0].toUpperCase();e.type=Object.values(Cn).includes(n)?n:Cn.TYPE_UNSPECIFIED}else{e.anyOf=[];for(let n of t){let o=n.toUpperCase();e.anyOf.push({type:Object.values(Cn).includes(o)?o:Cn.TYPE_UNSPECIFIED})}}}function is(r){let e={},t=["items"],n=["anyOf"],o=["properties"];if(r.type&&r.anyOf)throw new Error("type and anyOf cannot be both populated.");let i=r.anyOf;i!=null&&Array.isArray(i)&&i.length==2&&(i[0]&&i[0].type==="null"?(e.nullable=!0,r=i[1]):i[1]&&i[1].type==="null"&&(e.nullable=!0,r=i[0])),r.type&&Array.isArray(r.type)&&E0(r.type,e);for(let[u,f]of Object.entries(r))if(f!=null)if(u=="type"){if(f==="null")throw new Error("type: null can not be the only possible type for the field.");if(Array.isArray(f))continue;let c=f.toUpperCase();e.type=Object.values(Cn).includes(c)?c:Cn.TYPE_UNSPECIFIED}else if(t.includes(u))e[u]=is(f);else if(n.includes(u)){let c=[];for(let h of f){if(h.type=="null"){e.nullable=!0;continue}c.push(is(h))}e[u]=c}else if(o.includes(u)){let c={};for(let[h,d]of Object.entries(f))c[h]=is(d);e[u]=c}else{if(u==="additionalProperties")continue;e[u]=f}return e}function w0(r){if(r.functionDeclarations)for(let e of r.functionDeclarations)e.parameters&&(Object.keys(e.parameters).includes("$schema")?e.parametersJsonSchema||(e.parametersJsonSchema=e.parameters,delete e.parameters):e.parameters=is(e.parameters)),e.response&&(Object.keys(e.response).includes("$schema")?e.responseJsonSchema||(e.responseJsonSchema=e.response,delete e.response):e.response=is(e.response));return r}function Eo(r){let e=[],t=r.tools?.filter(c=>c.function.name!=="web_search")?.map(c=>({name:c.function.name,description:c.function.description,parametersJsonSchema:c.function.parameters}));t?.length&&e.push(w0({functionDeclarations:t})),r.tools?.find(c=>c.function.name==="web_search")&&e.push({googleSearch:{}});let o=[],i=r.messages.filter(c=>c.role==="tool");r.messages.filter(c=>c.role!=="tool").forEach(c=>{let h;c.role==="assistant"?h="model":(["user","system"].includes(c.role),h="user");let d=[];if(typeof c.content=="string"){let p={text:c.content};c?.thinking?.signature&&(p.thoughtSignature=c.thinking.signature),d.push(p)}else Array.isArray(c.content)?d.push(...c.content.map(p=>{if(p.type==="text")return{text:p.text||""};if(p.type==="image_url")return p.image_url.url.startsWith("http")?{file_data:{mime_type:p.media_type,file_uri:p.image_url.url}}:{inlineData:{mime_type:p.media_type,data:p.image_url.url?.split(",")?.pop()||p.image_url.url}}})):c.content&&typeof c.content=="object"&&(c.content.text?d.push({text:c.content.text}):d.push({text:JSON.stringify(c.content)}));if(Array.isArray(c.tool_calls)&&d.push(...c.tool_calls.map((p,A)=>({functionCall:{id:p.id||`tool_${Math.random().toString(36).substring(2,15)}`,name:p.function.name,args:JSON.parse(p.function.arguments||"{}")},thoughtSignature:A===0&&c.thinking?.signature?c.thinking?.signature:void 0}))),d.length===0&&d.push({text:""}),o.push({role:h,parts:d}),h==="model"&&c.tool_calls){let p=c.tool_calls.map(A=>{let P=i.find(S=>S.tool_call_id===A.id);return{functionResponse:{name:A?.function?.name,response:{result:P?.content}}}});o.push({role:"user",parts:p})}});let u={};if(r.reasoning&&r.reasoning.effort&&r.reasoning.effort!=="none")if(u.thinkingConfig={includeThoughts:!0},r.model.includes("gemini-3"))u.thinkingConfig.thinkingLevel=r.reasoning.effort;else{let c=r.model.includes("pro")?[128,32768]:[0,24576],h,d=r.reasoning.max_tokens;typeof d<"u"&&(d>=c[0]&&d<=c[1]?h=d:d<c[0]?h=c[0]:d>c[1]&&(h=c[1]),u.thinkingConfig.thinkingBudget=h)}let f={contents:o,tools:e.length?e:void 0,generationConfig:u};if(r.tool_choice){let c={functionCallingConfig:{}};r.tool_choice==="auto"?c.functionCallingConfig.mode="auto":r.tool_choice==="none"?c.functionCallingConfig.mode="none":r.tool_choice==="required"?c.functionCallingConfig.mode="any":r.tool_choice?.function?.name&&(c.functionCallingConfig.mode="any",c.functionCallingConfig.allowedFunctionNames=[r.tool_choice?.function?.name]),f.toolConfig=c}return f}function wo(r){let e=r.contents,t=r.tools,n=r.model,o=r.max_tokens,i=r.temperature,u=r.stream,f=r.tool_choice,c={messages:[],model:n,max_tokens:o,temperature:i,stream:u,tool_choice:f};return Array.isArray(e)&&e.forEach(h=>{typeof h=="string"?c.messages.push({role:"user",content:h}):typeof h.text=="string"?c.messages.push({role:"user",content:h.text||null}):h.role==="user"?c.messages.push({role:"user",content:h?.parts?.map(d=>({type:"text",text:d.text||""}))||[]}):h.role==="model"&&c.messages.push({role:"assistant",content:h?.parts?.map(d=>({type:"text",text:d.text||""}))||[]})}),Array.isArray(t)&&(c.tools=[],t.forEach(h=>{Array.isArray(h.functionDeclarations)&&h.functionDeclarations.forEach(d=>{c.tools.push({type:"function",function:{name:d.name,description:d.description,parameters:d.parameters}})})})),c}async function Ao(r,e,t){if(r.headers.get("Content-Type")?.includes("application/json")){let n=await r.json();t?.debug({response:n},`${e} response:`);let o="",i="",u=n.candidates[0]?.content?.parts||[],f=[];for(let p of u)p.text&&p.thought===!0?o+=p.text:f.push(p);i=u.find(p=>p.thoughtSignature)?.thoughtSignature;let c=f?.filter(p=>p.functionCall)?.map(p=>({id:p.functionCall?.id||`tool_${Math.random().toString(36).substring(2,15)}`,type:"function",function:{name:p.functionCall?.name,arguments:JSON.stringify(p.functionCall?.args||{})}}))||[],h=f?.filter(p=>p.text)?.map(p=>p.text)?.join(`
+`)),w=-1}m||(f={type:"message_delta",delta:{stop_reason:{stop:"end_turn",length:"max_tokens",tool_calls:"tool_use",content_filter:"stop_sequence"}[pe.finish_reason]||"end_turn",stop_sequence:null},usage:{input_tokens:(se.usage?.prompt_tokens||0)-(se.usage?.prompt_tokens_details?.cached_tokens||0),output_tokens:se.usage?.completion_tokens||0,cache_read_input_tokens:se.usage?.prompt_tokens_details?.cached_tokens||0}});break}}catch(se){this.logger?.error(`parseError: ${se.name} message: ${se.message} stack: ${se.stack} data: ${Ae}`)}}}G()}catch(U){if(!m)try{o.error(U)}catch(ee){console.error(ee)}}finally{if(Y)try{Y.releaseLock()}catch(U){console.error(U)}}},cancel:o=>{this.logger.debug({reqId:t.req.id},`cancle stream: ${o}`)}})}convertOpenAIResponseToAnthropic(e,t){this.logger.debug({reqId:t.req.id,response:e},"Original OpenAI response");try{let n=e.choices[0];if(!n)throw new Error("No choices found in OpenAI response");let o=[];if(n.message.annotations){let u=`srvtoolu_${Wt()}`;o.push({type:"server_tool_use",id:u,name:"web_search",input:{query:""}}),o.push({type:"web_search_tool_result",tool_use_id:u,content:n.message.annotations.map(f=>({type:"web_search_result",url:f.url_citation.url,title:f.url_citation.title}))})}n.message.content&&o.push({type:"text",text:n.message.content}),n.message.tool_calls&&n.message.tool_calls.length>0&&n.message.tool_calls.forEach(u=>{let f={};try{let c=u.function.arguments||"{}";typeof c=="object"?f=c:typeof c=="string"&&(f=JSON.parse(c))}catch{f={text:u.function.arguments||""}}o.push({type:"tool_use",id:u.id,name:u.function.name,input:f})}),n.message?.thinking?.content&&o.push({type:"thinking",thinking:n.message.thinking.content,signature:n.message.thinking.signature});let i={id:e.id,type:"message",role:"assistant",model:e.model,content:o,stop_reason:n.finish_reason==="stop"?"end_turn":n.finish_reason==="length"?"max_tokens":n.finish_reason==="tool_calls"?"tool_use":n.finish_reason==="content_filter"?"stop_sequence":"end_turn",stop_sequence:null,usage:{input_tokens:(e.usage?.prompt_tokens||0)-(e.usage?.prompt_tokens_details?.cached_tokens||0),output_tokens:e.usage?.completion_tokens||0,cache_read_input_tokens:e.usage?.prompt_tokens_details?.cached_tokens||0}};return this.logger.debug({reqId:t.req.id,result:i},"Conversion complete, final Anthropic response"),i}catch{throw nt(`Provider error: ${JSON.stringify(e)}`,500,"provider_error")}}};var Cn={TYPE_UNSPECIFIED:"TYPE_UNSPECIFIED",STRING:"STRING",NUMBER:"NUMBER",INTEGER:"INTEGER",BOOLEAN:"BOOLEAN",ARRAY:"ARRAY",OBJECT:"OBJECT",NULL:"NULL"};function E0(r,e){r.includes("null")&&(e.nullable=!0);let t=r.filter(n=>n!=="null");if(t.length===1){let n=t[0].toUpperCase();e.type=Object.values(Cn).includes(n)?n:Cn.TYPE_UNSPECIFIED}else{e.anyOf=[];for(let n of t){let o=n.toUpperCase();e.anyOf.push({type:Object.values(Cn).includes(o)?o:Cn.TYPE_UNSPECIFIED})}}}function is(r){let e={},t=["items"],n=["anyOf"],o=["properties"];if(r.type&&r.anyOf)throw new Error("type and anyOf cannot be both populated.");let i=r.anyOf;i!=null&&Array.isArray(i)&&i.length==2&&(i[0]&&i[0].type==="null"?(e.nullable=!0,r=i[1]):i[1]&&i[1].type==="null"&&(e.nullable=!0,r=i[0])),r.type&&Array.isArray(r.type)&&E0(r.type,e);for(let[u,f]of Object.entries(r))if(f!=null)if(u=="type"){if(f==="null")throw new Error("type: null can not be the only possible type for the field.");if(Array.isArray(f))continue;let c=f.toUpperCase();e.type=Object.values(Cn).includes(c)?c:Cn.TYPE_UNSPECIFIED}else if(t.includes(u))e[u]=is(f);else if(n.includes(u)){let c=[];for(let h of f){if(h.type=="null"){e.nullable=!0;continue}c.push(is(h))}e[u]=c}else if(o.includes(u)){let c={};for(let[h,d]of Object.entries(f))c[h]=is(d);e[u]=c}else{if(u==="additionalProperties")continue;e[u]=f}return e}function w0(r){if(r.functionDeclarations)for(let e of r.functionDeclarations)e.parameters&&(Object.keys(e.parameters).includes("$schema")?e.parametersJsonSchema||(e.parametersJsonSchema=e.parameters,delete e.parameters):e.parameters=is(e.parameters)),e.response&&(Object.keys(e.response).includes("$schema")?e.responseJsonSchema||(e.responseJsonSchema=e.response,delete e.response):e.response=is(e.response));return r}function Eo(r){let e=[],t=r.tools?.filter(c=>c.function.name!=="web_search")?.map(c=>({name:c.function.name,description:c.function.description,parametersJsonSchema:c.function.parameters}));t?.length&&e.push(w0({functionDeclarations:t})),r.tools?.find(c=>c.function.name==="web_search")&&e.push({googleSearch:{}});let o=[],i=r.messages.filter(c=>c.role==="tool");r.messages.filter(c=>c.role!=="tool").forEach(c=>{let h;c.role==="assistant"?h="model":(["user","system"].includes(c.role),h="user");let d=[];if(typeof c.content=="string"){let p={text:c.content};c?.thinking?.signature&&(p.thoughtSignature=c.thinking.signature),d.push(p)}else Array.isArray(c.content)?d.push(...c.content.map(p=>{if(p.type==="text")return{text:p.text||""};if(p.type==="image_url")return p.image_url.url.startsWith("http")?{file_data:{mime_type:p.media_type,file_uri:p.image_url.url}}:{inlineData:{mime_type:p.media_type,data:p.image_url.url?.split(",")?.pop()||p.image_url.url}}})):c.content&&typeof c.content=="object"&&(c.content.text?d.push({text:c.content.text}):d.push({text:JSON.stringify(c.content)}));if(Array.isArray(c.tool_calls)&&d.push(...c.tool_calls.map((p,A)=>({functionCall:{id:p.id||`tool_${Math.random().toString(36).substring(2,15)}`,name:p.function.name,args:JSON.parse(p.function.arguments||"{}")},thoughtSignature:A===0&&c.thinking?.signature?c.thinking?.signature:void 0}))),d.length===0&&d.push({text:""}),o.push({role:h,parts:d}),h==="model"&&c.tool_calls){let p=c.tool_calls.map(A=>{let P=i.find(S=>S.tool_call_id===A.id);return{functionResponse:{name:A?.function?.name||A?.name||"unknown_tool",response:{result:P?.content}}}});o.push({role:"user",parts:p})}});let u={};if(r.reasoning&&r.reasoning.effort&&r.reasoning.effort!=="none")if(u.thinkingConfig={includeThoughts:!0},r.model.includes("gemini-3"))u.thinkingConfig.thinkingLevel=r.reasoning.effort;else{let c=r.model.includes("pro")?[128,32768]:[0,24576],h,d=r.reasoning.max_tokens;typeof d<"u"&&(d>=c[0]&&d<=c[1]?h=d:d<c[0]?h=c[0]:d>c[1]&&(h=c[1]),u.thinkingConfig.thinkingBudget=h)}let f={contents:o,tools:e.length?e:void 0,generationConfig:u};if(r.tool_choice){let c={functionCallingConfig:{}};r.tool_choice==="auto"?c.functionCallingConfig.mode="auto":r.tool_choice==="none"?c.functionCallingConfig.mode="none":r.tool_choice==="required"?c.functionCallingConfig.mode="any":r.tool_choice?.function?.name&&(c.functionCallingConfig.mode="any",c.functionCallingConfig.allowedFunctionNames=[r.tool_choice?.function?.name]),f.toolConfig=c}return f}function wo(r){let e=r.contents,t=r.tools,n=r.model,o=r.max_tokens,i=r.temperature,u=r.stream,f=r.tool_choice,c={messages:[],model:n,max_tokens:o,temperature:i,stream:u,tool_choice:f};return Array.isArray(e)&&e.forEach(h=>{typeof h=="string"?c.messages.push({role:"user",content:h}):typeof h.text=="string"?c.messages.push({role:"user",content:h.text||null}):h.role==="user"?c.messages.push({role:"user",content:h?.parts?.map(d=>({type:"text",text:d.text||""}))||[]}):h.role==="model"&&c.messages.push({role:"assistant",content:h?.parts?.map(d=>({type:"text",text:d.text||""}))||[]})}),Array.isArray(t)&&(c.tools=[],t.forEach(h=>{Array.isArray(h.functionDeclarations)&&h.functionDeclarations.forEach(d=>{c.tools.push({type:"function",function:{name:d.name,description:d.description,parameters:d.parameters}})})})),c}async function Ao(r,e,t){if(r.headers.get("Content-Type")?.includes("application/json")){let n=await r.json();t?.debug({response:n},`${e} response:`);let o="",i="",u=n.candidates[0]?.content?.parts||[],f=[];for(let p of u)p.text&&p.thought===!0?o+=p.text:f.push(p);i=u.find(p=>p.thoughtSignature)?.thoughtSignature;let c=f?.filter(p=>p.functionCall)?.map(p=>({id:p.functionCall?.id||`tool_${Math.random().toString(36).substring(2,15)}`,type:"function",function:{name:p.functionCall?.name,arguments:JSON.stringify(p.functionCall?.args||{})}}))||[],h=f?.filter(p=>p.text)?.map(p=>p.text)?.join(`
 `)||"",d={id:n.responseId,choices:[{finish_reason:n.candidates[0].finishReason?.toLowerCase()||null,index:0,message:{content:h,role:"assistant",tool_calls:c.length>0?c:void 0,...i&&{thinking:{content:o||"(no content)",signature:i}}}}],created:parseInt(new Date().getTime()/1e3+"",10),model:n.modelVersion,object:"chat.completion",usage:{completion_tokens:n.usageMetadata?.candidatesTokenCount||0,prompt_tokens:n.usageMetadata?.promptTokenCount||0,prompt_tokens_details:{cached_tokens:n.usageMetadata?.cachedContentTokenCount||0},total_tokens:n.usageMetadata?.totalTokenCount||0,output_tokens_details:{reasoning_tokens:n.usageMetadata?.thoughtsTokenCount||0}}};return new Response(JSON.stringify(d),{status:r.status,statusText:r.statusText,headers:r.headers})}else if(r.headers.get("Content-Type")?.includes("stream")){if(!r.body)return r;let n=new TextDecoder,o=new TextEncoder,i=!1,u=!1,f=!1,c="",h=0,d=-1,p=new ReadableStream({async start(A){let P=async(_,m)=>{if(_.startsWith("data: ")){let T=_.slice(6).trim();if(T){t?.debug({chunkStr:T},`${e} chunk:`);try{let C=JSON.parse(T);if(!C.candidates||!C.candidates[0]){t?.debug({chunkStr:T},"Invalid chunk structure");return}let w=C.candidates[0],k=w.content?.parts||[];k.filter(U=>U.text&&U.thought===!0).forEach(U=>{f||(f=!0);let ee={choices:[{delta:{role:"assistant",content:null,thinking:{content:U.text}},finish_reason:null,index:h,logprobs:null}],created:parseInt(new Date().getTime()/1e3+"",10),id:C.responseId||"",model:C.modelVersion||"",object:"chat.completion.chunk",system_fingerprint:"fp_a49d71b8a1"};m.enqueue(o.encode(`data: ${JSON.stringify(ee)}
 
 `))});let x=k.find(U=>U.thoughtSignature)?.thoughtSignature;if(x&&!i){if(!f){let ee={choices:[{delta:{role:"assistant",content:null,thinking:{content:"(no content)"}},finish_reason:null,index:h,logprobs:null}],created:parseInt(new Date().getTime()/1e3+"",10),id:C.responseId||"",model:C.modelVersion||"",object:"chat.completion.chunk",system_fingerprint:"fp_a49d71b8a1"};m.enqueue(o.encode(`data: ${JSON.stringify(ee)}
